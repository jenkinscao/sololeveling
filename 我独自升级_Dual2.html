<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SYSTEM: SOLO LEVELING [COMMANDER]</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            /* --- ä¿®æ”¹ï¼šé»˜è®¤æ”¹ä¸º Learning æ¨¡å¼çš„è“è‰² --- */
            --primary-color: #00f3ff;
            --secondary-color: #0066ff;
            --alert-color: #ff2a6d;

            /* é€šç”¨å˜é‡ä¿æŒä¸å˜ */
            --bg-dark: #050510;
            --glass-bg: rgba(2, 12, 27, 0.85);
            --tech-font: 'Orbitron', sans-serif;
            --code-font: 'Share Tech Mono', monospace;
        }

        /* --- ä¿®æ”¹ï¼šç°åœ¨ Dating æ¨¡å¼å˜æˆäº†â€œç‰¹æ®Šæ¨¡å¼â€ï¼Œéœ€è¦è¦†ç›–é¢œè‰² --- */
        body[data-mode="dating"] {
            --primary-color: #ff5c8d !important;
            --secondary-color: #bc13fe !important;
            --alert-color: #ffbd00 !important;
        }

        /* è®©é¢œè‰²åˆ‡æ¢æœ‰è¿‡æ¸¡åŠ¨ç”» */
        body,
        .btn-tech,
        .tech-panel,
        h1.main-title,
        span {
            transition: all 0.5s ease;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--primary-color);
            font-family: var(--code-font);
            margin: 0;
            overflow-x: hidden;
            font-size: 16px;
        }

        /* --- åŠ¨æ€èƒŒæ™¯å±‚ --- */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0) 50%, rgba(0, 0, 0, 0.05) 50%);
            background-size: 100% 4px;
            pointer-events: none;
        }

        /* --- UI å®¹å™¨å¸ƒå±€ --- */
        #ui-layer {
            position: relative;
            z-index: 10;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            max-width: 1800px;
            /* å¤§å±é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢å¤ªæ•£ */
            margin: 0 auto;
        }

        /* --- ç§‘æŠ€æ„Ÿé¢æ¿ (åˆ‡è§’è®¾è®¡) --- */
        .tech-panel {
            background: var(--glass-bg);
            border: 1px solid rgba(0, 243, 255, 0.3);
            position: relative;
            padding: 20px;
            margin-bottom: 20px;
            /* åˆ‡è§’æ•ˆæœ */
            clip-path: polygon(15px 0, 100% 0,
                    100% calc(100% - 15px), calc(100% - 15px) 100%,
                    0 100%, 0 15px);
            backdrop-filter: blur(10px);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
            transition: all 0.3s ease;
        }

        .tech-panel:hover {
            box-shadow: 0 0 25px rgba(0, 243, 255, 0.2);
            border-color: rgba(0, 243, 255, 0.6);
        }

        /* è£…é¥°çº¿æ¡ */
        .tech-deco-line {
            position: absolute;
            bottom: 0;
            right: 15px;
            width: 50px;
            height: 3px;
            background: var(--primary-color);
        }

        .panel-title {
            font-family: var(--tech-font);
            font-size: 1.1rem;
            letter-spacing: 2px;
            border-bottom: 1px solid rgba(0, 243, 255, 0.2);
            padding-bottom: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- æŒ‰é’®ç¾åŒ– --- */
        .btn-tech {
            background: rgba(0, 243, 255, 0.1);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            font-family: var(--tech-font);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 10px 20px;
            transition: 0.3s;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }

        .btn-tech:hover:not(:disabled) {
            background: var(--primary-color);
            color: #000;
            box-shadow: 0 0 20px var(--primary-color);
            transform: translateY(-2px);
        }

        .btn-tech:disabled {
            border-color: #555;
            color: #555;
            cursor: not-allowed;
        }

        /* ç‰¹æ®ŠæŒ‰é’®ï¼šé»„è‰²ä»»åŠ¡æŒ‰é’® */
        .btn-quest {
            border-color: #ffbd00;
            color: #ffbd00;
            background: rgba(255, 189, 0, 0.1);
        }

        .btn-quest:hover:not(:disabled) {
            background: #ffbd00;
            color: #000;
            box-shadow: 0 0 20px #ffbd00;
        }

        /* --- è¾“å…¥æ¡† --- */
        .input-tech {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            color: #fff;
            font-family: var(--code-font);
            border-radius: 0;
        }

        .input-tech:focus {
            background: rgba(0, 0, 0, 0.8);
            border-color: var(--primary-color);
            color: #fff;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
        }

        /* --- æ–°å¢ï¼šç©å®¶åå­—ç¼–è¾‘æ ·å¼ --- */
        .player-name-editable {
            cursor: pointer;
            border-bottom: 1px dashed transparent;
            transition: all 0.3s;
        }

        .player-name-editable:hover {
            border-bottom-color: var(--primary-color);
            text-shadow: 0 0 5px var(--primary-color);
        }

        #player-name-input {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--primary-color);
            color: #fff;
            font-family: var(--tech-font);
            font-size: 1.2rem;
            width: 150px;
            padding: 0 5px;
        }

        /* --- è¿›åº¦æ¡ --- */
        .progress-container {
            background: #111;
            height: 24px;
            /* åŠ é«˜é«˜åº¦ä»¥å®¹çº³æ–‡å­— */
            margin-top: 5px;
            position: relative;
            /* å…³é”®ï¼šä¸ºäº†è®©å­å…ƒç´ ç»å¯¹å®šä½ */
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: absolute;
            /* ç»å¯¹å®šä½ */
            top: 0;
            left: 0;
            z-index: 1;
            /* å±‚çº§ï¼šåœ¨æ–‡å­—ä¸‹æ–¹ */
            opacity: 0.85;
            /* ç¨å¾®é€æ˜ï¼Œè®©èƒŒæ™¯çº¹ç†é€ä¸€ç‚¹å‡ºæ¥ */
        }

        /* æ–°å¢ï¼šè¿›åº¦æ¡ä¸Šçš„æ–‡å­—å±‚ */
        .progress-text-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 10;
            /* å±‚çº§ï¼šæœ€é¡¶å±‚ï¼Œç»å¯¹ä¸ä¼šè¢«é®æŒ¡ */
            display: flex;
            align-items: center;
            justify-content: center;
            /* æ–‡å­—å±…ä¸­ */
            font-size: 12px;
            font-weight: bold;
            letter-spacing: 1px;
            color: #fff;
            text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
            /* é»‘è‰²æè¾¹ï¼Œç¡®ä¿åœ¨äº®è‰²æ¡ä¸Šä¹Ÿèƒ½çœ‹æ¸… */
            font-family: var(--tech-font);
        }

        .progress-fill.hp {
            background: linear-gradient(90deg, #ff2a6d, #ff5c8d);
            box-shadow: 0 0 10px #ff2a6d;
        }

        .progress-fill.mp {
            background: linear-gradient(90deg, #00f3ff, #0088ff);
            box-shadow: 0 0 10px #00f3ff;
        }

        .progress-fill.exp {
            background: linear-gradient(90deg, #ffbd00, #ffeba1);
            box-shadow: 0 0 10px #ffbd00;
        }

        /* --- å­—ä½“æ’ç‰ˆ --- */
        h1.main-title {
            font-family: var(--tech-font);
            font-weight: 700;
            font-size: 3rem;
            text-shadow: 0 0 20px rgba(0, 243, 255, 0.5);
            margin-bottom: 0;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 992px) {
            h1.main-title {
                font-size: 2rem;
            }

            #ui-layer {
                padding: 10px;
            }

            .tech-panel {
                margin-bottom: 15px;
            }
        }

        /* åŠ¨ç”»ç±» */
        .blink-slow {
            animation: blink 2s infinite;
        }

        .blink-fast {
            animation: blink 0.5s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        /* æŠ€èƒ½åˆ—è¡¨ */
        .skill-item {
            border-left: 2px solid #333;
            padding-left: 10px;
            margin-bottom: 8px;
            transition: 0.3s;
        }

        .skill-item.unlocked {
            border-left-color: var(--primary-color);
            background: linear-gradient(90deg, rgba(0, 243, 255, 0.1), transparent);
        }

        /* --- 3. å¸ƒå±€ä¼˜åŒ–ï¼šè‡ªé€‚åº”é«˜åº¦ --- */

        /* ä¿®æ”¹å·¦ä¾§å’Œå³ä¾§çš„åˆ—è¡¨å®¹å™¨ï¼Œè®©å…¶é«˜åº¦å¼¹æ€§åŒ– */
        #skill-list,
        #quest-list {
            min-height: 100px;
            /* æ²¡å†…å®¹æ—¶ä¹Ÿæœ‰ä¸ªåŸºç¡€é«˜åº¦ */
            max-height: 60vh;
            /* æœ€å¤§é«˜åº¦é™åˆ¶ä¸ºå±å¹•é«˜åº¦çš„ 60% */
            overflow-y: auto;
            /* å†…å®¹å¤šäº†å‡ºæ»šåŠ¨æ¡ */
            height: auto !important;
            /* è¦†ç›–å¯èƒ½çš„å›ºå®šé«˜åº¦ */
        }

        /* å¯¼å¸ˆé¢æ¿ä¹ŸåšåŒæ ·å¤„ç† */
        #mentor-content {
            min-height: 100px;
            max-height: 40vh;
            overflow-y: auto;
        }

        /* ç¡®ä¿é¢æ¿æœ¬èº«æ²¡æœ‰æ­»æ¿çš„é«˜åº¦é™åˆ¶ */
        .tech-panel {
            height: auto;
            display: flex;
            flex-direction: column;
        }

        /* --- æ–°å¢ï¼šä»»åŠ¡é€‰ä¸­ç‰¹æ•ˆ --- */
        .quest-card {
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            /* é¢„ç•™è¾¹æ¡†ä½ç½® */
        }

        .quest-card:hover {
            background: rgba(255, 255, 255, 0.05) !important;
        }

        /* é€‰ä¸­çŠ¶æ€ */
        .quest-card.active {
            background: rgba(0, 243, 255, 0.15) !important;
            border: 1px solid var(--primary-color) !important;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2) !important;
            transform: translateX(-5px);
            /* å¾®å¾®å·¦ç§»çªæ˜¾ */
        }

        /* é€‰ä¸­æ—¶çš„æŒ‡ç¤ºæ ‡ */
        .quest-card.active::before {
            content: 'â–¶ CURRENT';
            position: absolute;
            right: 10px;
            top: 5px;
            font-size: 0.6rem;
            color: var(--primary-color);
            font-weight: bold;
            font-family: var(--tech-font);
            animation: blink 1s infinite;
        }

        /* --- æ–°å¢ï¼šé‡‘å¸ä¸å•†åº—æ ·å¼ --- */
        .gold-display {
            font-family: var(--code-font);
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            font-size: 1.1rem;
            letter-spacing: 1px;
        }

        .shop-item {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #444;
            transition: 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .shop-item:hover {
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

        .shop-item .cost {
            color: #ffd700;
            font-weight: bold;
        }

        /* --- æ–°å¢ï¼šæ¨¡æ‹Ÿæˆ˜èŠå¤©æ ·å¼ --- */
        .chat-box {
            height: 400px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            line-height: 1.5;
            position: relative;
        }

        .chat-bubble.user {
            align-self: flex-end;
            background: rgba(0, 243, 255, 0.15);
            border: 1px solid var(--primary-color);
            color: #fff;
            border-bottom-right-radius: 0;
        }

        .chat-bubble.ai {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #666;
            color: #ddd;
            border-bottom-left-radius: 0;
        }

        .chat-bubble.system {
            align-self: center;
            background: transparent;
            border: none;
            color: #888;
            font-size: 0.8rem;
            font-style: italic;
        }

        /* --- è¯­éŸ³äº¤äº’æ ·å¼ --- */
        .mic-active {
            color: #ff2a6d !important;
            border-color: #ff2a6d !important;
            animation: mic-pulse 1.5s infinite;
            background: rgba(255, 42, 109, 0.1);
        }

        @keyframes mic-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 42, 109, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 42, 109, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 42, 109, 0);
            }
        }

        /* === æ–°å¢ï¼šå±ä¿ä¸ç©ºé—²æ¨¡å¼æ ·å¼ === */

        /* 1. è®© UI å±‚æ”¯æŒé€æ˜åº¦è¿‡æ¸¡ */
        #ui-layer {
            transition: opacity 1.5s ease-in-out, filter 1.5s ease-in-out;
            opacity: 1;
            filter: blur(0px);
        }

        /* 2. ç©ºé—²çŠ¶æ€ä¸‹çš„ UI (æé«˜é€æ˜åº¦ + æ¨¡ç³Š) */
        body.is-idle #ui-layer {
            opacity: 0.05;
            /* æé«˜é€æ˜åº¦ï¼Œéšçº¦å¯è§ */
            filter: blur(5px);
            /*ä»¥æ­¤è¡¬æ‰˜å‰æ™¯æ—¶é’Ÿ */
            pointer-events: none;
            /* ç¦æ­¢ç‚¹å‡» */
        }

        /* 3. å±ä¿å±‚ (Three.js æ—¶é’Ÿå®¹å™¨) */
        #screensaver-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            /* æœ€é«˜å±‚çº§ */
            pointer-events: none;
            /* è®©é¼ æ ‡äº‹ä»¶èƒ½ç©¿é€åˆ°åº•å±‚è§¦å‘å”¤é†’ */
            opacity: 0;
            /* é»˜è®¤éšè— */
            transition: opacity 1s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        body.is-idle #screensaver-layer {
            opacity: 1;
            /* ç©ºé—²æ—¶æ˜¾ç¤º */
        }

        /* === ä¼˜åŒ–ï¼šèƒŒæ™¯æ™¯æ·±å¤„ç† === */

        /* 1. èƒŒæ™¯å±‚å¢åŠ è¿‡æ¸¡æ•ˆæœ */
        #canvas-container {
            transition: all 1.5s ease-in-out;
            filter: blur(0px) brightness(1);
            transform: scale(1);
        }

        /* 2. å½“è¿›å…¥å±ä¿(is-idle)æ—¶ï¼ŒèƒŒæ™¯è™šåŒ–ã€å˜æš—ã€å¾®æ”¾å¤§(å‘¼å¸æ„Ÿ) */
        body.is-idle #canvas-container {
            filter: blur(8px) brightness(0.4);
            /* å…³é”®ï¼šæ¨¡ç³Š+å‹æš— */
            transform: scale(1.1);
            /* å¾®å¾®æ”¾å¤§ï¼Œåˆ¶é€ ç©ºé—´æ¨è¿œçš„é”™è§‰ */
            opacity: 0.8;
        }

        /* 3. å±ä¿å±‚æ–‡å­—å¢åŠ æŠ•å½±ï¼Œæå‡å¯è¯»æ€§ */
        #screensaver-layer {
            text-shadow: 0 0 30px rgba(0, 243, 255, 0.8);
        }

        /* =========================================
           ğŸ“± & ğŸ’» RESPONSIVE SYSTEM (ä¿®å¤ç‰ˆ)
           ========================================= */

        /* --- 1. å¹³æ¿ç«¯ä¸“ç”¨ä¼˜åŒ– (768px - 991px) --- */
        /* "å¤§æ°”"æ¨¡å¼ï¼šåˆ©ç”¨æ¨ªå±ç©ºé—´ï¼Œä¸è¦å †å  */
        @media (min-width: 768px) and (max-width: 991px) {

            /* æ ‡é¢˜æ æ¢å¤æ¨ªå‘å¸ƒå±€ï¼Œä¸è¦åƒæ‰‹æœºé‚£æ ·æŠ˜è¡Œ */
            #ui-layer>.d-flex.border-bottom {
                flex-direction: row !important;
                align-items: flex-end !important;
            }

            /* å³ä¾§æŒ‰é’®ç»„æ¢å¤å³å¯¹é½ */
            #ui-layer>.d-flex.border-bottom>.text-end {
                text-align: right !important;
                width: auto !important;
            }

            /* å­—ä½“æ”¾å¤§ï¼Œæ’‘æ»¡å±å¹• */
            h1.main-title {
                font-size: 2.5rem;
                /* æ¯”æ‰‹æœºå¤§ï¼Œæ¯”ç”µè„‘å° */
            }

            /* ä»»åŠ¡åˆ—è¡¨æ¨ªå‘åŒ–ï¼šå› ä¸ºå¹³æ¿åº•éƒ¨ç©ºé—´å¤§ï¼Œè®©ä»»åŠ¡å¡ç‰‡å˜æˆä¸¤åˆ—å¹¶æ’ */
            #quest-list {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                max-height: 500px !important;
            }

            #quest-list .quest-card {
                width: calc(50% - 10px);
                /* ä¸€è¡Œä¸¤ä¸ªä»»åŠ¡ */
                margin-bottom: 0 !important;
            }
        }

        /* --- 2. æ‰‹æœºç«¯ä¸“ç”¨ä¼˜åŒ– (< 768px) --- */
        /* "ç´§å‡‘"æ¨¡å¼ï¼šå‚ç›´å †å ï¼ŒèŠ‚çœç©ºé—´ */
        @media (max-width: 767px) {
            body {
                font-size: 14px;
            }

            h1.main-title {
                font-size: 1.6rem;
                margin-top: 5px;
            }

            .small.text-white-50 {
                font-size: 0.7rem !important;
            }

            /* å¼ºåˆ¶é¡¶éƒ¨å‚ç›´æ’åˆ— */
            #ui-layer>.d-flex.border-bottom {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 15px;
            }

            #ui-layer>.d-flex.border-bottom>.text-end {
                text-align: left !important;
                width: 100%;
            }

            .d-flex.align-items-center.justify-content-end.gap-2 {
                justify-content: flex-start !important;
                flex-wrap: wrap;
            }

            /* å±æ€§é¢æ¿ç´§å‡‘åŒ– */
            #stats-container .col-6 {
                width: 50%;
                padding: 2px;
            }

            .quest-card {
                padding: 10px !important;
            }

            /* 3Dæ—¶é’Ÿç¼©å° */
            #idle-countdown {
                font-size: 0.7rem !important;
            }

            /* é™åˆ¶é¢æ¿é«˜åº¦ */
            #quest-list,
            #skill-list,
            #mentor-content {
                max-height: 40vh !important;
            }
        }

        /* é€šç”¨ä¿®å¤ */
        html,
        body {
            height: 100%;
            overflow-x: hidden;
        }

        /* --- ğŸ—ºï¸ Map Style Simulation UI --- */

        /* åœ°å›¾å®¹å™¨ */
        .sim-map-container {
            display: grid;
            /* 5è¡Œ4åˆ— = 20å…³ */
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
            /* èŠ‚ç‚¹é—´è· */
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        /* æ¯ä¸€ä¸ªå…³å¡èŠ‚ç‚¹ */
        .map-node {
            position: relative;
            aspect-ratio: 1;
            /* ä¿æŒæ­£æ–¹å½¢/åœ†å½¢ */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            /* åœ†å½¢èŠ‚ç‚¹ */
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #333;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: not-allowed;
            text-align: center;
            z-index: 2;
            /* ç¡®ä¿åœ¨è¿çº¿ä¹‹ä¸Š */
        }

        /* èŠ‚ç‚¹å†…çš„æ–‡å­— */
        .map-node-level {
            font-family: var(--tech-font);
            font-size: 1.2rem;
            font-weight: bold;
            color: #555;
        }

        .map-node-label {
            font-size: 0.7rem;
            color: #555;
            margin-top: 5px;
            max-width: 90%;
            line-height: 1.1;
        }

        /* --- çŠ¶æ€ï¼šå·²è§£é” (UNLOCKED) --- */
        .map-node.unlocked {
            border-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
            cursor: pointer;
            background: rgba(0, 243, 255, 0.1);
        }

        .map-node.unlocked:hover {
            transform: scale(1.1);
            box-shadow: 0 0 25px var(--primary-color);
            background: var(--primary-color);
        }

        .map-node.unlocked .map-node-level {
            color: var(--primary-color);
        }

        .map-node.unlocked:hover .map-node-level {
            color: #000;
        }

        .map-node.unlocked .map-node-label {
            color: #aaa;
        }

        .map-node.unlocked:hover .map-node-label {
            color: #000;
        }

        /* --- çŠ¶æ€ï¼šå½“å‰å…³å¡ (CURRENT) --- */
        .map-node.current {
            border-color: #ffbd00;
            /* é‡‘è‰² */
            box-shadow: 0 0 20px #ffbd00;
            animation: pulse-node 2s infinite;
        }

        .map-node.current .map-node-level {
            color: #ffbd00;
        }

        /* --- çŠ¶æ€ï¼šå·²é€šå…³ (CLEARED) --- */
        .map-node.cleared {
            border-color: #198754;
            /* ç»¿è‰² */
            opacity: 0.7;
        }

        .map-node.cleared::after {
            content: 'âœ”';
            position: absolute;
            top: -5px;
            right: -5px;
            background: #198754;
            color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- è¿çº¿é€»è¾‘ (Connector Lines) --- */
        /* ä½¿ç”¨ä¼ªå…ƒç´ ç”»çº¿ã€‚è™½ç„¶ CSS Grid ç”»è¿çº¿æ¯”è¾ƒéº»çƒ¦ï¼Œè¿™é‡Œç”¨ä¸€ç§ç®€åŒ–çš„æ–¹æ³•ï¼š
   åªåœ¨éæ¯è¡Œæœ€åä¸€ä¸ªå…ƒç´ å³ä¾§ç”»çº¿ï¼Œæˆ–è€…æ ¹æ®è›‡å½¢èµ°ä½ç”»çº¿ã€‚
   ä¸ºäº†ç®€åŒ–ä»£ç å¤æ‚åº¦ï¼Œæˆ‘ä»¬ç»™å®¹å™¨åŠ ä¸€ä¸ª SVG èƒŒæ™¯æˆ–è€…ç®€å•ç”¨è™šçº¿è¿æ¥ */

        .sim-map-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
            /* è¿™é‡Œä½ å¯ä»¥æ”¾ä¸€å¼  S å‹çš„è¿çº¿èƒŒæ™¯å›¾ï¼Œæˆ–è€…ç”¨ CSS æ¸å˜æ¨¡æ‹Ÿ */
            /* ç®€å•èµ·è§ï¼Œæˆ‘ä»¬æš‚ä¸ç”»å¤æ‚çš„ S çº¿ï¼Œè€Œæ˜¯è®©èŠ‚ç‚¹å‘å…‰æ˜¾å¾—æœ‰é˜µåˆ—æ„Ÿ */
        }

        @keyframes pulse-node {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 189, 0, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(255, 189, 0, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 189, 0, 0);
            }
        }

        /* æ‰‹æœºé€‚é… */
        @media (max-width: 768px) {
            .sim-map-container {
                grid-template-columns: repeat(3, 1fr);
                /* æ‰‹æœºä¸€è¡Œ3ä¸ª */
                gap: 15px;
            }

            .map-node {
                width: auto;
                aspect-ratio: 1;
            }

            .map-node-level {
                font-size: 1rem;
            }

            .map-node-label {
                font-size: 0.6rem;
                display: none;
                /* æ‰‹æœºä¸Šå¦‚æœä¸ç‚¹å‡»å°±ä¸æ˜¾ç¤ºæ–‡å­—ï¼Œå¤ªæŒ¤ */
            }
        }

        /* --- æ¨¡æ‹Ÿæˆ˜å›å¤å»ºè®®æ ·å¼ --- */
        .sim-suggestion-chip {
            border: 1px dashed #555;
            background: rgba(0, 0, 0, 0.3);
            color: #ccc;
            transition: all 0.2s;
            white-space: normal;
            /* å…è®¸æ¢è¡Œ */
            text-align: left;
        }

        .sim-suggestion-chip:hover {
            background: rgba(0, 243, 255, 0.1);
            border-color: var(--primary-color);
            color: #fff;
        }

        /* --- ğŸ“± SIM Modal ç§»åŠ¨ç«¯é€‚é… --- */
        @media (max-width: 767px) {

            /* è®©æ§åˆ¶æ åœ¨æ‰‹æœºä¸Šå æ»¡ä¸€è¡Œï¼Œå¹¶é å³å¯¹é½ */
            .sim-controls-wrapper {
                width: 100%;
                margin-right: 0 !important;
                /* æ‰‹æœºä¸Šå–æ¶ˆå³è¾¹è·ï¼Œå› ä¸ºå…³é—­æŒ‰é’®æµ®åŠ¨äº† */
                margin-top: 10px !important;
                /* å¼ºåˆ¶æ¢è¡Œåï¼Œè·Ÿæ ‡é¢˜æ‹‰å¼€ç‚¹è·ç¦» */
                justify-content: space-between !important;
                /* æŒ‰é’®åˆ†æ•£å¯¹é½ */
            }

            /* ç¼©å°å¥½æ„Ÿåº¦åŒºåŸŸçš„å­—ä½“ */
            #sim-affinity-display {
                font-size: 0.9rem;
            }

            /* ç¼©å°æŒ‰é’®å°ºå¯¸ */
            #btn-export-sim-log,
            #btn-toggle-tts {
                padding: 0.2rem 0.5rem;
                font-size: 0.75rem;
            }
        }

        /* === æˆ˜æœ¯ç»ˆç«¯å»ºè®®å¡ç‰‡ä¼˜åŒ– === */
        .sim-suggestion-grid {
            display: grid;
            grid-template-columns: 1fr;
            /* æ‰‹æœºé»˜è®¤ï¼š1åˆ— */
            gap: 10px;
            margin-top: 15px;
            opacity: 0;
            animation: fadeInUp 0.5s forwards;
        }

        /* ç”µè„‘/å¹³æ¿ç«¯ (å±å¹•å®½åº¦ > 768px) è‡ªåŠ¨å˜ä¸º 3åˆ— */
        @media (min-width: 768px) {
            .sim-suggestion-grid {
                /* ğŸ”¥ ä¿®æ”¹ï¼šæ”¹ä¸º 2 åˆ—ï¼Œå½¢æˆ 2x2 çš„å¸ƒå±€ï¼Œå®¹çº³ 4 ä¸ªé€‰é¡¹æ›´å¥½çœ‹ */
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .sim-suggestion-card {
            background: rgba(20, 20, 30, 0.6);
            /* æ·±è‰²åŠé€æ˜èƒŒæ™¯ */
            border: 1px solid #444;
            border-left-width: 4px !important;
            /* å·¦ä¾§å½©è‰²æŒ‡ç¤ºæ¡åŠ ç²— */
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            height: 100%;
            /* å¼ºåˆ¶ç­‰é«˜ï¼Œæ•´é½åˆ’ä¸€ */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .sim-suggestion-card:hover {
            transform: translateY(-3px);
            /* æ‚¬åœä¸Šæµ® */
            background: rgba(255, 255, 255, 0.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .sim-suggestion-card:active {
            transform: scale(0.98);
        }

        /* === æˆ˜æœ¯ç»ˆç«¯å»ºè®®å¡ç‰‡ä¼˜åŒ– (ä¿®æ­£ç‰ˆ) === */
        /* ... (ä¹‹å‰çš„ .sim-suggestion-grid å’Œ .sim-suggestion-card æ ·å¼ä¿æŒä¸å˜) ... */

        /* ğŸ”¥ ä¿®æ”¹ï¼šæ¦‚ç‡å¾½ç« æ ·å¼ä¼˜åŒ– */
        .sim-pred-badge {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.75rem;
            /* ç¨å¾®è°ƒå¤§ä¸€ç‚¹ç‚¹å­—ä½“ï¼Œçœ‹æ¸…æ•°å­— */
            padding: 3px 6px;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #ffd700;
            /* é‡‘è‰²å­—ä½“ï¼Œæ›´æ˜¾çœ¼ */

            /* ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šå…è®¸æ–‡å­—è‡ªç„¶æ¢è¡Œï¼Œå–æ¶ˆå¼ºåˆ¶ä¸æ¢è¡Œ */
            white-space: normal;
            text-align: right;
            line-height: 1.2;

            /* æ‰‹æœºç«¯å¦‚æœä¸€è¡Œæ”¾ä¸ä¸‹ï¼Œè¿™ä¸ªå±æ€§ä¼šè®©å®ƒå°½é‡é å³ */
            margin-left: auto;
            max-width: 100%;
            /* å–æ¶ˆä¹‹å‰çš„ 60% é™åˆ¶ï¼Œå…è®¸å æ»¡ä¸€è¡Œ */
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body data-mode="learning">

    <div class="scanlines"></div>
    <div id="canvas-container"></div>

    <div id="ui-layer">

        <div class="row align-items-end mb-4 border-bottom border-dark pb-2 gx-3">

            <div class="col-lg-9 col-md-12 mb-2 mb-lg-0 d-flex justify-content-between align-items-end">
                <div>
                    <div class="d-flex align-items-center gap-3">
                        <div id="system-version-label" class="small text-white-50" style="letter-spacing: 3px;">WORK
                            SYSTEM // VER 3.7</div>
                        <span class="small text-success blink-slow"
                            style="font-size: 0.7rem; border: 1px solid #198754; padding: 0 5px; border-radius: 2px;">
                            â— ONLINE
                        </span>
                    </div>
                    <h1 class="main-title" style="color: #00f3ff; text-shadow: 0 0 20px rgba(0, 243, 255, 0.6);">
                        SOLO LEVELING
                    </h1>
                </div>
            </div>

            <div class="col-lg-3 col-md-12">
                <div class="d-flex flex-column gap-2">

                    <div class="d-flex justify-content-between align-items-center">
                        <button id="btn-switch-mode" class="btn btn-sm btn-outline-light"
                            style="font-family: var(--tech-font); letter-spacing: 1px; font-size: 0.75rem;">
                            <i class="bi bi-arrow-repeat"></i> SWITCH
                        </button>

                        <div class="text-end" style="min-width: 100px;">
                            <div class="h4 mb-0" id="clock" style="font-family: var(--tech-font); font-size: 1.2rem;">
                                00:00:00</div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <div class="btn-group">
                            <button id="btn-export-data" class="btn btn-sm btn-outline-info"
                                style="--bs-btn-padding-y: .1rem; --bs-btn-font-size: .65rem; letter-spacing: 1px;">
                                <i class="bi bi-cloud-arrow-down-fill"></i> SAVE
                            </button>
                            <button id="btn-import-data" class="btn btn-sm btn-outline-warning"
                                style="--bs-btn-padding-y: .1rem; --bs-btn-font-size: .65rem; letter-spacing: 1px;">
                                <i class="bi bi-cloud-arrow-up-fill"></i> LOAD
                            </button>
                            <input type="file" id="file-import-input" accept=".json" style="display: none;">
                        </div>

                        <div class="d-flex align-items-center gap-2">
                            <div id="idle-countdown" class="text-secondary font-monospace small"
                                style="font-size: 0.7rem; white-space: nowrap; margin-left: 8px;">
                                [03:00]
                            </div>
                            <button id="btn-reset-data" class="btn btn-sm btn-outline-danger" title="Reset System"
                                style="--bs-btn-padding-y: .1rem; --bs-btn-font-size: .65rem; letter-spacing: 1px;">
                                <i class="bi bi-radioactive"></i>
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="row">

            <div class="col-lg-3 col-md-5 mb-3 d-flex flex-column">
                <div class="tech-panel">
                    <div class="panel-title">
                        <span>STATUS</span>
                        <i class="bi bi-cpu"></i>
                    </div>

                    <div class="d-flex align-items-center mb-4">
                        <div class="me-3 d-flex justify-content-center align-items-center"
                            style="width: 60px; height: 60px; border: 2px solid var(--primary-color); box-shadow: 0 0 10px var(--primary-color) inset;">
                            <i class="bi bi-person-bounding-box" style="font-size: 1.8rem;"></i>
                        </div>
                        <div>
                            <div style="font-family: var(--tech-font); font-size: 1.2rem;">
                                <span id="status-player-label" class="player-name-editable"
                                    title="ç‚¹å‡»ä¿®æ”¹æ˜µç§°">Unknown</span>
                            </div>
                            <div id="status-player-job" class="text-warning small">ARCHITECT</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="progress-container">
                            <div id="hp-bar" class="progress-fill hp" style="width: 100%"></div>
                            <div id="hp-text" class="progress-text-overlay">HP: 100 / 100</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="progress-container">
                            <div id="mp-bar" class="progress-fill mp" style="width: 100%"></div>
                            <div id="mp-text" class="progress-text-overlay">MP: 100 / 100</div>
                        </div>
                    </div>

                    <div class="mb-2">
                        <div class="progress-container">
                            <div class="progress-fill exp" style="width: 0%"></div>
                            <div id="level-display" class="progress-text-overlay text-warning">LV.1 - 0%</div>
                        </div>
                        <div
                            class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top border-secondary">
                            <div class="gold-display">
                                <i class="bi bi-coin text-warning"></i>
                                <span id="gold-amount" class="text-white">0</span>
                                <span class="text-white-50">G</span>
                            </div>
                        </div>
                    </div>
                    <div class="row g-2 mt-2">
                        <div class="col-6">
                            <button class="btn btn-sm btn-outline-warning w-100" data-bs-toggle="modal"
                                data-bs-target="#shopModal" style="font-family: var(--tech-font);">
                                <i class="bi bi-cart4"></i> SHOP
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-sm btn-outline-danger w-100" data-bs-toggle="modal"
                                data-bs-target="#simModal" style="font-family: var(--tech-font);">
                                <i class="bi bi-controller"></i> SIM
                            </button>
                        </div>
                    </div>
                    <div class="tech-deco-line"></div>
                </div>
                <div class="tech-panel flex-grow-1">
                    <div class="panel-title" data-bs-toggle="collapse" data-bs-target="#skillCollapse"
                        style="cursor: pointer;">
                        <span>SKILL TREE</span>
                        <i class="bi bi-diagram-3"></i>
                    </div>

                    <div class="collapse show" id="skillCollapse">
                        <div class="input-group input-group-sm mb-3">
                            <input type="text" id="new-skill-input" class="form-control input-tech"
                                style="font-size: 0.8rem;" placeholder="è¾“å…¥èŒä¸š/æŠ€èƒ½ (å¦‚: Pythonçˆ¬è™«)">
                            <button class="btn btn-outline-info" type="button" id="btn-add-skill">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>

                        <div id="skill-list" class="small mt-2" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center text-white-50">Initializing...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 col-md-7 mb-3">

                <div id="feedback-panel" class="tech-panel"
                    style="min-height: 150px; display: flex; flex-direction: column; justify-content: flex-end;">
                    <div class="panel-title text-danger border-danger">
                        <span>SYSTEM TERMINAL</span>
                        <i class="bi bi-terminal-fill"></i>
                    </div>
                    <div id="ai-response" class="text-white small" style="line-height: 1.6;">
                        <span class="text-white-50">> System initialized.</span><br>
                        <span class="text-white-50">> Waiting for user input...</span>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-12">
                        <div class="tech-panel">
                            <label class="text-info mb-2 small" style="letter-spacing: 1px;">
                                <i class="bi bi-pencil-square"></i> UPLOAD LOG (æäº¤æ—¥å¿—)
                            </label>

                            <textarea id="report-input" class="form-control input-tech mb-3" rows="4"
                                placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„ä»£ç ã€å­¦ä¹ å¿ƒå¾—æˆ–é‡åˆ°çš„Bug..."></textarea>

                            <div class="d-flex gap-2">
                                <button id="btn-load-log" class="btn btn-outline-secondary"
                                    style="font-family: var(--tech-font); white-space: nowrap;">
                                    <i class="bi bi-file-earmark-text"></i> FILE
                                </button>

                                <button id="btn-report" class="btn btn-tech flex-grow-1 fw-bold">
                                    <i class="bi bi-upload"></i> UPLOAD DATA
                                </button>
                            </div>
                            <input type="file" id="file-log-input" accept=".txt" style="display: none;">
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="row g-2 mb-2">
                            <div class="col-12 col-md-auto">
                                <div class="input-group">
                                    <button
                                        class="btn btn-outline-secondary dropdown-toggle bg-dark text-warning border-secondary"
                                        type="button" style="font-family: var(--tech-font); font-size: 0.8rem;">
                                        <i class="bi bi-bar-chart-fill"></i> RANK
                                    </button>
                                    <select id="difficulty-select" class="form-select input-tech"
                                        style="width: auto; min-width: max-content;">
                                        <option value="RANDOM" selected>éšæœº</option>
                                        <option value="E-RANK">E (æ–°æ‰‹)</option>
                                        <option value="D-RANK">D (å…¥é—¨)</option>
                                        <option value="C-RANK">C (è¿›é˜¶)</option>
                                        <option value="B-RANK">B (å›°éš¾)</option>
                                        <option value="A-RANK">A (ä¸“å®¶)</option>
                                        <option value="S-RANK">S (åœ°ç‹± - Hell Difficulty)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-12 col-md">
                                <div class="input-group">
                                    <span class="input-group-text bg-dark text-info border-secondary"
                                        style="font-family: var(--tech-font); font-size: 0.8rem;">
                                        <i class="bi bi-funnel-fill"></i> PREF
                                    </span>
                                    <input type="text" id="request-input" class="form-control input-tech"
                                        placeholder="[å¯é€‰] åå¥½ (å¦‚: I2C)">
                                </div>
                            </div>
                        </div>

                        <button id="btn-request"
                            class="btn btn-tech btn-quest w-100 py-3 d-flex align-items-center justify-content-center">
                            <i class="bi bi-lightning-charge-fill me-2"></i>
                            <span style="font-size: 1.1rem; letter-spacing: 2px;">REQUEST MISSION</span>
                        </button>
                        <div class="tech-panel mt-3" style="border-color: #ffbd00;">
                            <div class="panel-title text-warning border-warning" data-bs-toggle="collapse"
                                data-bs-target="#customQuestCollapse" style="cursor: pointer;">
                                <span>CUSTOM ORDERS (è‡ªå®šæ¸…å•)</span>
                                <i class="bi bi-list-check"></i>
                            </div>

                            <div class="collapse" id="customQuestCollapse">
                                <div class="text-white-50 mb-2">
                                    <i class="bi bi-info-circle"></i> è¾“å…¥ä½ æƒ³åšçš„äº‹ï¼ˆä¸€è¡Œä¸€ä¸ªï¼‰ï¼ŒAIå°†è‡ªåŠ¨è¯„çº§å¹¶ç”Ÿæˆå¡ç‰‡ã€‚
                                </div>
                                <textarea id="custom-quest-input" class="form-control input-tech mb-3" rows="3"
                                    placeholder="èƒŒè¯µ50ä¸ªè€ƒç ”å•è¯&#10;å®ŒæˆPythonå¤§ä½œä¸šçš„ç™»å½•æ¨¡å—&#10;è·‘5å…¬é‡Œ"></textarea>

                                <button id="btn-custom-quest" class="btn btn-tech w-100"
                                    style="border-color: #ffbd00; color: #ffbd00;">
                                    <i class="bi bi-magic"></i> MATERIALIZE (å®ä½“åŒ–ä»»åŠ¡)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-12 mb-3 d-flex flex-column">

                <div class="tech-panel flex-grow-1"
                    style="min-height: 400px; max-height: 500px; display: flex; flex-direction: column;">
                    <div class="panel-title">
                        <span>QUEST LOG</span>
                        <i class="bi bi-list-task"></i>
                    </div>
                    <div id="quest-list" style="overflow-y: auto; flex: 1;">
                    </div>
                    <div class="tech-deco-line"></div>
                </div>

                <div class="tech-panel" id="mentor-panel" style="display:none; border-color: var(--secondary-color);">
                    <div class="panel-title text-info border-info">
                        <span>MENTOR GUIDANCE</span>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-download cursor-pointer me-2" id="btn-download-guidance"
                                style="cursor: pointer; font-size: 1rem;" title="ä¸‹è½½ä¸º TXT"></i>
                            <i class="bi bi-robot"></i>
                        </div>
                    </div>
                    <div id="mentor-content" class="small text-white"
                        style="line-height: 1.5; font-family: 'Courier New', monospace; max-height: 300px; overflow-y: auto;">
                    </div>
                </div>

            </div>
        </div>
    </div>
    <div id="screensaver-layer"></div>
    <div class="modal fade" id="simModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content"
                style="background: rgba(5, 5, 16, 0.95); border: 1px solid var(--primary-color); box-shadow: 0 0 30px rgba(0,0,0,0.8);">
                <div
                    class="modal-header border-secondary d-flex flex-wrap align-items-center p-2 p-md-3 position-relative">

                    <h5 class="modal-title text-danger d-flex align-items-center gap-2"
                        style="font-family: var(--tech-font); font-size: 1.1rem;">
                        <i class="bi bi-display"></i>
                        <span class="d-none d-sm-inline">SIMULATION ROOM</span> <span class="d-inline d-sm-none">SIM
                            ROOM</span>
                    </h5>

                    <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
                        data-bs-dismiss="modal" style="z-index: 10;"></button>

                    <div class="d-flex align-items-center gap-2 ms-auto mt-2 mt-md-0 flex-wrap justify-content-end sim-controls-wrapper"
                        style="margin-right: 30px;">



                        <button id="btn-export-sim-log"
                            class="btn btn-sm btn-outline-success d-flex align-items-center gap-1" title="å¯¼å‡ºè®°å½•"
                            style="white-space: nowrap;">
                            <i class="bi bi-download"></i> <span class="d-none d-sm-inline">LOG</span>
                        </button>

                        <button id="btn-toggle-tts" class="btn btn-sm btn-outline-info d-flex align-items-center gap-1"
                            title="è¯­éŸ³å¼€å…³" style="white-space: nowrap;">
                            <i class="bi bi-volume-up-fill"></i> <span class="d-none d-sm-inline">ON</span>
                        </button>
                    </div>
                </div>
                <div class="modal-body">
                    <div id="sim-setup" class="text-center py-4">
                        <h4 class="text-white mb-4">SELECT SCENARIO</h4>
                        <div class="mb-4 text-center">
                            <label class="text-info small mb-2"><i class="bi bi-person-lines-fill"></i> é€‰æ‹©è¯­éŸ³éŸ³è‰²
                                (Voice)</label>
                            <select id="voice-select" class="form-select input-tech mx-auto"
                                style="max-width: 300px; font-size: 0.9rem;">
                                <option value="">æ­£åœ¨åŠ è½½è¯­éŸ³åŒ…...</option>
                            </select>
                        </div>
                        <div id="sim-scenario-container" class="d-flex justify-content-center gap-3 flex-wrap"></div>
                    </div>

                    <div id="sim-interface" style="display:none;">

                        <div id="sim-status-bar"
                            class="d-flex justify-content-between align-items-center mb-2 px-3 py-2 rounded"
                            style="background: rgba(0, 243, 255, 0.1); border: 1px solid var(--primary-color);">
                            <div>
                                <span class="text-white-50 small">RELATIONSHIP:</span>
                                <span id="sim-status-text" class="fw-bold text-white ms-2">STRANGER [0%]</span>
                            </div>

                            <div class="text-end">
                                <div class="text-warning small fw-bold" id="sim-day-display">DAY 1</div>
                                <div class="text-info font-monospace small" id="sim-time-display">08:00</div>
                            </div>
                        </div>

                        <div id="sim-chat-box" class="chat-box mb-3 rounded"></div>

                        <div class="input-group">
                            <button class="btn btn-outline-secondary" type="button" id="btn-mic" title="ç‚¹å‡»å¼€å§‹è¯´è¯">
                                <i class="bi bi-mic"></i>
                            </button>
                            <input type="text" id="sim-input" class="form-control input-tech" placeholder="è¾“å…¥æˆ–è¯­éŸ³å›å¤...">

                            <button class="btn btn-tech" id="btn-sim-send">SEND <i class="bi bi-send-fill"></i></button>

                            <button class="btn btn-tech btn-quest" id="btn-sim-next" style="display:none;">
                                LATER... <i class="bi bi-calendar-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="shopModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: rgba(5, 5, 16, 0.95); border: 1px solid #ffd700;">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-danger" style="font-family: var(--tech-font);">
                        <i class="bi bi-display"></i> SIMULATION ROOM
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3" id="shop-items-container">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // ----------------------------------------------------
        // 1. Three.js èƒŒæ™¯ç‰¹æ•ˆ (ä¼˜åŒ–ç‰ˆ)
        // ----------------------------------------------------
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050510, 0.035); // é›¾æ°”é¢œè‰²ä¸èƒŒæ™¯ä¸€è‡´
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // åœ°é¢ç½‘æ ¼ (æ›´å¹¿é˜”)
        const gridHelper = new THREE.GridHelper(100, 40, 0x00f3ff, 0x001133);
        gridHelper.position.y = -3;
        scene.add(gridHelper);

        // æµ®åŠ¨å‡ ä½•ä½“
        const coreGroup = new THREE.Group();
        const geo1 = new THREE.IcosahedronGeometry(1.5, 0);
        const mat1 = new THREE.MeshBasicMaterial({ color: 0x00f3ff, wireframe: true });
        const mesh1 = new THREE.Mesh(geo1, mat1);
        coreGroup.add(mesh1);

        // å¤–ç¯
        const geo2 = new THREE.TorusGeometry(3, 0.02, 16, 100);
        const mat2 = new THREE.MeshBasicMaterial({ color: 0x0066ff });
        const mesh2 = new THREE.Mesh(geo2, mat2);
        mesh2.rotation.x = Math.PI / 2;
        coreGroup.add(mesh2);
        scene.add(coreGroup);

        // ç²’å­æ˜Ÿç©º
        const particlesGeo = new THREE.BufferGeometry();
        const particlesCount = 400;
        const posArray = new Float32Array(particlesCount * 3);
        for (let i = 0; i < particlesCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 60;
        }
        particlesGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const particlesMat = new THREE.PointsMaterial({ size: 0.08, color: 0x00f3ff, transparent: true, opacity: 0.4 });
        const starField = new THREE.Points(particlesGeo, particlesMat);
        scene.add(starField);

        camera.position.z = 8;
        camera.position.y = 2;

        function animate() {
            requestAnimationFrame(animate);
            // ç¼“æ…¢æ—‹è½¬
            mesh1.rotation.y += 0.003;
            mesh1.rotation.x += 0.001;
            mesh2.rotation.z -= 0.005;
            mesh2.rotation.x = Math.PI / 2 + Math.sin(Date.now() * 0.0005) * 0.1;

            // ç²’å­æµ®åŠ¨
            starField.rotation.y += 0.0005;

            // åœ°é¢ç§»åŠ¨é”™è§‰
            gridHelper.position.z = (Date.now() * 0.001) % 2.5;

            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // ----------------------------------------------------
        // 2. æ ¸å¿ƒé€»è¾‘ (DeepSeek API + çŠ¶æ€ç®¡ç†)
        // ----------------------------------------------------

        // ğŸ”´ğŸ”´ğŸ”´ è¯·åœ¨æ­¤å¤„å¡«å…¥æ­£ç¡®çš„ API KEY ğŸ”´ğŸ”´ğŸ”´
        const API_KEY = "sk-d6a578302bf8461b9ef74a72bcf23915";
        let currentMode = localStorage.getItem('solo_current_mode') || 'learning';
        let simHistory = []; // æ¨¡æ‹Ÿæˆ˜å¯¹è¯å†å²

        // --- æ–°å¢ï¼šæ¨¡æ‹Ÿæˆ˜å‰§æœ¬é…ç½® ---
        const SIM_SCENARIOS = [
            // --- æ–°å¢ï¼šLV.1 åˆ° LV.20 çš„å…³å¡åˆ—è¡¨ ---
            // ===============================================
            // åŸºç¡€éš¾åº¦åŒº (Lv1 - Lv5): åŸ¹å…»åŸºæœ¬è‡ªä¿¡å’Œè°ƒæƒ…èƒ½åŠ›
            // ===============================================
            {
                id: "dating_lvl_1", type: "dating", level: 1, locked: false,
                label: "Lv.1 ä¾¿åˆ©åº—æ”¶é“¶å‘˜",
                start_range: [0, 5], // é™Œç”Ÿäººï¼Œåªæœ‰ç¤¼è²Œåˆ†
                prompt: "ã€åœºæ™¯ã€‘ï¼šä½ æ¯æ™šä¸‹ç­éƒ½å»çš„ä¾¿åˆ©åº—ã€‚å¥¹æ˜¯å…¼èŒå¤§å­¦ç”Ÿï¼Œä¸å¿™ã€‚\nã€äººè®¾ã€‘ï¼šç¤¼è²Œï¼ŒèŒä¸šå‡ç¬‘ï¼Œå•çº¯ã€‚\nã€ä½ çš„ç°çŠ¶ã€‘ï¼š29å²ï¼Œå¹³æ—¶åªä¼šè¯´â€œè°¢è°¢â€ã€‚\nã€ç›®æ ‡ã€‘ï¼šä¸è¦åªä¹°ä¸œè¥¿ã€‚å°è¯•èŠä¸¤å¥ä¸äº¤æ˜“æ— å…³çš„è¯é¢˜ï¼ˆå¦‚â€œä»Šæ™šå€¼ç­å¾ˆæ™šå•Šâ€ï¼‰ï¼Œå¹¶ä¸å¼•èµ·åæ„Ÿã€‚",
                cao_laoshi_advice: "è¿™æ˜¯æ–°æ‰‹æ‘ã€‚ä¸è¦æƒ³ç€è¿½å¥¹ï¼ŒåªæŠŠå®ƒå½“æˆç»ƒä¹ 'å¼€å£'çš„é¶å­ã€‚è¯­æ°”è¦éšæ„ï¼Œä¸è¦åƒä¸ªå˜æ€ä¸€æ ·ç›¯ç€çœ‹ã€‚"
            },
            {
                id: "dating_lvl_2", type: "dating", level: 2, locked: true,
                label: "Lv.2 æ–°æ¥çš„å®ä¹ ç”Ÿ",
                start_range: [15, 25], // å‰è¾ˆå…‰ç¯ï¼Œè‡ªå¸¦å°Šæ•¬
                prompt: "ã€åœºæ™¯ã€‘ï¼šå…¬å¸èŒ¶æ°´é—´ã€‚å¥¹æ˜¯åˆšå…¥èŒ00åï¼Œå¯¹ç¯å¢ƒä¸ç†Ÿã€‚\nã€äººè®¾ã€‘ï¼šæœ‰ç‚¹æ‹˜è°¨ï¼Œæƒ³èå…¥ä½†ä¸æ•¢è¯´è¯ã€‚\nã€ç›®æ ‡ã€‘ï¼šä½œä¸º29å²çš„å‰è¾ˆï¼Œå±•ç°'å¤§å“¥å“¥'çš„ç…§é¡¾ã€‚åˆ©ç”¨ä¿¡æ¯å·®æä¾›ä»·å€¼ï¼ˆå‘Šè¯‰å¥¹å“ªé‡Œçš„å’–å•¡å¥½å–ï¼‰ï¼Œè€Œä¸æ˜¯è¯´æ•™ã€‚",
                cao_laoshi_advice: "ä½ è¦åšçš„æ˜¯'é¢†è·¯äºº'ã€‚ä¸è¦æŸ¥æˆ·å£ï¼Œè¦åˆ†äº«ç»éªŒï¼Œæ¶ˆé™¤å¥¹çš„ç´§å¼ æ„Ÿã€‚"
            },
            {
                id: "dating_lvl_3", type: "dating", level: 3, locked: true,
                label: "Lv.3 å¾ˆä¹…ä¸è§çš„è€åŒå­¦",
                start_range: [30, 45], // æ€€æ—§æ»¤é•œï¼ŒåŸºç¡€ä¿¡ä»»é«˜
                prompt: "ã€åœºæ™¯ã€‘ï¼šå¾®ä¿¡èŠå¤©ã€‚ä½ çªç„¶æƒ³èµ·å¥¹ï¼Œæˆ–è€…å¥¹åœ¨æœ‹å‹åœˆå‘äº†ä¸ªåŠ¨æ€ã€‚\nã€äººè®¾ã€‘ï¼šå¯¹ä½ æœ‰å°è±¡ä½†æ¨¡ç³Šï¼Œå¤„äºé™Œç”Ÿå’Œç†Ÿæ‚‰çš„ä¸´ç•Œç‚¹ã€‚\nã€ç›®æ ‡ã€‘ï¼šå¤è”ã€‚ä¸è¦å‘'åœ¨å—'ã€‚ä»è¯„è®ºå¥¹çš„åŠ¨æ€åˆ‡å…¥ï¼Œå¼€å¯ä¸€æ®µä¸å°‘äº10ä¸ªå›åˆçš„å™æ—§ã€‚",
                cao_laoshi_advice: "åˆ‡å¿Œ'æŸ¥æˆ·å£'ï¼ˆåœ¨å“ªä¸Šç­ï¼Ÿå·¥èµ„å¤šå°‘ï¼Ÿï¼‰ã€‚èŠèŠå½“å¹´çš„ç³—äº‹ï¼Œç”¨'å…±åŒå›å¿†'å”¤é†’å¥½æ„Ÿã€‚"
            },
            {
                id: "dating_lvl_4", type: "dating", level: 4, locked: true,
                label: "Lv.4 æ‹¼è½¦/æ‹¼æ¡Œçš„è·¯äºº",
                start_range: [-5, 5], // å¯èƒ½å› ä¸ºæ‹¥æŒ¤ç•¥å¸¦çƒ¦èº
                prompt: "ã€åœºæ™¯ã€‘ï¼šé«˜å³°æœŸé¤å…æ‹¼æ¡Œï¼Œæˆ–è€…é¡ºé£è½¦ã€‚\nã€äººè®¾ã€‘ï¼šç©æ‰‹æœºæ©é¥°å°´å°¬ï¼Œé˜²å¾¡å€¼ä¸­ç­‰ã€‚\nã€ç›®æ ‡ã€‘ï¼šç ´å†°ã€‚æ‰“ç ´æ²‰é»˜çš„å°´å°¬ï¼Œè¯„ä»·å½“ä¸‹çš„ç¯å¢ƒï¼ˆè¿™èœå¤ªè¾£äº†/è¿™è·¯å µæ­»äº†ï¼‰ï¼Œè®©å¥¹æ”¾ä¸‹æ‰‹æœºæ„¿æ„è·Ÿä½ èŠä¸€è·¯ã€‚",
                cao_laoshi_advice: "åªèŠç¯å¢ƒï¼Œä¸èŠéšç§ã€‚å¦‚æœå¥¹ä¸æƒ³èŠï¼Œè¦æœ‰çœ¼åŠ›è§é—­å˜´ï¼ˆè¿™ä¹Ÿæ˜¯æˆç†Ÿï¼‰ã€‚"
            },
            {
                id: "dating_lvl_5", type: "dating", level: 5, locked: true,
                label: "Lv.5 é‚»å®¶é›ç‹—å¥³ç”Ÿ",
                start_range: [10, 20], // é‚»å±…è„¸ç†Ÿ + çˆ±ç‹—å…‰ç¯
                prompt: "ã€åœºæ™¯ã€‘ï¼šå°åŒºæ¥¼ä¸‹ã€‚å¥¹ç‰µç€ä¸€åªé‡‘æ¯›ã€‚\nã€äººè®¾ã€‘ï¼šçˆ±ç‹—ï¼Œæœ‰çˆ±å¿ƒï¼Œå¯¹é™Œç”Ÿç”·äººæœ‰è­¦æƒ•ï¼Œå¯¹èŠç‹—çš„äººå¾ˆçƒ­æƒ…ã€‚\nã€ç›®æ ‡ã€‘ï¼šå€ŸåŠ©å® ç‰©ä½œä¸º'ç¤¾äº¤è´§å¸'ã€‚å³ä½¿ä½ ä¸æ‡‚ç‹—ï¼Œä¹Ÿè¦è¡¨ç°å‡ºå–œæ¬¢ï¼Œå¹¶è®©å¥¹ä»¥æ­¤æ‰“å¼€è¯åŒ£å­ã€‚",
                cao_laoshi_advice: "è¹²ä¸‹æ¥è·Ÿç‹—ç©ï¼Œä¸è¦ç›¯ç€äººçœ‹ã€‚'å®ƒå«ä»€ä¹ˆåå­—ï¼Ÿ'æ˜¯ä¸‡èƒ½é’¥åŒ™ã€‚"
            },

            // =================================================================
            // é˜¶æ®µäºŒï¼šç›¸äº²ä¸è¯•æ¢ (Lv6 - Lv10)
            // æ ¸å¿ƒï¼šä»·å€¼å±•ç¤ºä¸åºŸç‰©æµ‹è¯•ï¼Œåº”å¯¹æˆå¹´äººçš„ç­›é€‰
            // =================================================================
            {
                id: "dating_lvl_6", type: "dating", level: 6, locked: true,
                label: "Lv.6 è¢«è¿«ç›¸äº²ï¼šå†…å‘å¥³",
                start_range: [5, 15], // éƒ½æ˜¯è¢«é€¼çš„ï¼Œæœ‰åŒç—…ç›¸æ€œæ„Ÿ
                prompt: "ã€åœºæ™¯ã€‘ï¼šå’–å•¡å…ç›¸äº²å±€ã€‚ä»‹ç»äººåˆšèµ°ï¼Œä¸¤äººç‹¬å¤„ã€‚\nã€äººè®¾ã€‘ï¼šç¤¾æï¼Œä½å¤´æŠ æ‰‹ï¼Œé—®ä¸€å¥ç­”ä¸€å¥ã€‚\nã€ç›®æ ‡ã€‘ï¼šä½ å¿…é¡»ä¸»å¯¼è¯é¢˜ã€‚ä¸è¦è®©å¥¹æ„Ÿåˆ°å‹åŠ›ï¼Œç”¨å¹½é»˜è‡ªå˜²ï¼ˆåæ§½ä»‹ç»äºº/ç›¸äº²æœ¬èº«ï¼‰åŒ–è§£å°´å°¬ã€‚",
                cao_laoshi_advice: "å¦‚æœä¸¤ä¸ªäººéƒ½é—·ï¼Œè¿™å±€å°±æ­»ã€‚åˆ†äº«ä¸ªè‡ªå·±çš„è ¢äº‹ï¼Œè®©å¥¹ç¬‘å‡ºæ¥ï¼Œä½ å°±èµ¢äº†ä¸€åŠã€‚"
            },
            {
                id: "dating_lvl_7", type: "dating", level: 7, locked: true,
                label: "Lv.7 è¢«è¿«ç›¸äº²ï¼šç°å®å¥³",
                start_range: [-10, 5], // å®¡è§†çŠ¶æ€ï¼Œç”šè‡³æ˜¯è´Ÿåˆ†
                prompt: "ã€åœºæ™¯ã€‘ï¼šé¥­å±€ã€‚å¥¹ä¸€åä¸‹å°±å®¡è§†ä½ çš„ç©¿æ­ã€‚\nã€äººè®¾ã€‘ï¼š29å²+ï¼Œæ€¥äºç»“å©šï¼Œçœ‹é‡ç¡¬ä»¶ï¼Œè¯´è¯ç›´ç™½ä¼¤äººã€‚\nã€ç›®æ ‡ã€‘ï¼šä¸å‘ä¸äº¢ã€‚é¢å¯¹'æœ‰æˆ¿å—''å·¥èµ„å¤šå°‘'çš„å†’çŠ¯æ€§æé—®ï¼Œå­¦ä¼š'åå‘ç­›é€‰'ï¼Œå±•ç¤ºä½ çš„åº•æ°”ã€‚",
                cao_laoshi_advice: "ä¸è¦åƒçŠ¯äººä¸€æ ·å›ç­”ã€‚å¥¹é—®å·¥èµ„ï¼Œä½ åé—®'ä½ è§‰å¾—å¤šå°‘èƒ½å…»å¾—èµ·ä½ çš„ç”Ÿæ´»å“è´¨ï¼Ÿ'ã€‚å®ˆä½æ¡†æ¶ã€‚"
            },
            {
                id: "dating_lvl_8", type: "dating", level: 8, locked: true,
                label: "Lv.8 èšä¼šä¸­çš„â€œCä½å¥³â€",
                start_range: [0, 5], // ä¹ æƒ¯è¢«æ§ï¼Œå¯¹ä½ æ— æ„Ÿ
                prompt: "ã€åœºæ™¯ã€‘ï¼šKTVæˆ–å‰§æœ¬æ€ã€‚å¥¹æ˜¯å…¨åœºç„¦ç‚¹ï¼Œå¾ˆå¤šç”·ç”Ÿå›´ç€å¥¹ã€‚\nã€äººè®¾ã€‘ï¼šè‡ªä¿¡ï¼Œä¹ æƒ¯è¢«æ§ï¼Œå¯¹æ™®é€šè®¨å¥½æ— æ„Ÿã€‚\nã€ç›®æ ‡ã€‘ï¼šå·®å¼‚åŒ–ç«äº‰ã€‚ä¸è¦åƒåˆ«äººä¸€æ ·å¤¸å¥¹ï¼Œå¶å°”'æ‰“å‹'ï¼ˆæŸï¼‰å¥¹ä¸€ä¸‹ï¼Œå¼•èµ·å¥¹çš„æ³¨æ„ã€‚",
                cao_laoshi_advice: "å½“æ‰€æœ‰äººéƒ½ç»™å¥¹é€’æ°´æ—¶ï¼Œä½ è‡ªå·±åœ¨æ—è¾¹ç©æ‰‹æœºã€‚ç­‰å¥¹æ²¡äººç†æ—¶ï¼Œå†éšå£è¯´å¥'ä½ åˆšå”±è·‘è°ƒäº†'ã€‚"
            },
            {
                id: "dating_lvl_9", type: "dating", level: 9, locked: true,
                label: "Lv.9 æ¢æ¢/ç¤¾äº¤è½¯ä»¶",
                start_range: [10, 20], // æ—¢ç„¶åŒ¹é…äº†ï¼Œè‚¯å®šçœ‹é¡ºçœ¼
                prompt: "ã€åœºæ™¯ã€‘ï¼šåˆšåŒ¹é…æˆåŠŸã€‚å¥¹ç…§ç‰‡ç²¾ä¿®ï¼Œç­¾åé«˜å†·ã€‚\nã€äººè®¾ã€‘ï¼šé¢œå€¼é«˜ï¼Œå¤‡èƒå¤šï¼Œå›æ¶ˆæ¯ææ…¢ã€‚\nã€ç›®æ ‡ã€‘ï¼šå¼€åœºç™½æµ‹è¯•ã€‚å¦‚æœå‘'ä½ å¥½/åœ¨å—'ç›´æ¥Game Overã€‚éœ€è¦ä»ç…§ç‰‡ç»†èŠ‚æŒ–æ˜è¯é¢˜ï¼Œåˆ¶é€ å¥½å¥‡ã€‚",
                cao_laoshi_advice: "æ”¾å¤§é•œè§‚å¯Ÿç…§ç‰‡èƒŒæ™¯ã€‚'èƒŒæ™¯é‡Œçš„é‚£æœ¬ä¹¦æˆ‘ä¹Ÿçœ‹è¿‡'æ¯”'ç¾å¥³å¥½'å¼ºä¸€ä¸‡å€ã€‚"
            },
            {
                id: "dating_lvl_10", type: "dating", level: 10, locked: true,
                label: "Lv.10 ç¬¬ä¸€æ¬¡æ­£å¼çº¦ä¼š",
                start_range: [50, 60], // èƒ½å‡ºæ¥çº¦ä¼šï¼Œå¥½æ„Ÿåº¦å·²ç»åŠæ ¼
                prompt: "ã€åœºæ™¯ã€‘ï¼šå‘¨å…­æ™šä¸Šçš„è¥¿é¤å…ã€‚ä½ ä»¬ç½‘èŠä¸é”™ï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡å¥”ç°ã€‚\nã€äººè®¾ã€‘ï¼šæœŸå¾…åˆçŸœæŒï¼Œæ­£åœ¨å…¨æ–¹ä½è€ƒå¯Ÿä½ çš„è¨€è¡Œä¸¾æ­¢ã€‚\nã€ç›®æ ‡ã€‘ï¼šç»…å£«é£åº¦+å¸¦é¢†æ„Ÿã€‚ç‚¹èœã€å®‰æ’è½¬åœºã€ç»“è´¦ï¼Œå…¨ç¨‹è¡Œäº‘æµæ°´ï¼Œä¸èƒ½é—®'æˆ‘ä»¬å»å“ªï¼Ÿ'ã€‚",
                cao_laoshi_advice: "è¿™æ˜¯29å²ç”·äººçš„æœŸä¸­è€ƒè¯•ã€‚ä¸è¦è¯•å›¾åŠ¨æ‰‹åŠ¨è„šï¼Œç”¨çœ¼ç¥å’Œç»†èŠ‚ï¼ˆå¸®æ‹‰æ¤…å­ï¼‰å¾æœå¥¹ã€‚"
            },

            // =================================================================
            // é˜¶æ®µä¸‰ï¼šæš§æ˜§ä¸åšå¼ˆ (Lv11 - Lv15)
            // æ ¸å¿ƒï¼šæ¨æ‹‰ã€æƒ…ç»ªä»·å€¼ä¸è‚¢ä½“è¿›æŒªï¼Œçªç ´å‹è°ŠåŒº
            // =================================================================
            {
                id: "dating_lvl_11", type: "dating", level: 11, locked: true,
                label: "Lv.11 çªç ´â€œå‹è°ŠåŒºâ€",
                start_range: [70, 80], // æé«˜ä¿¡ä»»ï¼Œä½†æ— æ€§å¸å¼•
                prompt: "ã€åœºæ™¯ã€‘ï¼šä½ ä»¬è®¤è¯†å¾ˆä¹…ï¼Œåƒå…„å¼Ÿä¸€æ ·ã€‚ä½ æƒ³è¿›ä¸€æ­¥ã€‚\nã€äººè®¾ã€‘ï¼šæŠŠä½ å½“å¥½äºº/æ ‘æ´ï¼Œæ²¡å¾€é‚£æ–¹é¢æƒ³ã€‚\nã€ç›®æ ‡ã€‘ï¼šåˆ¶é€ 'æ€§å¼ åŠ›'ã€‚é€šè¿‡è‚¢ä½“è¯­è¨€æˆ–æš§æ˜§çš„è¯ï¼Œè®©å¥¹æ„è¯†åˆ°'æˆ‘æ˜¯ä¸ªç”·äººï¼Œä¸æ˜¯ä½ é—ºèœœ'ã€‚",
                cao_laoshi_advice: "åœæ­¢åšçƒ‚å¥½äººã€‚æ‹’ç»å¥¹çš„ä¸€æ¬¡æ— ç†è¦æ±‚ï¼Œæˆ–è€…åœ¨è¿‡é©¬è·¯æ—¶ç‰µæ‰‹è…•è¶…è¿‡3ç§’ã€‚æ‰“ç ´å¹³è¡¡ã€‚"
            },
            {
                id: "dating_lvl_12", type: "dating", level: 12, locked: true,
                label: "Lv.12 æš§æ˜§æœŸçš„æ¨æ‹‰",
                start_range: [60, 75], // å¿½é«˜å¿½ä½ï¼Œå¾ˆä¸ç¨³å®š
                prompt: "ã€åœºæ™¯ã€‘ï¼šæ·±å¤œèŠå¤©ã€‚å…³ç³»æš§æ˜§ï¼Œä½†æ²¡æ…ç ´ã€‚\nã€äººè®¾ã€‘ï¼šå¿½å†·å¿½çƒ­ï¼Œæµ‹è¯•ä½ çš„åº•çº¿ï¼Œæˆ–è€…åœ¨å…»é±¼ã€‚\nã€ç›®æ ‡ã€‘ï¼šå¿ƒæ€åšå¼ˆã€‚å¥¹å†·ä½ ä¹Ÿå†·ï¼Œå¥¹çƒ­ä½ å†çƒ­ã€‚ä¸è¦ç§’å›ï¼Œä¸è¦æš´éœ²è¿‡å¼ºçš„éœ€æ±‚æ„Ÿã€‚",
                cao_laoshi_advice: "å¥¹éš”åŠå°æ—¶å›ï¼Œä½ ä¹Ÿéš”åŠå°æ—¶ã€‚ä¸è¦é—®'æ€ä¹ˆä¸ç†æˆ‘'ã€‚è¦åšå¥–å“ï¼Œè€Œä¸æ˜¯è¿½æ±‚è€…ã€‚"
            },
            {
                id: "dating_lvl_13", type: "dating", level: 13, locked: true,
                label: "Lv.13 è‚¢ä½“è¿›æŒª (Kino)",
                start_range: [65, 75], // èº«ä½“å¯èƒ½è¿˜æŠ—æ‹’
                prompt: "ã€åœºæ™¯ã€‘ï¼šçœ‹ç”µå½±æˆ–æ•£æ­¥ã€‚æ°”æ°›åˆ°äº†ã€‚\nã€äººè®¾ã€‘ï¼šå®³ç¾ï¼ŒASDï¼ˆåè¡å¦‡æœºåˆ¶ï¼‰å¼€å¯ï¼Œèº«ä½“åƒµç¡¬ã€‚\nã€ç›®æ ‡ã€‘ï¼šåˆ†çº§è¿›æŒªã€‚ä»ç¢°è‚©è†€ã€ç‰µæ‰‹åˆ°æ‹¥æŠ±ã€‚å­¦ä¼šè¯»å–å¥¹çš„èº«ä½“åé¦ˆï¼Œä¸åæŠ—å°±æ˜¯é»˜è®¸ã€‚",
                cao_laoshi_advice: "å…ˆç¢°æ‰‹è‚˜ï¼Œå†ç¢°æ‰‹è…•ã€‚å¦‚æœå¥¹ç¼©æ‰‹ï¼Œç«‹åˆ»è£…ä½œæ— äº‹å‘ç”Ÿï¼Œé€€å›å»èŠä¸¤å¥å†è¯•ã€‚"
            },
            {
                id: "dating_lvl_14", type: "dating", level: 14, locked: true,
                label: "Lv.14 åªæœ‰ç”·é—ºèœœ",
                start_range: [50, 60], // å› ä¸ºç”·é—ºèœœçš„äº‹ï¼Œå¥½æ„Ÿä¸‹é™
                prompt: "ã€åœºæ™¯ã€‘ï¼šå¥¹æƒ³å¸¦'ç”·é—ºèœœ'æ¥ä½ ä»¬çš„çº¦ä¼šï¼Œæˆ–è€…æ€»ææŸç”·ç”Ÿã€‚\nã€äººè®¾ã€‘ï¼šç•Œé™æ¨¡ç³Šï¼Œæµ‹è¯•ä½ çš„å«‰å¦’å¿ƒå’Œæ¡†æ¶ã€‚\nã€ç›®æ ‡ã€‘ï¼šéœ¸æ°”å›åº”ã€‚æ¸©å’Œä½†åšå®šåœ°è¡¨è¾¾ä¸æ‚¦ï¼Œå±•ç¤ºç”·ä¸»äººçš„å æœ‰æ¬²ï¼Œè€Œä¸æ˜¯å‘å¾®åƒé†‹ã€‚",
                cao_laoshi_advice: "ç¬‘ç€è¯´ï¼š'çº¦ä¼šå¸¦ç”µç¯æ³¡å¯ä¸æµªæ¼«ã€‚ä¸‹æ¬¡å†å¸¦ä»–ï¼Œä»Šæ™šæ˜¯æˆ‘ä»¬ä¸¤äººçš„ã€‚' å®£ç¤ºä¸»æƒã€‚"
            },
            {
                id: "dating_lvl_15", type: "dating", level: 15, locked: true,
                label: "Lv.15 ç¡®ç«‹å…³ç³» (è¡¨ç™½)",
                start_range: [85, 90], // åªå·®ä¸´é—¨ä¸€è„š
                prompt: "ã€åœºæ™¯ã€‘ï¼šçº¦ä¼šå°¾å£°ï¼Œå®Œç¾çš„æ°›å›´ã€‚\nã€äººè®¾ã€‘ï¼šç­‰ä½ å¼€å£ï¼Œå¦‚æœä½ ä¸å¼€å£å¥¹ä¼šå¾ˆå¤±æœ›ã€‚\nã€ç›®æ ‡ã€‘ï¼šä¹Ÿæ˜¯æœŸæœ«è€ƒã€‚ä¸è¦é—®'èƒ½ä¸èƒ½åšæˆ‘å¥³æœ‹å‹'ï¼ˆæŠŠå†³å®šæƒç»™åˆ«äººï¼‰ã€‚ç›´æ¥ç”¨é™ˆè¿°å¥ï¼š'åšæˆ‘å¥³æœ‹å‹å§'ï¼Œç„¶åæŠ±ä½ã€‚",
                cao_laoshi_advice: "è¡¨ç™½æ˜¯èƒœåˆ©çš„å‡¯æ­Œï¼Œä¸æ˜¯å†²é”‹çš„å·è§’ã€‚å‰é¢åšå¥½äº†ï¼Œè¿™åªæ˜¯èµ°ä¸ªè¿‡åœºã€‚"
            },

            // =================================================================
            // é˜¶æ®µå››ï¼šé•¿æœŸå…³ç³»ä¸ç£¨åˆ (Lv16 - Lv20)
            // æ ¸å¿ƒï¼šè§£å†³å†²çªï¼Œæ·±åº¦å…±æƒ…ï¼Œç»è¥æœªæ¥
            // =================================================================
            {
                id: "dating_lvl_16", type: "dating", level: 16, locked: true,
                label: "Lv.16 ç¬¬ä¸€æ¬¡å¤§åµæ¶",
                start_range: [30, 50], // åµæ¶ä¸­ï¼Œå¥½æ„Ÿéª¤é™
                prompt: "ã€åœºæ™¯ã€‘ï¼šçƒ­æ‹æœŸè¿‡åçš„ç£¨åˆã€‚å¥¹æ— ç†å–é—¹æˆ–å†·æš´åŠ›ã€‚\nã€äººè®¾ã€‘ï¼šæƒ…ç»ªåŒ–ï¼Œç”šè‡³è¯´åè¯'æ»š'ã€‚\nã€ç›®æ ‡ã€‘ï¼šæƒ…ç»ªç¨³å®šã€‚ä¸è¦è®²é“ç†ï¼ä¸è¦è®²é“ç†ï¼å…ˆè§£å†³æƒ…ç»ªï¼ŒæŠ±ä½å¥¹ï¼Œç­‰å¥¹å†·é™å†è§£å†³é—®é¢˜ã€‚",
                cao_laoshi_advice: "å¥³äººåµæ¶åµçš„æ˜¯æ€åº¦ã€‚ä½ åªè¦å¼ä¸€å¥ï¼Œä½ å°±è¾“äº†ã€‚æ·±å‘¼å¸ï¼Œåšä¸ªæƒ…ç»ªå®¹å™¨ã€‚"
            },
            {
                id: "dating_lvl_17", type: "dating", level: 17, locked: true,
                label: "Lv.17 è„†å¼±çš„æ—¶åˆ»",
                start_range: [80, 90], // éœ€è¦ä¾é ï¼Œä¾èµ–æ„Ÿå¼º
                prompt: "ã€åœºæ™¯ã€‘ï¼šå¥¹å·¥ä½œå—å§”å±ˆï¼Œæˆ–è€…å®¶é‡Œå‡ºäº‹ï¼Œåœ¨ä½ é¢å‰å“­äº†ã€‚\nã€äººè®¾ã€‘ï¼šå¸ä¸‹é˜²å¤‡ï¼Œæåº¦è„†å¼±ï¼Œéœ€è¦ä¾é ã€‚\nã€ç›®æ ‡ã€‘ï¼šæä¾›é¡¶çº§æƒ…ç»ªä»·å€¼ã€‚ä¸è¦ç»™è§£å†³æ–¹æ¡ˆï¼ˆåˆ«è¯´'ä½ åº”è¯¥è¾èŒ'ï¼‰ï¼Œåªè¦é™ªä¼´å’Œå€¾å¬ã€‚'æˆ‘åœ¨'èƒœè¿‡åƒè¨€ä¸‡è¯­ã€‚",
                cao_laoshi_advice: "é—­å˜´ï¼Œé€’çº¸å·¾ï¼ŒæŠ±ç´§ã€‚è®©å¥¹å“­æ¹¿ä½ çš„è‚©è†€ã€‚"
            },
            {
                id: "dating_lvl_18", type: "dating", level: 18, locked: true,
                label: "Lv.18 è°ˆå©šè®ºå«çš„å‹åŠ›",
                start_range: [60, 80], // ç°å®å‹åŠ›å¯¼è‡´å…³ç³»ç´§å¼ 
                prompt: "ã€åœºæ™¯ã€‘ï¼šèŠåˆ°å½©ç¤¼ã€ä¹°æˆ¿ã€å¼‚åœ°å®šå±…ã€‚ç°å®çš„å·¨çŸ³ã€‚\nã€äººè®¾ã€‘ï¼šç„¦è™‘ï¼Œå—çˆ¶æ¯å½±å“ï¼Œå¯¹æœªæ¥åŠ¨æ‘‡ã€‚\nã€ç›®æ ‡ã€‘ï¼šå±•ç°ç”·äººçš„æ‹…å½“ã€‚ä¸ä»…ä»…æ˜¯ç”»é¥¼ï¼Œè¦ç»™å‡ºå…·ä½“çš„æ—¶é—´è¡¨å’Œè®¡åˆ’ã€‚ç»Ÿä¸€æˆ˜çº¿ï¼Œæå®šå²³çˆ¶æ¯ã€‚",
                cao_laoshi_advice: "ä¸è¦æŠŠå¥¹æ¨åˆ°ä½ çˆ¶æ¯çš„å¯¹ç«‹é¢ã€‚ä½ æ˜¯åŒé¢èƒ¶ã€‚è¿™ä¸€å…³è¿‡ä¸å»å°±åˆ†æ‰‹ã€‚"
            },
            {
                id: "dating_lvl_19", type: "dating", level: 19, locked: true,
                label: "Lv.19 æŸ´ç±³æ²¹ç›çš„ç–²æƒ«",
                start_range: [70, 80], // å¹³æ·¡æœŸ
                prompt: "ã€åœºæ™¯ã€‘ï¼šåŒå±…/å©šåã€‚è°æ´—ç¢—ã€è°å€’åƒåœ¾å¼•å‘çš„äº‰åµã€‚\nã€äººè®¾ã€‘ï¼šç–²æƒ«ï¼Œè§‰å¾—ä½ ä¸çˆ±å¥¹äº†ï¼Œç”Ÿæ´»ä¸€åœ°é¸¡æ¯›ã€‚\nã€ç›®æ ‡ã€‘ï¼šç»è¥æµªæ¼«ã€‚åœ¨å¹³æ·¡ä¸­åˆ¶é€ æƒŠå–œï¼Œä¸»åŠ¨æ‰¿æ‹…å®¶åŠ¡ï¼Œæ‹’ç»'ä¸§å¶å¼'å…³ç³»ã€‚",
                cao_laoshi_advice: "ä¹°æŸèŠ±ï¼Œä¸»åŠ¨æ´—ä¸ªç¢—ã€‚çˆ±åœ¨ç»†èŠ‚é‡Œã€‚åˆ«ä»¥ä¸ºåˆ°æ‰‹äº†å°±å¯ä»¥æ‘†çƒ‚ã€‚"
            },
            {
                id: "dating_lvl_20", type: "dating", level: 20, locked: true,
                label: "Lv.20 çµé­‚ä¼´ä¾£",
                start_range: [95, 100], // æ»¡åˆ†
                prompt: "ã€åœºæ™¯ã€‘ï¼šæ·±å¤œè°ˆå¿ƒã€‚å›é¡¾ä¸€è·¯èµ°æ¥çš„ä¸æ˜“ã€‚\nã€äººè®¾ã€‘ï¼šæœ€æ‡‚ä½ çš„äººï¼Œä½ çš„æˆ˜å‹ï¼Œä½ çš„çˆ±äººã€‚\nã€ç›®æ ‡ã€‘ï¼šæ·±åº¦å…±é¸£ã€‚ä¸ä»…æ˜¯çˆ±äººï¼Œæ›´æ˜¯çŸ¥å·±ã€‚åˆ†äº«å½¼æ­¤æœ€æ·±å±‚çš„ææƒ§å’Œæ¢¦æƒ³ã€‚\nã€é€šå…³æ¡ä»¶ã€‘ï¼šå¥½æ„Ÿåº¦100%ï¼Œä¸”è®©å¥¹è¯´å‡º'é‡åˆ°ä½ çœŸå¥½'ã€‚",
                cao_laoshi_advice: "æ­å–œä½ ã€‚ä»29å²çš„é›¶ç»éªŒå°ç™½ï¼Œå˜æˆäº†æ‡‚çˆ±ã€ä¼šçˆ±ã€å€¼å¾—çˆ±çš„ç”·äººã€‚"
            },
            // --- Learning æ¨¡å¼å‰§æœ¬ ---
            {
                id: 'code_master',
                type: 'learning',
                label: 'ğŸ† ä¿¡å¥¥CSP-Jé­”é¬¼è€ƒæ ¸', // æŒ‰é’®æ–‡å­—ä¿®æ”¹
                // ä¸‹é¢æ˜¯æ ¸å¿ƒ Promptï¼Œè®¾å®šäº†ä¸¥å‰æ•™ç»ƒçš„äººè®¾
                prompt: 'ä½ æ˜¯ä¸€ä½æ‹¥æœ‰åå¹´ç»éªŒçš„ä¿¡å¥¥é‡‘ç‰Œæ•™ç»ƒï¼ˆNOI Gold Medalistï¼‰ï¼Œæ€§æ ¼æåº¦ä¸¥å‰ã€æ¯’èˆŒã€‚æˆ‘æ˜¯ä¸€åé©¬ä¸Šè¦å‚åŠ  CSP-J/S å¤èµ›çš„å­¦ç”Ÿã€‚è¯·å¯¹æˆ‘è¿›è¡Œå…¨çœŸæ¨¡æ‹Ÿå‹æµ‹ã€‚è¯·ä¸è¦é—®åŸºç¡€è¯­æ³•ï¼Œé‡ç‚¹è€ƒå¯Ÿï¼š1. ç®—æ³•é€‰æ‹©ï¼ˆDFS/BFSã€åŠ¨æ€è§„åˆ’ã€è´ªå¿ƒã€äºŒåˆ†ï¼‰ï¼›2. æ—¶é—´å¤æ‚åº¦æ•æ„Ÿåº¦ï¼ˆçœ‹åˆ° N=10^5 è¦çŸ¥é“åªèƒ½ç”¨ O(NlogN)ï¼‰ï¼›3. å¸¸è§å‘ç‚¹ï¼ˆä¸å¼€ long long è§ç¥–å®—ã€å¤šæµ‹ä¸æ¸…ç©ºã€æ–‡ä»¶è¾“å…¥è¾“å‡º freopen é”™è¯¯ï¼‰ã€‚å¦‚æœæˆ‘çš„å›ç­”æœ‰æ¼æ´æˆ–æ€è·¯ä¼šå¯¼è‡´ TLE (è¶…æ—¶) / MLE (çˆ†å†…å­˜)ï¼Œè¯·æ¯«ä¸ç•™æƒ…åœ°æ–¥è´£æˆ‘â€œè¿™ç§ä»£ç åœ¨è€ƒåœºä¸Šå°±æ˜¯çˆ†é›¶â€ï¼Œå¹¶æŒ‡å‡ºæˆ‘çš„é”™è¯¯ã€‚'
            },
            {
                id: 'interview_tech',
                type: 'learning', // æ ‡è®°å±äºå­¦ä¹ æ¨¡å¼
                label: 'ğŸ’» æ¯’èˆŒé¢è¯•å®˜',
                prompt: 'ä½ æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„BATçš„æŠ€æœ¯é¢è¯•å®˜ï¼Œæ­£åœ¨è€ƒå¯Ÿæˆ‘çš„æŠ€æœ¯èƒ½åŠ›ï¼ˆåµŒå…¥å¼C/C++/Python/ç®—æ³•/æ¶æ„ï¼‰ï¼Œå¦‚æœæˆ‘å›ç­”ä¸å¥½ä½ ä¼šå°–é”æŒ‡å‡ºã€‚'
            },
            {
                id: 'salary_talk',
                type: 'learning',
                label: 'ğŸ’° è°ˆè–ªèµ„åšå¼ˆ',
                prompt: 'ä½ æ˜¯åå•¬çš„è€æ¿ï¼Œæˆ‘æƒ³æ¶¨è–ª30%ï¼Œä½ éœ€è¦ç”¨å„ç§ç†ç”±ï¼ˆå¤§ç¯å¢ƒä¸å¥½ã€é¢„ç®—ä¸è¶³ï¼‰æ‹’ç»æˆ‘ï¼Œæˆ‘éœ€è¦å’Œä½ åšå¼ˆã€‚'
            },
            {
                id: 'english_chat',
                type: 'learning',
                label: 'ğŸ‡ºğŸ‡¸ é›…æ€å£è¯­',
                prompt: 'You are an IELTS examiner. We are having a casual conversation. Please correct my grammar errors if any.'
            }
        ];
        // å•†å“åˆ—è¡¨é…ç½®
        // --- 3. å‡çº§ç‰ˆï¼šæ›´æœ‰è¶£çš„å•†åº—é…ç½® ---
        const SHOP_ITEMS = [
            // === åŸºç¡€è¡¥ç»™ ===
            { id: 'pot_small', name: 'ğŸ¥¤ å¿«é€Ÿå›å¤è¯å‰‚', cost: 30, icon: 'bi-cup-straw', desc: 'HP +20 | MP +20', type: 'VIRTUAL', effect: { hp: 20, mp: 20 } },
            { id: 'pot_full', name: 'ğŸ’‰ è‚¾ä¸Šè…ºç´ æ³¨å°„', cost: 100, icon: 'bi-capsule', desc: 'çŠ¶æ€å®Œå…¨æ¢å¤ (HP/MP æ»¡)', type: 'VIRTUAL', effect: { full_restore: true } },

            // === å¨±ä¹ä¸åšå½© (æ–°å¢) ===
            { id: 'gacha_box', name: 'ğŸ [èµŒç‹—] å¹¸è¿ç›²ç›’', cost: 50, icon: 'bi-box-seam', desc: 'å¯èƒ½å¼€å‡º 0~200 é‡‘å¸', type: 'GACHA' },

            // === ç°å®å¥–åŠ± (å¤šå·´èƒºæ¶ˆè´¹) ===
            { id: 'real_snack', name: 'ğŸŸ ç°å®å¥–åŠ±ï¼šæ¬ºéª—é¤', cost: 150, icon: 'bi-emoji-laughing', desc: 'å…è®¸è‡ªå·±åƒä¸€é¡¿é«˜çƒ­é‡ç¾é£Ÿ', type: 'REAL' },
            { id: 'real_game', name: 'ğŸ® ç°å®å¥–åŠ±ï¼šå •è½ä¸€æ™š', cost: 300, icon: 'bi-controller', desc: 'ä»Šæ™šä¸å­¦ä¹ /çº¦ä¼šï¼Œçº¯ç©æ¸¸æˆ', type: 'REAL' },
            { id: 'real_buy', name: 'ğŸ›ï¸ ç°å®å¥–åŠ±ï¼šæ¸…ç©ºè´­ç‰©è½¦', cost: 1000, icon: 'bi-bag-heart', desc: 'è´­ä¹°ä¸€ä»¶ < 500å…ƒçš„å•†å“', type: 'REAL' },

            // === æ ¸å¿ƒé“å…· ===
            { id: 'buff_card', name: 'ğŸ›¡ï¸ å…æ­»é‡‘ç‰Œ', cost: 500, icon: 'bi-shield-check', desc: 'æŠµæ¶ˆä¸€æ¬¡ä»»åŠ¡å¤±è´¥æƒ©ç½š', type: 'ITEM' }
        ];
        const defaultStateDating = {
            playerName: "ROMANTICIST", // æ–°å¢å­—æ®µ
            hp: 100, mp: 100, exp: 0, level: 1, ap: 0, gold: 0,
            terminalLog: "", // æ–°å¢å­—æ®µï¼šç‹¬ç«‹ç»ˆç«¯è®°å½•
            stats: { str: 5, int: 5, sen: 5, vit: 5 },
            quests: [],
            skills: [
                {
                    theme: "PHASE 1: ç¡¬ä»¶é‡æ„ (åŸºå»ºæœŸ LV.1-8)",
                    children: [
                        // LV.1: 0æˆæœ¬ï¼Œæ´—æŠŠè„¸å°±èƒ½åšï¼Œç«‹åˆ»è§æ•ˆ
                        { name: "[1.é¢å®¹] é¢éƒ¨æŠ¤ç†/çœ‰æ¯›ä¿®æ•´/é¼»æ¯›ç®¡ç†", level: "LV.1", enabled: true },

                        // LV.2: 0æˆæœ¬ï¼Œä½†è¿™å†³å®šäº†ä½ ç©¿è¡£æœçš„æ°”è´¨ã€‚å…ˆæŒºæ‹”ï¼Œå†ä¹°è¡£æœã€‚
                        { name: "[2.ä½“æ€] è´´å¢™ç«™ç«‹/æ²‰è‚©/æ‹’ç»è„–å­å‰å€¾", level: "LOCKED", enabled: false },

                        // LV.3: å‡ ç™¾å…ƒæˆæœ¬ï¼Œç¡®ç«‹å¤´éƒ¨è½®å»“
                        { name: "[3.å‘å‹] å¯»æ‰¾å‘å‹å¸ˆ/ä¾§åˆ†/éœ²é¢å¤´", level: "LOCKED", enabled: false },

                        // LV.4: æ‘˜æ‰åšé‡çš„ä¹¦å‘†å­æ»¤é•œ
                        { name: "[4.çœ¼ç¥] éšå½¢çœ¼é•œé€‚åº”/æ›´æ¢æ—¶å°šé•œæ¡†", level: "LOCKED", enabled: false },

                        // LV.5-6: æ­¤æ—¶ä½ å·²ç»å¹²å‡€æŒºæ‹”ï¼Œå†ä¸Šè£…å¤‡æ•ˆæœç¿»å€
                        { name: "[5.ç©¿æ­] ä¼˜è¡£åº“/æ— å°è‰¯å“ (æŠ›å¼ƒæ—§è¡£)", level: "LOCKED", enabled: false },

                        // LV.7-8: é•¿æœŸé¡¹ç›®ï¼Œä½œä¸ºæœ¬é˜¶æ®µçš„æ¯•ä¸šè®¾è®¡
                        { name: "[6.èº«æ] å¥èº«æˆ¿å¯åŠ¨ (èƒ¸/èƒŒ/å‡è„‚)", level: "LOCKED", enabled: false }
                    ]
                },
                {
                    theme: "PHASE 2: èµ„æºä¸å±•ç¤º (å†·å¯åŠ¨ LV.8-12)",
                    children: [
                        // æœ‰äº†Phase 1çš„åŸºç¡€ï¼Œæ‰èƒ½æ‹å‡ºåƒæ ·çš„ç…§ç‰‡
                        { name: "[å±•ç¤ºé¢] 3å¼ é«˜è´¨é‡ç”Ÿæ´»ç…§ (éè‡ªæ‹)", level: "LOCKED", enabled: false },
                        { name: "[æœ‹å‹åœˆ] æ¸…ç†è¿‡å¾€/å»ºè®¾æ–°å½¢è±¡", level: "LOCKED", enabled: false },
                        // å…ˆæ‹¿ç†Ÿäººç»ƒæ‰‹ï¼Œå‡ ä¹æ— å‹åŠ›
                        { name: "[ç§åŸŸ] æ¿€æ´»èººå°¸å¥½å‹/è€åŒå­¦å™æ—§", level: "LOCKED", enabled: false },
                        { name: "[å¼±è”ç³»] å¾ˆå¤šå¥³ç”Ÿçš„ç¤¾ç¾¤/æ´»åŠ¨æ··è„¸ç†Ÿ", level: "LOCKED", enabled: false }
                    ]
                },
                {
                    theme: "PHASE 3: èŠå•ä¸ç­›é€‰ (å®æˆ˜æœŸ LV.12-16)",
                    children: [
                        { name: "[å¿ƒæ€] å»ºç«‹äº†é…å¾—æ„Ÿ (ä¸å›æ¶ˆæ¯ä¸ç„¦è™‘)", level: "LOCKED", enabled: false },
                        { name: "[ç ´å†°] ç”šè‡³ä¸éœ€è¦å¼€åœºç™½çš„è‡ªç„¶å¼€å¯", level: "LOCKED", enabled: false },
                        { name: "[äº’åŠ¨] æä¾›æƒ…ç»ªä»·å€¼ (æ¨æ‹‰/å¹½é»˜)", level: "LOCKED", enabled: false },
                        { name: "[ç­›é€‰] å¿«é€Ÿè¯†åˆ«ä¸æ„Ÿå…´è¶£/ç”šè‡³å…»é±¼çš„äºº", level: "LOCKED", enabled: false }
                    ]
                },
                {
                    theme: "PHASE 4: çº¦ä¼šä¸å‡æ¸© (å†³èƒœæœŸ LV.16+)",
                    children: [
                        { name: "[é‚€çº¦] æ¨¡ç³Šé‚€çº¦ -> ç¡®å®šæ€§é‚€çº¦", level: "LOCKED", enabled: false },
                        { name: "[ç°åœº] çº¦ä¼šé€‰å€/è½¬åœºè®¾è®¡ (Low Cost)", level: "LOCKED", enabled: false },
                        { name: "[è¿›æŒª] Kino è‚¢ä½“æ¥è§¦çš„è„±æ•ä¸åˆ†å¯¸", level: "LOCKED", enabled: false },
                        { name: "[ç§å¯†] ç‹¬å¤„æ—¶çš„å¼ åŠ›æ§åˆ¶ (ASDç ´é™¤)", level: "LOCKED", enabled: false }
                    ]
                }
            ],
            inventory: [],
            simProgress: {
                unlockedLevel: 1,  // å½“å‰å·²è§£é”çš„æœ€é«˜ç­‰çº§
                currentSimID: null  // å½“å‰æ­£åœ¨è¿›è¡Œçš„ SIM ID
            },
            scenarioData: {}
        };

        const defaultStateLearning = {
            playerName: "TECHNOMANCER", // æ–°å¢å­—æ®µ
            hp: 100, mp: 100, exp: 0, level: 1, gold: 0,
            terminalLog: "", // æ–°å¢å­—æ®µï¼šç‹¬ç«‹ç»ˆç«¯è®°å½•
            quests: [],
            skills: [
            ], inventory: []
        };

        // è·å–å½“å‰æ¨¡å¼çš„ Key
        function getStorageKey() {
            return currentMode === 'dating' ? 'solo_save_dating' : 'solo_save_learning';
        }

        // --- å·¥å…·ï¼šå°†è‡ªç„¶è¯­è¨€æ—¶é—´è½¬ä¸ºæ¯«ç§’ ---
        function parseDurationToMs(str) {
            if (!str) return 2 * 60 * 60 * 1000; // é»˜è®¤2å°æ—¶

            // æå–æ•°å­—
            const numMatch = str.match(/(\d+)/);
            const num = numMatch ? parseInt(numMatch[1]) : 1;

            // è¯†åˆ«å•ä½
            if (str.includes("åˆ†") || str.includes("min")) return num * 60 * 1000;
            if (str.includes("æ—¶") || str.includes("hour")) return num * 60 * 60 * 1000;
            if (str.includes("å¤©") || str.includes("day")) return num * 24 * 60 * 60 * 1000;

            // å¦‚æœåªæœ‰æ•°å­—æˆ–è€…æ˜¯â€œæ— æ—¶é™â€ï¼Œé»˜è®¤ç»™ 24 å°æ—¶
            return 24 * 60 * 60 * 1000;
        }

        // --- å·¥å…·ï¼šæ ¼å¼åŒ–å‰©ä½™æ—¶é—´ (hh:mm:ss) ---
        function formatCountDown(ms) {
            if (ms <= 0) return "00:00:00";
            const h = Math.floor(ms / 3600000);
            const m = Math.floor((ms % 3600000) / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function loadState() {
            const key = getStorageKey();
            const saved = localStorage.getItem(key);
            const def = currentMode === 'dating' ? defaultStateDating : defaultStateLearning;

            if (!saved) return JSON.parse(JSON.stringify(def));

            let state = JSON.parse(saved);
            // æ•°æ®ç»“æ„è¿ç§»å…¼å®¹
            if (state.gold === undefined) state.gold = 0;
            if (!state.inventory) state.inventory = [];
            if (!state.playerName) state.playerName = def.playerName; // è¡¥å…¨åå­—
            if (state.terminalLog === undefined) state.terminalLog = ""; // è¡¥å…¨æ—¥å¿—
            return state;
        }

        function saveState(state) {
            localStorage.setItem(getStorageKey(), JSON.stringify(state));
        }

        function renderUI(state) {
            // [æ–°å¢] æ›´æ–°é‡‘å¸æ˜¾ç¤º
            $('#gold-amount').text(state.gold);
            $('#shop-gold-display').text(state.gold);
            // 1. è®¾ç½®é¡µé¢æ¨¡å¼ (è§¦å‘ CSS å…¨å±€å˜è‰²)
            $('body').attr('data-mode', currentMode);

            /* === ğŸŸ¢ ç²˜è´´è¿™æ®µæ–°ä»£ç  === */

            // è®¡ç®—å½“å‰ç­‰çº§
            const currentLevel = 1 + Math.floor(state.exp / 100);
            const currentExpPercent = state.exp % 100;

            // --------------------------------------------------------
            // [ä¿®æ”¹ç‰ˆ] 2. åŠ¨æ€ä¿®æ”¹ Header å’Œ STATUS é¢æ¿ä¿¡æ¯
            // --------------------------------------------------------

            // ã€æ–°å¢ã€‘è·å– STATUS é¢æ¿é‡Œçš„åå­—å’ŒèŒä¸šæ ‡ç­¾
            const $nameLabel = $('#status-player-label');
            const $jobLabel = $('#status-player-job');

            // ã€æ–°å¢ã€‘åªæœ‰å½“åå­—ä¸æ˜¯è¾“å…¥æ¡†çŠ¶æ€æ—¶ï¼Œæ‰æ›´æ–°æ–‡å­—ï¼ˆé˜²æ­¢æ‰“å­—æ—¶è¢«åˆ·æ–°æ‰“æ–­ï¼‰
            if ($nameLabel.length && !$nameLabel.find('input').length) {
                $nameLabel.text(state.playerName || "Unknown");
            }
            const $reportPanel = $('#report-input').closest('.tech-panel'); // æ‰¾åˆ°è¾“å…¥æ¡†æ‰€åœ¨çš„é¢æ¿
            const $label = $reportPanel.find('label');                      // é¢æ¿æ ‡é¢˜
            const $input = $('#report-input');                              // è¾“å…¥æ¡†
            const $btn = $('#btn-report');
            if (currentMode === 'dating') {
                // --- [æ¨¡å¼ï¼šæ‹çˆ±] ---
                $('.main-title')
                    .text('SOLO DATING')
                    .css({
                        'color': '#ff5c8d',
                        'text-shadow': '0 0 20px rgba(255, 92, 141, 0.6)'
                    });
                $('#system-version-label').text('LOVE SYSTEM // VER 3.8');

                // ã€ä¿®æ”¹ã€‘æ›´æ–°å·¦ä¾§é¢æ¿çš„èŒä¸š
                if ($jobLabel.length) $jobLabel.text(`LV.${currentLevel} ROMANTICIST`);

                // æ³¨æ„ï¼šæˆ‘ä»¬ä¸å†å»æ”¹é¡¶éƒ¨çš„ $headerMeta äº†ï¼Œå› ä¸ºåå­—å·²ç»ç§»åˆ°äº†å·¦ä¾§
                // ğŸ”¥ğŸ”¥ğŸ”¥ æ–°å¢ï¼šä¿®æ”¹å³ä¾§é¢æ¿æ–‡æ¡ˆï¼Œå¼•å¯¼ç”¨æˆ·è¿›è¡Œå¤ç›˜ ğŸ”¥ğŸ”¥ğŸ”¥
                $('.tech-panel label:contains("UPLOAD LOG")').html('<i class="bi bi-heart-pulse"></i> UPLOAD CHAT LOG (æƒ…æ„Ÿå¤ç›˜)');
                $('#report-input').attr('placeholder', 'ã€æˆ˜æœ¯å¤ç›˜æ¨¡å¼ã€‘\nè¯·ç²˜è´´ä½ å’Œå¥³ç”Ÿçš„èŠå¤©è®°å½•ï¼ˆæ— è®ºæ˜¯æ¨¡æ‹Ÿæˆ˜è¿˜æ˜¯ç°å®èŠå¤©ï¼‰ã€‚\nç³»ç»Ÿå°†åˆ†æä½ çš„è¯æœ¯æ¼æ´ã€éœ€æ±‚æ„Ÿæš´éœ²ç‚¹ï¼Œå¹¶ç»™å‡ºä¼˜åŒ–å»ºè®®ã€‚');
                // 3. ä¿®æ”¹æŒ‰é’® (å˜ä¸ºçº¢è‰²è¾¹æ¡†ï¼Œå›¾æ ‡å˜ä¸ºæœç´¢/åˆ†æ)
                $btn.html('<i class="bi bi-search"></i> ANALYZE CHAT')
                    .removeClass('btn-tech') // ç§»é™¤é»˜è®¤é’è‰²æ ·å¼
                    .addClass('btn-outline-danger'); // åŠ ä¸Šçº¢è‰²æ ·å¼
            } else {
                // --- [æ¨¡å¼ï¼šå­¦ä¹ /å·¥ä½œ] ---
                $('.main-title')
                    .text('SOLO LEVELING')
                    .css({
                        'color': '#00f3ff',
                        'text-shadow': '0 0 20px rgba(0, 243, 255, 0.6)'
                    });
                $('#system-version-label').text('LOVE SYSTEM // VER 3.8');
                // 1. ä¿®æ”¹æ ‡é¢˜ (å¸¦ä»£ç å›¾æ ‡)
                $label.html('<i class="bi bi-terminal text-info"></i> UPLOAD WORK LOG (å·¥ä½œæ—¥å¿—)');

                // 2. ä¿®æ”¹æç¤ºæ–‡æ¡ˆ
                $input.attr('placeholder',
                    'ã€ç³»ç»Ÿç»“ç®—æ¨¡å¼ã€‘\n' +
                    'åœ¨æ­¤è¾“å…¥ä½ çš„ä»£ç ç‰‡æ®µã€å­¦ä¹ å¿ƒå¾—ã€é‡åˆ°çš„ Bug æˆ–ä»Šæ—¥å®Œæˆçš„äº‹é¡¹ã€‚\n' +
                    'ç³»ç»Ÿå°†è¯„ä¼°ä½ çš„å·¥ä½œé‡ï¼Œç»™äºˆ EXP å’Œ é‡‘å¸ å¥–åŠ±ã€‚'
                );

                // 3. ä¿®æ”¹æŒ‰é’® (æ¢å¤é»˜è®¤é’è‰²æ ·å¼ï¼Œå›¾æ ‡ä¸ºä¸Šä¼ )
                $btn.html('<i class="bi bi-upload"></i> UPLOAD DATA')
                    .removeClass('btn-outline-danger') // ç§»é™¤çº¢è‰²æ ·å¼
                    .addClass('btn-tech'); // æ¢å¤é’è‰²æ ·å¼
                // ã€ä¿®æ”¹ã€‘æ›´æ–°å·¦ä¾§é¢æ¿çš„èŒä¸š
                if ($jobLabel.length) $jobLabel.text(`LV.${currentLevel} TECHNOMANCER`);
            }
            // --- æ¢å¤ç»ˆç«¯æ—¥å¿— (ä¿®æ”¹ç‚¹) ---
            // å¦‚æœæœ‰å†å²æ—¥å¿—ï¼Œç›´æ¥æ˜¾ç¤ºï¼Œä¸è¦ typeWriter (å¤ªæ…¢)ï¼Œåªæœ‰æ–°æ¶ˆæ¯æ‰ typeWriter
            if (state.terminalLog) {
                $('#ai-response').html(state.terminalLog);
            } else {
                $('#ai-response').html(`<span class="text-white-50">> System initialized.<br>> Waiting for user input...</span>`);
            }


            // æ•°æ®å®¹é”™å¤„ç†
            if (!state.stats) state.stats = { str: 10, int: 10, sen: 10, vit: 10 };
            if (state.ap === undefined) state.ap = 0;

            // 3. æ›´æ–°åŸºç¡€æ•°å€¼ (HP/MP/EXP)
            state.hp = Math.max(0, Math.min(100, state.hp));
            state.mp = Math.max(0, Math.min(100, state.mp));

            $('#hp-bar').css('width', state.hp + '%');
            $('#hp-text').text(`HP: ${state.hp} / 100`);
            $('#mp-bar').css('width', state.mp + '%');
            $('#mp-text').text(`MP: ${state.mp} / 100`);

            // æ›´æ–°ç»éªŒæ¡
            $('.progress-fill.exp').css('width', currentExpPercent + '%');
            $('#level-display').text(`LV.${currentLevel}  [ ${currentExpPercent}% ]`);

            // 4. åŠ¨æ€æ¸²æŸ“å±æ€§é¢æ¿ (Stats)
            const statLabels = currentMode === 'dating'
                ? { title: "ATTRIBUTES (é­…åŠ›)", str: "é¢œå€¼", int: "è°ˆå", sen: "æƒ…ç»ª", vit: "å¿ƒæ€" }
                : { title: "ATTRIBUTES (èƒ½åŠ›)", str: "æ‰§è¡Œ", int: "æ™ºåŠ›", sen: "æ„ŸçŸ¥", vit: "æ´»åŠ›" };

            let statsContainer = $('#stats-container');
            if (statsContainer.length === 0) {
                $('.tech-panel:first .tech-deco-line').before('<div id="stats-container" class="mb-3 pt-3 border-top border-secondary"></div>');
                statsContainer = $('#stats-container');
            }

            const canUpgrade = state.ap > 0;
            const apBadge = canUpgrade ? `<span class="badge bg-warning text-dark blink-slow ms-2">AP: ${state.ap}</span>` : '';

            statsContainer.html(`
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small text-info"><i class="bi bi-cpu"></i> ${statLabels.title}</span>
                    ${apBadge}
                </div>
                <div class="row g-2 small font-monospace">
                    <div class="col-6 d-flex justify-content-between align-items-center">
                        <span class="text-white-50">${statLabels.str}:</span> <span class="text-white">${state.stats.str}</span>
                        ${canUpgrade ? `<i class="bi bi-plus-square-fill text-warning cursor-pointer btn-add-stat" data-stat="str"></i>` : ''}
                    </div>
                    <div class="col-6 d-flex justify-content-between align-items-center">
                        <span class="text-white-50">${statLabels.int}:</span> <span class="text-white">${state.stats.int}</span>
                        ${canUpgrade ? `<i class="bi bi-plus-square-fill text-warning cursor-pointer btn-add-stat" data-stat="int"></i>` : ''}
                    </div>
                    <div class="col-6 d-flex justify-content-between align-items-center">
                        <span class="text-white-50">${statLabels.sen}:</span> <span class="text-white">${state.stats.sen}</span>
                        ${canUpgrade ? `<i class="bi bi-plus-square-fill text-warning cursor-pointer btn-add-stat" data-stat="sen"></i>` : ''}
                    </div>
                    <div class="col-6 d-flex justify-content-between align-items-center">
                        <span class="text-white-50">${statLabels.vit}:</span> <span class="text-white">${state.stats.vit}</span>
                        ${canUpgrade ? `<i class="bi bi-plus-square-fill text-warning cursor-pointer btn-add-stat" data-stat="vit"></i>` : ''}
                    </div>
                </div>
            `);

            // 5. æ¸²æŸ“æŠ€èƒ½æ ‘ (ä¿æŒåŸæœ‰é€»è¾‘)
            const skillList = $('#skill-list');
            skillList.empty();

            if (state.skills.length === 0) {
                skillList.html('<div class="text-center text-muted small my-3">æš‚æ— æŠ€èƒ½ï¼Œè¯·æ·»åŠ èŒä¸šæ–¹å‘</div>');
            } else {
                state.skills.forEach((item, groupIndex) => {
                    if (item.theme && item.children) {
                        const isGroupAllEnabled = item.children.every(child => child.enabled !== false);
                        const groupHtml = `
                            <div class="skill-group mb-2">
                                <div class="d-flex justify-content-between align-items-center p-2 mb-1" style="background: rgba(0, 243, 255, 0.15); border-left: 3px solid var(--primary-color);">
                                    <div class="d-flex align-items-center">
                                        <div class="form-check form-switch me-2" style="min-height: 0;">
                                            <input class="form-check-input btn-toggle-group" type="checkbox" data-group-index="${groupIndex}" ${isGroupAllEnabled ? 'checked' : ''} style="cursor: pointer; border-color: var(--primary-color);">
                                        </div>
                                        <span class="fw-bold text-info"><i class="bi bi-folder2-open me-2"></i>${item.theme}</span>
                                    </div>
                                    <i class="bi bi-trash3 text-danger cursor-pointer btn-delete-group opacity-50" data-group-index="${groupIndex}" title="åˆ é™¤æ•´ä¸ªä¸»é¢˜"></i>
                                </div>
                                <div class="ps-3 border-start border-secondary ms-2">
                                    ${item.children.map((skill, childIndex) => {
                            const isLocked = skill.level === "LOCKED";
                            const isEnabled = !isLocked && skill.enabled !== false;
                            const disabledAttr = isLocked ? 'disabled' : '';
                            const badgeClass = isLocked ? "border-secondary text-secondary" : "border-info text-info";
                            const icon = isLocked ? '<i class="bi bi-lock-fill me-2"></i>' : '<i class="bi bi-check-circle-fill text-info me-2"></i>';
                            const opacityStyle = isEnabled ? "" : "opacity: 0.4;";
                            return `
                                            <div class="d-flex justify-content-between align-items-center p-1 mb-1 group-hover-parent" style="${opacityStyle}">
                                                <span class="text-wrap small" style="word-break: break-word; flex: 1; padding-right: 5px;">${icon} ${skill.name}</span> 
                                                <div class="d-flex align-items-center flex-shrink-0">
                                                    <div class="form-check form-switch me-2" style="min-height: 0;">
                                                        <input class="form-check-input btn-toggle-skill" type="checkbox" data-group-index="${groupIndex}" data-child-index="${childIndex}" ${isEnabled ? 'checked' : ''} ${disabledAttr} style="cursor: pointer;">
                                                    </div>
                                                    <span class="badge border bg-transparent ${badgeClass} me-1" style="font-size: 0.7rem;">${skill.level}</span>
                                                    <i class="bi bi-x-lg text-danger cursor-pointer btn-delete-skill" data-group-index="${groupIndex}" data-child-index="${childIndex}" style="font-size: 0.8rem; opacity: 0.5;"></i>
                                                </div>
                                            </div>
                                        `;
                        }).join('')}
                                </div>
                            </div>
                        `;
                        skillList.append(groupHtml);
                    }
                });
            }

            // 6. æ¸²æŸ“ä»»åŠ¡æ—¥å¿— (ä¿æŒåŸæœ‰é€»è¾‘)
            const questList = $('#quest-list');
            questList.empty();

            if (state.quests.length === 0) {
                questList.html('<div class="text-white-50 text-center py-5">NO ACTIVE MISSIONS<br><small class="text-muted">Standby for orders...</small></div>');
            } else {
                state.quests.slice().reverse().forEach((quest, reversedIndex) => {
                    const originalIndex = state.quests.length - 1 - reversedIndex;
                    const questId = "ID" + String(originalIndex).padStart(2, '0');
                    const isCompleted = quest.status === "COMPLETED";
                    const isFailed = quest.status === "FAILED";
                    const isInProgress = quest.status === "IN PROGRESS";

                    let borderColor = '#ffbd00';
                    let icon = 'bi-crosshair';
                    let statusClass = 'text-warning';

                    if (isCompleted) { borderColor = '#198754'; icon = 'bi-check-all'; statusClass = 'text-success'; }
                    else if (isFailed) { borderColor = '#ff2a6d'; icon = 'bi-x-octagon'; statusClass = 'text-danger'; }

                    // ğŸ”¥ ä¿®æ”¹ï¼šç»™ span åŠ ä¸€ä¸ª class="live-timer" å’Œ data-deadline
                    let durationBadge = '';
                    if (isInProgress) {
                        // å¦‚æœæ˜¯è€å­˜æ¡£æ²¡æœ‰ deadlineï¼Œå°±é»˜è®¤ç»™ä¸ªæ˜¾ç¤º
                        const deadlineAttr = quest.deadline ? `data-deadline="${quest.deadline}"` : '';
                        const initialText = quest.deadline ? formatCountDown(quest.deadline - Date.now()) : (quest.duration || "è¿›è¡Œä¸­");

                        durationBadge = `<span class="badge bg-dark border border-secondary text-info ms-2 live-timer" ${deadlineAttr} style="font-size: 0.75rem; font-family: monospace;">
                            <i class="bi bi-alarm"></i> <span class="timer-text">${initialText}</span>
                        </span>`;
                    }
                    let btnContainer = '';
                    if (isInProgress) {
                        let btns = `
                            <button class="btn btn-sm btn-outline-info border-0 py-0 px-2 ms-2 btn-help-quest" data-index="${originalIndex}"><i class="bi bi-life-preserver"></i> è¾…å¯¼</button>
                            <button class="btn btn-sm btn-outline-danger border-0 py-0 px-2 ms-1 btn-abandon-quest" data-index="${originalIndex}"><i class="bi bi-trash3-fill"></i></button>
                        `;
                        if (quest.guidance) btns = `<button class="btn btn-sm btn-outline-primary border-0 py-0 px-2 ms-2 btn-view-guidance" data-index="${originalIndex}" title="æŸ¥çœ‹è¾…å¯¼"><i class="bi bi-eye-fill"></i></button>` + btns;
                        btnContainer = `<div class="d-flex align-items-center">${btns}</div>`;
                    } else {
                        let btns = '';
                        if (quest.guidance) btns += `<button class="btn btn-sm btn-outline-secondary border-0 py-0 px-2 ms-2 btn-view-guidance" data-index="${originalIndex}" title="æŸ¥çœ‹è¾…å¯¼"><i class="bi bi-eye-fill"></i></button>`;
                        if (isCompleted && quest.archive) {
                            btns += `<button class="btn btn-sm btn-outline-success border-0 py-0 px-2 ms-2 btn-download-archive" data-index="${originalIndex}" title="ä¸‹è½½å½’æ¡£è®°å½•"><i class="bi bi-file-earmark-arrow-down-fill"></i></button>`;
                        }
                        btnContainer = `<div class="d-flex align-items-center">${btns}</div>`;
                    }

                    let rewardInfo = '';
                    if (isInProgress && quest.rewards) {
                        rewardInfo = `<div class="mt-2 pt-2 border-top border-secondary text-white-50" style="font-size: 0.75rem;"><i class="bi bi-gift-fill text-info"></i> <span class="text-info">é¢„æœŸ:</span> ${quest.rewards}</div>`;
                    } else if ((isCompleted || isFailed) && quest.outcome) {
                        const outcomeColor = isCompleted ? 'text-success' : 'text-danger';
                        rewardInfo = `<div class="mt-2 pt-2 border-top border-secondary text-white-50" style="font-size: 0.75rem;"><i class="bi bi-clipboard-data-fill ${outcomeColor}"></i> <span class="${outcomeColor}">ç»“ç®—:</span> ${quest.outcome}</div>`;
                    }

                    questList.append(`
                        <div class="quest-card p-3 mb-3" data-index="${originalIndex}" data-quest-id="${questId}" style="background: rgba(0,0,0,0.3); border-left: 3px solid ${borderColor}; margin-bottom: 10px; position: relative;">
                            <div class="d-flex justify-content-between mb-1 align-items-center">
                                <div>
                                    <span class="text-white fw-bold me-2 font-monospace bg-dark px-1 border border-secondary" style="font-size: 0.8rem;">${questId}</span>
                                    <span class="text-warning small" style="font-family: var(--tech-font)">[${quest.rank}]</span>
                                    ${durationBadge}
                                </div>
                                <div class="d-flex align-items-center"><span class="${statusClass} small fw-bold"><i class="bi ${icon}"></i> ${quest.status}</span>${btnContainer}</div>
                            </div>
                            <div class="quest-content text-white small mt-2" style="line-height: 1.4;">${quest.content}</div>
                            ${rewardInfo}
                        </div>
                    `);
                });
            }
        }
        function typeWriter(htmlContent, elementId) {
            let target = $(elementId);
            target.html('<span class="blink-fast" style="color:var(--primary-color)">> RECEIVING ENCRYPTED DATA...</span>');
            setTimeout(() => {
                target.hide().html(htmlContent).fadeIn(500);
            }, 800);
        }

        // ==========================================
        // â³ è¿›åº¦æ¡æ¨¡æ‹Ÿæ§åˆ¶å™¨
        // ==========================================
        let progressTimers = {}; // å­˜å‚¨æ¯ä¸ªæŒ‰é’®çš„å®šæ—¶å™¨ID

        function startProgress(btnId, loadingText = "Processing...") {
            if (!btnId) return;
            const $btn = $(btnId);

            // 1. ç¦ç”¨æŒ‰é’®
            $btn.prop('disabled', true);

            // --- å…³é”®ä¿®æ”¹ Aï¼šåˆå§‹åŒ– HTML ç»“æ„ ---
            // æˆ‘ä»¬ç»™æ•°å­—éƒ¨åˆ†åŠ ä¸€ä¸ª class="progress-num"ï¼Œæ–¹ä¾¿åé¢å•ç‹¬æ‰¾å®ƒ
            $btn.html(`
                <span class="spinner-border spinner-border-sm me-2"></span> 
                ${loadingText} 
                <span class="progress-num font-monospace">0.0%</span>
            `);

            // 2. åˆå§‹åŒ–è¿›åº¦
            let percent = 0;

            // 3. å®šä¹‰æ›´æ–°é€»è¾‘
            const updateBtn = () => {
                // è¿›åº¦å¢é•¿é€»è¾‘ (ä¿æŒä¸å˜)
                let increment = 0;
                if (percent < 30) increment = 5;
                else if (percent < 70) increment = 2;
                else if (percent < 90) increment = 1;
                else if (percent < 99) increment = 0.1;

                percent = Math.min(99, percent + increment);

                // --- å…³é”®ä¿®æ”¹ Bï¼šåªæ›´æ–°æ•°å­—æ–‡å­—ï¼Œä¸åŠ¨ HTML ç»“æ„ ---
                // ä½¿ç”¨ .find() æ‰¾åˆ°åˆšæ‰å®šä¹‰çš„ .progress-numï¼Œåªæ”¹å®ƒçš„ text
                $btn.find('.progress-num').text(percent.toFixed(1) + '%');
            };

            // ç«‹å³æ‰§è¡Œä¸€æ¬¡
            updateBtn();

            // 4. å¯åŠ¨å®šæ—¶å™¨
            if (progressTimers[btnId]) clearInterval(progressTimers[btnId]);
            progressTimers[btnId] = setInterval(updateBtn, 100);
        }

        function stopProgress(btnId, originalText) {
            if (!btnId) return;
            const $btn = $(btnId);

            // 1. æ¸…é™¤å®šæ—¶å™¨
            if (progressTimers[btnId]) {
                clearInterval(progressTimers[btnId]);
                delete progressTimers[btnId];
            }

            // 2. ç¬é—´æ˜¾ç¤º 100% (è§†è§‰çˆ½æ„Ÿ)
            $btn.html(`<i class="bi bi-check-circle-fill"></i> DONE 100%`);

            // 3. å»¶è¿Ÿä¸€å°ä¼šå„¿åæ¢å¤åŸå§‹æŒ‰é’®çŠ¶æ€
            setTimeout(() => {
                $btn.prop('disabled', false).html(originalText);
            }, 600); // 0.6ç§’åæ¢å¤ï¼Œè®©ç”¨æˆ·çœ‹åˆ° "DONE"
        }

        function callDeepSeek(actionType, userContent, btnId) {
            const btn = $(btnId);
            const originalText = btn ? btn.html() : "";

            // 1. è·å–æœ€æ–°çŠ¶æ€å’Œå½“å‰æ¨¡å¼
            const gameState = loadState();
            const mode = (typeof currentMode !== 'undefined') ? currentMode : 'dating';

            // ğŸ”´ è¯·ç¡®ä¿æ­¤å¤„ Key æ­£ç¡®
            if (!API_KEY || API_KEY.includes("sk-xxx") || API_KEY.length < 10) {
                alert("âŒ API Key æ— æ•ˆï¼Œè¯·æ£€æŸ¥ä»£ç ã€‚"); return;
            }
            // --- æ–°çš„ä»£ç  (æ¥å…¥æ¨¡æ‹Ÿè¿›åº¦) ---
            if (btnId) startProgress(btnId, "LINKING...");
            // 2. æ¨¡æ‹Ÿæˆ˜ç‰¹æ®Šé€»è¾‘é€šé“
            if (actionType === 'SIMULATION') {
                handleSimulation(userContent, btn, originalText);
                return;
            }
            // --- 2. ä¸Šä¸‹æ–‡å‡†å¤‡ï¼šæŠ€èƒ½åˆ—è¡¨ ---
            // è¿‡æ»¤å‡ºæ‰€æœ‰éç¦ç”¨çš„æŠ€èƒ½ï¼Œç”¨äº AI å†³ç­–
            const activeSkills = gameState.skills.flatMap(group => {
                if (!group.children) return [];
                return group.children
                    .filter(child => child.enabled !== false)
                    .map(child => {
                        const status = child.level === "LOCKED" ? "ã€å¾…è§£é”ã€‘" : child.level;
                        // ä¸ºäº†è®© AI æ›´å¥½è¯†åˆ«ï¼Œå­¦ä¹ æ¨¡å¼ä¸‹å¸¦ä¸Šä¸»é¢˜
                        return mode === 'dating'
                            ? `${child.name} (${status})`
                            : `[${group.theme}] ${child.name} (${status})`;
                    });
            });

            const skillContext = activeSkills.length > 0 ? JSON.stringify(activeSkills) : "EMPTY_POOL";

            // --- 3. ä¸Šä¸‹æ–‡å‡†å¤‡ï¼šè·å–ä»»åŠ¡å†å² ---
            const recentQuestHistory = gameState.quests.slice(-5).map(q => {
                return q.content.replace(/<[^>]+>/g, "").substring(0, 50);
            });

            // æå–ä»»åŠ¡å†…å®¹ (ç”¨äº REPORT/HELP)
            const targetQuestIndex = $(btnId).data('selected-quest-index') ?? $(btnId).data('index');
            let targetQuestContent = (targetQuestIndex !== undefined && gameState.quests[targetQuestIndex])
                ? gameState.quests[targetQuestIndex].content
                : "æ— ";

            // å¦‚æœæ˜¯æ±‚åŠ©æˆ–ç»“ç®—ï¼Œå¿…é¡»æå–é€‰ä¸­çš„ä»»åŠ¡å¡ç‰‡å†…å®¹
            if ((actionType === 'REPORT' || actionType === 'HELP') || $(btnId).hasClass('btn-help-quest')) {
                // ä¼˜å…ˆä½¿ç”¨æŒ‰é’®ä¸Šä¼ é€’çš„ index (ç”¨äºè¾…å¯¼æŒ‰é’®)
                let idx = $(btnId).data('index');
                // å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨å…¨å±€é€‰ä¸­çš„ index (ç”¨äºç»“ç®—æŒ‰é’®)
                if (idx === undefined) idx = targetQuestIndex;

                if (idx !== undefined && gameState.quests[idx]) {
                    targetQuestContent = gameState.quests[idx].content;
                }
            }

            // --- 5. æ ¸å¿ƒ Prompt è®¾è®¡ (æ ¹æ®ä½ çš„è¦æ±‚é‡å†™) ---

            // é€šç”¨æ’ç‰ˆè§„åˆ™
            const FORMAT_INSTRUCTIONS = `
    ã€æ’ç‰ˆä¸¥æ ¼è¦æ±‚ã€‘
    1. **ç»“æ„æ¸…æ™°**: ä½¿ç”¨ HTML æ ‡ç­¾ <br> è¿›è¡Œæ¢è¡Œï¼Œä½¿ç”¨ <b> åŠ ç²—å…³é”®ç‚¹ã€‚
    2. **åˆ—è¡¨æ ¼å¼**: æ­¥éª¤æˆ–è¦ç‚¹å¿…é¡»ä½¿ç”¨ "1. ", "2. " æˆ– "â€¢ " å¼€å¤´ï¼Œå¹¶å¼ºåˆ¶æ¢è¡Œã€‚
    3. **æ‹’ç»é•¿æ–‡**: ä¸è¦è¾“å‡ºä¸€å¤§æ®µä¸æ¢è¡Œçš„æ–‡å­—ï¼Œå¿…é¡»åˆ†æ®µã€‚
    4. é‡ç‚¹è¯æ±‡é«˜äº®æ˜¾ç¤ºã€‚
    `;

            // æ¨¡å¼å·®å¼‚åŒ–è§„åˆ™
            const MODE_RULES = mode === 'dating'
                ? `
    ã€æ¨¡å¼: DATING (å¾ªåºæ¸è¿›)ã€‘
    - é€»è¾‘: ä¸¥æ ¼æŒ‰ç…§ç­‰çº§æ¨è¿›ã€‚ä¼˜å…ˆç”Ÿæˆé’ˆå¯¹ "ã€å¾…è§£é”ã€‘" æŠ€èƒ½çš„å…¥é—¨ä»»åŠ¡ã€‚
    - é£æ ¼: çº¦ä¼šæ•™ç»ƒï¼Œé«˜æƒ…å•†ï¼Œæˆ˜æœ¯åŒ–ã€‚
    `
                : `
    ã€æ¨¡å¼: LEARNING (éšæœºæŠ½æŸ¥)ã€‘
    - é€»è¾‘: **çœŸéšæœºæ¨¡å¼**ã€‚å¿½ç•¥ç­‰çº§é¡ºåºã€‚åœ¨æ‰€æœ‰å·²è§£é”çš„æŠ€èƒ½ä¸­ï¼Œ**éšæœº**æŒ‘é€‰ä¸€ä¸ªæŠ€èƒ½ç‚¹ç”Ÿæˆå®æˆ˜ä»»åŠ¡ï¼Œæ¨¡æ‹Ÿå·¥ä½œä¸­ä¸å¯é¢„æµ‹çš„éœ€æ±‚ã€‚
    - ç‰¹ä¾‹: å¦‚æœå­˜åœ¨ "ã€å¾…è§£é”ã€‘" æŠ€èƒ½ï¼Œä»æœ‰ 50% æ¦‚ç‡ä¼˜å…ˆç”Ÿæˆè§£é”ä»»åŠ¡ã€‚
    - é£æ ¼: æå®¢ç³»ç»Ÿï¼Œå†·é…·ï¼Œæ•ˆç‡è‡³ä¸Šã€‚
    `;

            const SYSTEM_PROMPT = `
    ä½ æ˜¯ä¸€ä¸ªæ¸¸æˆåŒ–è‡ªæˆ‘æå‡ç³»ç»Ÿçš„æ ¸å¿ƒ AIã€‚è¯·ä¸¥æ ¼æ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤ã€‚

    ${FORMAT_INSTRUCTIONS}
    ${MODE_RULES}
    
    ã€ä»»åŠ¡ç­‰çº§å®šä¹‰æ ‡å‡† (å¿…é¡»ä¸¥æ ¼éµå®ˆ)ã€‘:
    - **E-RANK (çäº‹)**: <15åˆ†é’Ÿã€‚å¦‚ï¼šå–æ°´ã€å€’åƒåœ¾ã€ç®€å•çš„èƒŒå•è¯ã€æ•´ç†æ¡Œé¢ã€‚
    - **D-RANK (æ—¥å¸¸)**: 30-60åˆ†é’Ÿã€‚å¦‚ï¼šå¥èº«ä¸€èŠ‚è¯¾ã€å†™å®Œä½œä¸šçš„ä¸€ä¸ªå°èŠ‚ã€é˜…è¯»30é¡µä¹¦ã€‚
    - **C-RANK (å›°éš¾)**: 2-4å°æ—¶ã€‚å¦‚ï¼šå®Œæˆä¸€ä¸ªå®Œæ•´çš„ä»£ç åŠŸèƒ½æ¨¡å—ã€å†™ä¸€ç¯‡å®Œæ•´çš„æ–‡ç« ã€æ·±åº¦å¤ä¹ ä¸€ç« ã€‚
    - **B-RANK (æŒ‘æˆ˜)**: >1å¤©ã€‚éœ€è¦å¤šæ­¥éª¤å®Œæˆçš„å¤æ‚é¡¹ç›®ã€‚
    - **A/S-RANK (å²è¯—)**: é•¿æœŸç›®æ ‡æˆ–æåº¦ç—›è‹¦çš„æŒ‘æˆ˜ã€‚

    ã€ç©å®¶å½“å‰çŠ¶æ€ã€‘
    - æ¨¡å¼: ${mode.toUpperCase()}
    - ç­‰çº§: LV.${Math.floor(gameState.exp / 100) + 1}
    - æŠ€èƒ½æ± : ${skillContext}
    - å†å²ä»»åŠ¡æ‘˜è¦: ${JSON.stringify(recentQuestHistory)}

    ã€å½“å‰æ“ä½œ: ${actionType}ã€‘
    - ç›®æ ‡ä»»åŠ¡å†…å®¹(ä»…é’ˆå¯¹REPORT/HELP): "${targetQuestContent}"
    - ç©å®¶è¾“å…¥: "${userContent}"

    ã€ä¸šåŠ¡é€»è¾‘ (å¿…é¡»éµå®ˆ)ã€‘:
    
    1. **REQUEST (ç”Ÿæˆæ–°ä»»åŠ¡)**:
       - **åé‡å¤æœºåˆ¶(æœ€é«˜ä¼˜å…ˆçº§)**: ä¸¥ç¦ç”Ÿæˆä¸[æœ€è¿‘5æ¬¡ä»»åŠ¡å†å²]ç›¸ä¼¼çš„ä»»åŠ¡ã€‚å¿…é¡»æ›´æ¢ä¸»é¢˜ã€æŠ€èƒ½ç‚¹æˆ–å½¢å¼ã€‚å¦‚æœä¸ç¡®å®šï¼Œè¯·ç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„ã€æ„æƒ³ä¸åˆ°çš„æŒ‘æˆ˜ã€‚
       - **é‡å¤ç‡æ§åˆ¶**: é‡å¤å› å­è¯·ä½äº30%ã€‚
       - å¿…é¡»åŸºäºæŠ€èƒ½æ± ç”Ÿæˆã€‚å¦‚æœæŠ€èƒ½æ± ä¸º EMPTY_POOLï¼Œæç¤ºç©å®¶å…ˆæ·»åŠ æŠ€èƒ½ã€‚
       - **å¿…é¡»åœ¨ä»»åŠ¡æè¿°çš„æœ€åä¸€è¡Œè¿½åŠ æäº¤è¦æ±‚**ã€‚æ ¼å¼ï¼š<br><br><span class="text-warning">[æäº¤è¦æ±‚]: å…·ä½“éœ€è¦æäº¤ä»€ä¹ˆ (å¦‚: ä»£ç æˆªå›¾ / è¿è¡ŒLog / èŠå¤©è®°å½•)</span>
       - ä»»åŠ¡å†…å®¹å¿…é¡»åŒ…å«: èƒŒæ™¯ã€å…·ä½“æ‰§è¡Œæ­¥éª¤(å¸¦åºå·)ã€é¢„æœŸç»“æœã€‚


    2. **CUSTOM_QUEST (è‡ªå®šä¹‰æ¸…å•)**:
       - ç”¨æˆ·è¾“å…¥äº†ä¸€ç»„å¾…åŠäº‹é¡¹ï¼ˆå¯èƒ½åŒ…å«æ¢è¡Œï¼‰ã€‚
       - è¯·æ‹†è§£æ¯ä¸€è¡Œï¼Œå°†å…¶è½¬åŒ–ä¸ºç‹¬ç«‹çš„ä»»åŠ¡å¡ç‰‡ã€‚
       - **æ™ºèƒ½è¯„çº§**: æ ¹æ®ä»»åŠ¡éš¾åº¦ï¼ˆå¦‚"èƒŒ1ä¸ªå•è¯"æ˜¯Eçº§ï¼Œ"å†™æ“ä½œç³»ç»Ÿ"æ˜¯Sçº§ï¼‰è‡ªåŠ¨åˆ†é… Rank å’Œ å¥–åŠ±ã€‚
       - è¿”å›æ ¼å¼å¿…é¡»åŒ…å« "custom_batch" æ•°ç»„ã€‚

    3. **HELP (è¾…å¯¼/æ±‚åŠ©)**:
       - **å¼ºç›¸å…³æ€§**: ä½ çš„å›å¤å¿…é¡»ç´§æ‰£ "${targetQuestContent}" è¿™ä¸ªä»»åŠ¡ã€‚ä¸è¦ç”Ÿæˆé€šç”¨çš„å»ºè®®ã€‚
       - å¦‚æœä»»åŠ¡æ˜¯å†™ä»£ç ï¼Œè¯·æä¾›æ€è·¯æˆ–ä¼ªä»£ç ï¼Œä¸è¦ç›´æ¥ç»™å®Œæ•´ç­”æ¡ˆã€‚
       - å¦‚æœä»»åŠ¡æ˜¯çº¦ä¼šï¼Œè¯·æä¾›å…·ä½“è¯æœ¯æˆ–å¿ƒç†å»ºè®¾ã€‚
       - æ’ç‰ˆ: åˆ†ç‚¹é™ˆè¿°ï¼Œæ¸…æ™°æ˜“è¯»ã€‚

    4. **REPORT (ç»“ç®—)**:
       - å¿…é¡»æ ¹æ®ç©å®¶æ—¥å¿—ä¸¥æ ¼æ‰“åˆ†ã€‚
       - åªæœ‰è¯„åˆ†é«˜æ—¶æ‰ç»™äºˆ EXP å’Œ å±æ€§å¥–åŠ±ã€‚
       - ç¦æ­¢åœ¨ REPORT é˜¶æ®µç”Ÿæˆ new_questã€‚
       - å¥–åŠ±Gold: Goldæ•°é‡æ ¹æ®éš¾åº¦(Eçº§-Sçº§)å‡ ä½•çº§ä¸Šæ¶¨

- ğŸ”¥    **[DATINGæ¨¡å¼ç‰¹æƒ - èŠå¤©è®°å½•å¤ç›˜]**: 
         å¦‚æœå½“å‰æ˜¯ DATING æ¨¡å¼ï¼Œä¸”ç©å®¶è¾“å…¥çœ‹èµ·æ¥åƒæ˜¯èŠå¤©è®°å½•ï¼ˆæˆ–è¯·æ±‚åˆ†æï¼‰ï¼š
         1. åŒ–èº« **"æ¯’èˆŒçº¦ä¼šæ•™ç»ƒ" (Hitch)**ã€‚
         2. åˆ†æç»´åº¦ï¼š**éœ€æ±‚æ„Ÿæš´éœ²**ã€**æ¡†æ¶å¼ºå¼±**ã€**æƒ…ç»ªä»·å€¼**ã€‚
         3. å¿…é¡»åœ¨ "archive_data" å­—æ®µä¸­è¿”å›ï¼š
            - "advice": ä½ çš„çŠ€åˆ©ç‚¹è¯„ï¼ˆæŒ‡å‡ºå“ªé‡Œåšé”™äº†ï¼‰ã€‚
            - "best_answer": **é€‰å–èŠå¤©ä¸­å‘æŒ¥æœ€å·®çš„ä¸€å¥ï¼Œç»™å‡ºã€é«˜æƒ…å•†ä¿®æ”¹ç‰ˆã€‘**ã€‚
         4. å¦‚æœèŠå¾—å¤ªçƒ‚ï¼Œè¯·ç»™å‡º D æˆ– E è¯„ä»·ï¼Œå¹¶æ‰£é™¤å°‘é‡å¥½æ„Ÿ(æ¨¡æ‹Ÿ)ã€‚

    5. **ADD_SKILL**: 
       - æç‚¼ç”¨æˆ·è¾“å…¥çš„èŒä¸šæˆ–æ–¹å‘ï¼Œç”Ÿæˆç»“æ„åŒ–çš„æŠ€èƒ½æ ‘ã€‚

    ã€è¾“å‡º JSON æ ¼å¼ã€‘:
    {
        "status": "SUCCESS" | "FAILURE",
        "comment": "ç®€çŸ­è¯„ä»· (æ”¯æŒHTMLæ ¼å¼)",
        "mentor_guidance": "è¾…å¯¼å†…å®¹ (æ”¯æŒä½¿ç”¨ <br> æ¢è¡Œï¼Œæ”¯æŒHTML)",
        "exp_gain": 0, 
        "gold_gain": 0,  // é‡‘å¸å¥–åŠ±
        "hp_change": 0, 
        "mp_change": 0,
        "stat_reward": { "str": 0, "int": 0, "sen": 0, "vit": 0 },
        // === ä»…åœ¨ REQUEST æ—¶è¿”å› ===
        "new_quest": "ä»»åŠ¡HTMLå†…å®¹ (å¿…é¡»åŒ…å«[æäº¤è¦æ±‚])", 
        // === ä»…åœ¨ CUSTOM_QUEST æ—¶è¿”å›æ­¤æ•°ç»„ ===
        "custom_batch": [
            {
                "content": "HTMLå†…å®¹ (å«[æäº¤è¦æ±‚])",
                "rank": "ä»»åŠ¡ç­‰çº§ (E~S),
                "rewards": "EXP+x",
                "duration": "Xåˆ†é’Ÿ/å°æ—¶/å¤©/å‘¨/æœˆ"
            },
            { ... }
        ],
        "new_quest_duration": "å»ºè®®æ—¶é•¿ (å¦‚ 2å°æ—¶)", 
        "new_quest_rewards": "é¢„æœŸå¥–åŠ±æè¿°",
        "quest_rank": "ä»»åŠ¡ç­‰çº§ (E~S)",
        "skill_update": { "name": "æŠ€èƒ½å", "level": "LV.x" },
        "new_skill_tree": { "theme": "ä¸»é¢˜", "child_skills": [] },
        // REPORT ä¸“ç”¨ (å¤ç›˜æ•°æ®å­˜è¿™é‡Œ)
        "archive_data": { 
            "score": "S/A/B/C/D/E", 
            "advice": "è¯¦ç»†åˆ†æ/å¤ç›˜å»ºè®®", 
            "best_answer": "é«˜æƒ…å•†ä¿®æ”¹ç¤ºèŒƒ / å‚è€ƒç­”æ¡ˆ" 
        },
    }
    `;

            // --- 6. å‘é€è¯·æ±‚ ---
            $.ajax({
                url: "https://api.deepseek.com/chat/completions",
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + API_KEY
                },
                data: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        { role: "system", content: SYSTEM_PROMPT },
                        { role: "user", content: userContent }
                    ],
                    temperature: 1.1, // ä¿æŒè¾ƒé«˜æ¸©åº¦ä»¥è·å¾—æ›´æœ‰è¶£çš„ç‚¹è¯„
                    response_format: { type: 'json_object' }
                }),
                success: function (response) {
                    if (btnId) stopProgress(btnId, originalText);
                    try {
                        const data = JSON.parse(response.choices[0].message.content);

                        // --- æ•°æ®æ¸…æ´— ---
                        const formatHTML = (text) => {
                            if (!text) return "";
                            let html = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                            if (!html.includes('<br>') && !html.includes('<p>')) {
                                html = html.replace(/\n/g, '<br>');
                            }
                            return html;
                        };

                        if (data.mentor_guidance) data.mentor_guidance = formatHTML(data.mentor_guidance);
                        if (data.comment) data.comment = formatHTML(data.comment);
                        if (data.new_quest) data.new_quest = formatHTML(data.new_quest);

                        // A. HELP å¤„ç†
                        if (actionType === 'HELP' && data.mentor_guidance) {
                            const btnIndex = $(btnId).data('index');
                            if (btnIndex !== undefined) {
                                gameState.quests[btnIndex].guidance = data.mentor_guidance;
                                $('#mentor-panel').show().data('viewing-index', btnIndex);
                                typeWriter(data.mentor_guidance, '#mentor-content');
                                return;
                            }
                        }

                        // B. ADD_SKILL å¤„ç†
                        if (data.new_skill_tree && data.new_skill_tree.theme) {
                            const themeName = data.new_skill_tree.theme;
                            const existingTheme = gameState.skills.find(s => s.theme === themeName);
                            const processedChildren = data.new_skill_tree.child_skills.map(s => {
                                let sName = (typeof s === 'object') ? s.name : s;
                                let sLevel = (typeof s === 'object' && s.level) ? s.level : "LOCKED";
                                return { name: sName, level: sLevel, enabled: true };
                            });

                            if (!existingTheme) {
                                gameState.skills.push({ theme: themeName, children: processedChildren });
                            } else {
                                processedChildren.forEach(newSub => {
                                    if (!existingTheme.children.some(c => c.name === newSub.name)) existingTheme.children.push(newSub);
                                });
                            }
                        }

                        // C. REPORT å¤„ç† (å«èŠå¤©å¤ç›˜æ˜¾ç¤ºé€»è¾‘)
                        if (actionType === 'REPORT') {
                            // 1. å¦‚æœå…³è”äº†å…·ä½“ä»»åŠ¡
                            if (targetQuestIndex !== undefined && gameState.quests[targetQuestIndex]) {
                                const quest = gameState.quests[targetQuestIndex];
                                if (quest.status === 'IN PROGRESS') {
                                    if (data.status === 'SUCCESS') quest.status = 'COMPLETED';
                                    if (data.status === 'FAILURE') quest.status = 'FAILED';

                                    let outcomeParts = [];
                                    if (data.exp_gain) outcomeParts.push(`EXP +${data.exp_gain}`);
                                    if (data.gold_gain) outcomeParts.push(`GOLD +${data.gold_gain}`);
                                    quest.outcome = outcomeParts.length > 0 ? outcomeParts.join(', ') : "ç»“ç®—å®Œæ¯•";
                                    quest.user_answer = userContent.replace("ç©å®¶æäº¤æ—¥å¿—: ", "");

                                    if (data.archive_data) {
                                        quest.archive = data.archive_data;
                                    } else {
                                        quest.archive = {
                                            score: data.status === 'SUCCESS' ? 'A' : 'C',
                                            advice: data.comment || "æ— è¯¦ç»†å»ºè®®",
                                            best_answer: "æ— "
                                        };
                                    }
                                }
                            }
                            // ğŸ”¥ 2. [æ–°å¢] å¦‚æœæ˜¯è‡ªç”±å¤ç›˜ (æ²¡é€‰ä»»åŠ¡)ï¼Œç›´æ¥æŠŠå¤ç›˜ç»“æœå±•ç¤ºåœ¨ Comment é‡Œ
                            else if (mode === 'dating' && data.archive_data) {
                                const reviewHtml = `
                            <div class="mt-2 border-top border-secondary pt-2 text-start">
                                <div class="text-warning fw-bold mb-1"><i class="bi bi-search"></i> æ·±åº¦æˆ˜æœ¯å¤ç›˜ (è¯„åˆ†: ${data.archive_data.score})</div>
                                <div class="small text-white-50 mb-2" style="line-height:1.4;">${data.archive_data.advice}</div>
                                <div class="p-2 rounded" style="background:rgba(25, 135, 84, 0.1); border:1px solid #198754;">
                                    <strong class="text-success small"><i class="bi bi-lightbulb-fill"></i> é«˜æƒ…å•†ä¼˜åŒ–:</strong><br>
                                    <span class="text-white small fst-italic">"${data.archive_data.best_answer}"</span>
                                </div>
                            </div>
                        `;
                                data.comment += reviewHtml;
                            }
                        }

                        // D. ABANDON å¤„ç†
                        if (actionType === 'ABANDON') {
                            const abandonIndex = $(btnId).data('index');
                            if (abandonIndex !== undefined && gameState.quests[abandonIndex]) {
                                gameState.quests[abandonIndex].status = 'FAILED';
                                gameState.quests[abandonIndex].outcome = "ä»»åŠ¡æ”¾å¼ƒ";
                            }
                        }

                        // E. CUSTOM_QUEST å¤„ç†
                        if (actionType === 'CUSTOM_QUEST' && data.custom_batch && Array.isArray(data.custom_batch)) {
                            data.custom_batch.forEach(item => {
                                const durationMs = parseDurationToMs(item.duration || "2å°æ—¶");
                                gameState.quests.push({
                                    rank: item.rank || "E-RANK",
                                    content: item.content,
                                    duration: item.duration || "è‡ªå®š",
                                    deadline: Date.now() + durationMs,
                                    rewards: item.rewards || "EXP +10",
                                    status: "IN PROGRESS"
                                });
                            });
                            $('#quest-list').animate({ scrollTop: $('#quest-list')[0].scrollHeight }, 1000);
                        }

                        // F. REQUEST å¤„ç†
                        if (actionType === 'REQUEST' && data.new_quest) {
                            let finalContent = data.new_quest;
                            if (skillContext === "EMPTY_POOL" && finalContent.includes("é€šç”¨")) {
                                finalContent = "ç³»ç»Ÿæ£€æµ‹åˆ°æŠ€èƒ½æ± ä¸ºç©ºã€‚è¯·å…ˆåœ¨å·¦ä¾§è¾“å…¥èŒä¸šæ–¹å‘å¹¶ç”ŸæˆæŠ€èƒ½æ ‘ã€‚";
                            }
                            const durationStr = data.new_quest_duration || "2å°æ—¶";
                            const durationMs = parseDurationToMs(durationStr);
                            gameState.quests.push({
                                rank: data.quest_rank || "E-RANK",
                                content: finalContent,
                                duration: durationStr,
                                deadline: Date.now() + durationMs,
                                rewards: data.new_quest_rewards || "EXP +10",
                                status: "IN PROGRESS"
                            });
                        }

                        // G. SKILL_UPDATE å¤„ç†
                        if (data.skill_update && data.skill_update.name) {
                            const targetName = data.skill_update.name.trim();
                            const newLevelStr = data.skill_update.level;
                            const parseLevel = (str) => {
                                if (!str || str === "LOCKED") return 0;
                                const match = str.match(/\d+/);
                                return match ? parseInt(match[0]) : 0;
                            };
                            const newLevelNum = parseLevel(newLevelStr);

                            gameState.skills.forEach(group => {
                                if (group.children) {
                                    const subSkill = group.children.find(s => targetName.includes(s.name) || s.name.includes(targetName));
                                    if (subSkill) {
                                        const oldLevelNum = parseLevel(subSkill.level);
                                        if (newLevelNum > oldLevelNum) {
                                            if (subSkill.level === "LOCKED") {
                                                subSkill.enabled = true;
                                                alert(`ğŸ”“ SKILL UNLOCKED: ã€${subSkill.name}ã€‘`);
                                            }
                                            subSkill.level = newLevelStr;
                                        }
                                    }
                                }
                            });
                        }

                        // H. å…¨å±€æ•°å€¼æ›´æ–°
                        const oldLevel = Math.floor(gameState.exp / 100) + 1;
                        gameState.exp += (data.exp_gain || 0);
                        gameState.gold = (gameState.gold || 0) + (data.gold_gain || 0);
                        const newLevel = Math.floor(gameState.exp / 100) + 1;

                        if (newLevel > oldLevel) {
                            gameState.ap = (gameState.ap || 0) + (newLevel - oldLevel) * 3;
                            alert(`ğŸ‰ LEVEL UP! LV.${newLevel}`);
                        }

                        gameState.hp = Math.min(100, Math.max(0, gameState.hp + (data.hp_change || 0)));
                        gameState.mp = Math.min(100, Math.max(0, gameState.mp + (data.mp_change || 0)));

                        if (data.stat_reward) {
                            ['str', 'int', 'sen', 'vit'].forEach(k => {
                                if (data.stat_reward[k]) gameState.stats[k] += data.stat_reward[k];
                            });
                        }

                        // ä¿å­˜ä¸æ¸²æŸ“
                        saveState(gameState);
                        renderUI(gameState);

                        // I. ç»ˆç«¯æ˜¾ç¤º
                        if (actionType !== 'HELP') {
                            const colorClass = data.status === 'SUCCESS' ? 'text-success' : 'text-danger';
                            const newLogHtml = `<div class="mb-2"><span class="${colorClass} fw-bold">[ ${data.status} ]</span> ${data.comment}</div>`;
                            typeWriter(newLogHtml, "#ai-response");

                            if (!gameState.terminalLog) gameState.terminalLog = "";
                            gameState.terminalLog += newLogHtml;
                            saveState(gameState);

                            // è§†è§‰åé¦ˆ
                            if (typeof mesh1 !== 'undefined') {
                                mesh1.material.color.setHex(data.status === 'SUCCESS' ? 0x00ff00 : 0xff2a6d);
                                setTimeout(() => {
                                    const defColor = mode === 'dating' ? 0xff5c8d : 0x00f3ff;
                                    mesh1.material.color.setHex(defColor);
                                }, 2000);
                            }
                        }

                    } catch (e) {
                        console.error("è§£æé”™è¯¯:", e);
                        $('#ai-response').html(`<span class="text-danger">SYSTEM ERROR: æ•°æ®è§£æå¤±è´¥ã€‚<br>${e.message}</span>`);
                    }
                },
                error: function (xhr) {
                    if (btnId) stopProgress(btnId, originalText);
                    $('#ai-response').html(`<span class="text-danger blink-fast">âš ï¸ NETWORK ERROR: ${xhr.status}</span>`);
                }
            });
        }

        // ==========================================
        // ğŸ¤ æ–°å¢ï¼šè¯­éŸ³äº¤äº’æ¨¡å— (STT & TTS)
        // ==========================================
        // ==========================================
        // ğŸ¤ 2.0ç‰ˆï¼šè¯­éŸ³äº¤äº’æ¨¡å— (ä¿®å¤Androidå…¼å®¹æ€§ + éŸ³è‰²é€‰æ‹©)
        // ==========================================
        let isTTSActive = true;
        const speechSynth = window.speechSynthesis;
        let recognition;
        let voices = [];
        let selectedVoiceURI = localStorage.getItem('solo_selected_voice') || ''; // è¯»å–ä¸Šæ¬¡å­˜çš„éŸ³è‰²

        // --- A. åŠ è½½è¯­éŸ³å¹¶å¡«å……ä¸‹æ‹‰æ¡† ---
        function populateVoiceList() {
            voices = speechSynth.getVoices();
            const $select = $('#voice-select');
            $select.empty();

            if (voices.length === 0) {
                $select.append('<option value="">æœªæ£€æµ‹åˆ°è¯­éŸ³åŒ… (è¯·æ£€æŸ¥æ‰‹æœºè®¾ç½®)</option>');
                return;
            }

            // ä¼˜å…ˆæŠŠä¸­æ–‡æ”¾åœ¨å‰é¢
            voices.sort((a, b) => {
                const aZh = a.lang.includes('zh') ? 1 : 0;
                const bZh = b.lang.includes('zh') ? 1 : 0;
                return bZh - aZh;
            });

            voices.forEach((voice) => {
                // æ ‡è®°é»˜è®¤æˆ–è€…æ˜¯å½“å‰é€‰ä¸­çš„
                const isSelected = (voice.voiceURI === selectedVoiceURI) ? 'selected' : '';
                // æ˜¾ç¤ºåç§° + è¯­è¨€ä»£ç  (æ–¹ä¾¿åŒºåˆ† Android ä¸Šçš„å¤šç§å¼•æ“)
                const label = `${voice.name} (${voice.lang})`;
                $select.append(`<option value="${voice.voiceURI}" ${isSelected}>${label}</option>`);
            });
        }

        // ç›‘å¬è¯­éŸ³åŒ…åŠ è½½äº‹ä»¶ (Android Chrome å¿…é¡»ä¾é è¿™ä¸ª)
        if (speechSynth.onvoiceschanged !== undefined) {
            speechSynth.onvoiceschanged = populateVoiceList;
        }
        // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹è§¦å‘ï¼Œç¡®ä¿ç§»åŠ¨ç«¯åŠ è½½å®Œæ¯•
        setTimeout(populateVoiceList, 1000);

        // --- B. ç›‘å¬ç”¨æˆ·åˆ‡æ¢éŸ³è‰² ---
        $(document).on('change', '#voice-select', function () {
            selectedVoiceURI = $(this).val();
            localStorage.setItem('solo_selected_voice', selectedVoiceURI); // ä¿å­˜åå¥½

            // è¯•å¬ä¸€ä¸‹
            speakAI("è¯­éŸ³å·²åˆ‡æ¢ã€‚Voice changed.", true);
        });

        // --- C. åˆå§‹åŒ–è¯­éŸ³è¯†åˆ« (ä¿æŒä½ çš„åŸé€»è¾‘ï¼Œå¢åŠ  HTTPS æ£€æŸ¥) ---
        if (window.location.protocol === 'file:') {
            alert("âš ï¸ ä¸¥é‡è­¦å‘Šï¼š\nä½ æ­£åœ¨ä½¿ç”¨ file:// åè®®æ‰“å¼€ç½‘é¡µã€‚\nå®‰å“æ‰‹æœºå‡ºäºå®‰å…¨é™åˆ¶ï¼Œåœ¨è¯¥æ¨¡å¼ä¸‹ã€æ— æ³•ã€‘ä½¿ç”¨éº¦å…‹é£ã€‚\n\nè¯·å°†ç½‘é¡µæ‰˜ç®¡åˆ°æœåŠ¡å™¨ (å¦‚ GitHub Pages) æˆ–ä½¿ç”¨ Live Server è®¿é—® IP åœ°å€ã€‚");
        }

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = function () {
                $('#btn-mic').addClass('mic-active btn-danger').removeClass('btn-outline-secondary');
                $('#sim-input').attr('placeholder', 'æ­£åœ¨è†å¬... (è¯·è¯´è¯)');
            };

            recognition.onend = function () {
                $('#btn-mic').removeClass('mic-active btn-danger').addClass('btn-outline-secondary');
                $('#sim-input').attr('placeholder', 'è¾“å…¥æˆ–è¯­éŸ³å›å¤...');
            };

            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                let currentVal = $('#sim-input').val();
                $('#sim-input').val(currentVal ? currentVal + " " + transcript : transcript);
            };

            recognition.onerror = function (event) {
                console.error("è¯­éŸ³è¯†åˆ«é”™è¯¯:", event.error);
                $('#btn-mic').removeClass('mic-active btn-danger').addClass('btn-outline-secondary');
                // å®‰å“ç‰¹æœ‰çš„é”™è¯¯å¤„ç†
                if (event.error === 'not-allowed' || event.error === 'permission-denied') {
                    alert("âŒ æ— æ³•è®¿é—®éº¦å…‹é£ã€‚\n\nAndroid è§£å†³æ–¹æ¡ˆï¼š\n1. ç¡®ä¿ç½‘å€æ˜¯ https:// å¼€å¤´\n2. æ£€æŸ¥æµè§ˆå™¨è®¾ç½®->ç½‘ç«™è®¾ç½®->éº¦å…‹é£æƒé™\n3. è¿™é‡Œçš„ 'file://' æ— æ³•ä½¿ç”¨ã€‚");
                }
            };
        } else {
            console.warn("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Web Speech API");
        }

        // --- D. ä¿®æ­£åçš„æœ—è¯»å‡½æ•° ---
        function speakAI(text, force = false) {
            if ((!isTTSActive && !force) || !speechSynth) return;

            speechSynth.cancel(); // æ‰“æ–­ä¸Šä¸€å¥

            const cleanText = text.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ');
            if (!cleanText.trim()) return;

            const utterance = new SpeechSynthesisUtterance(cleanText);

            // ã€å…³é”®ä¿®æ”¹ã€‘ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„éŸ³è‰²ï¼Œå¦‚æœæ²¡é€‰ï¼Œåˆ™å°è¯•è‡ªåŠ¨åŒ¹é…ä¸­æ–‡
            if (selectedVoiceURI) {
                const targetVoice = voices.find(v => v.voiceURI === selectedVoiceURI);
                if (targetVoice) utterance.voice = targetVoice;
            } else {
                // é»˜è®¤å›é€€é€»è¾‘ï¼šæ‰¾ç¬¬ä¸€ä¸ªä¸­æ–‡è¯­éŸ³
                const zhVoice = voices.find(v => v.lang.includes('zh'));
                if (zhVoice) utterance.voice = zhVoice;
            }

            // Android ä¸Šè¯­é€Ÿå»ºè®®ç¨å¾®è°ƒå¿«ä¸€ç‚¹ç‚¹ï¼Œä¸ç„¶æœ‰äº›å¼•æ“å¾ˆæ…¢
            utterance.rate = 1.1;
            utterance.pitch = 1.0;

            speechSynth.speak(utterance);
        }
        function handleSimulation(userContent, btn, originalText, isSystemEvent = false) {
            const currentScenarioId = $('#simModal').data('scenario-id');
            let gameState = loadState();

            if (!gameState.scenarioData) gameState.scenarioData = {};
            if (!gameState.scenarioData[currentScenarioId]) {
                gameState.scenarioData[currentScenarioId] = { affinity: 0, history: [], day: 1, hour: 9 };
            }

            let characterData = gameState.scenarioData[currentScenarioId];
            let currentAffinity = characterData.affinity || 0;
            let currentDay = characterData.day || 1;

            // ğŸ› ï¸ ä¿®å¤ç‚¹1: è¯»å–æ•°æ®æ—¶ï¼Œè¿›è¡Œâ€œè„æ•°æ®æ¸…æ´—â€
            // å¦‚æœå­˜æ¡£é‡Œå­˜äº† 25.5ï¼Œè¿™é‡Œç›´æ¥ä¿®æˆ 1.5ï¼Œå¹¶è¿›ä½å¤©æ•°
            let rawHour = characterData.hour !== undefined ? characterData.hour : 9;
            if (rawHour >= 24) {
                rawHour = rawHour % 24;
                currentDay += 1;
                characterData.day = currentDay; // ç«‹å³ä¿®æ­£å­˜æ¡£
                characterData.hour = rawHour;
            }
            let currentHour = rawHour;

            // ğŸ› ï¸ ä¿®å¤ç‚¹2: æ˜¾ç¤ºæ ¼å¼åŒ–å‡½æ•°å¢åŠ  % 24 ä¿æŠ¤
            const formatTime = (h) => {
                let hour = Math.floor(h) % 24; // å¼ºåˆ¶é™åˆ¶åœ¨ 0-23
                let minute = Math.floor((h % 1) * 60);
                return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
            };

            // 1. æ›´æ–° UI
            let statusLabel = "é™Œç”Ÿäºº";
            if (currentAffinity >= 30) statusLabel = "æœ‹å‹";
            if (currentAffinity >= 60) statusLabel = "æš§æ˜§";
            if (currentAffinity >= 90) statusLabel = "æ‹äºº";

            $('#sim-status-text').text(`${statusLabel} [${currentAffinity}%]`);
            $('#sim-day-display').text(`DAY ${currentDay}`);
            $('#sim-time-display').text(formatTime(currentHour));

            if (!isSystemEvent) {
                $('#sim-chat-box').append(`<div class="chat-bubble user">${userContent}</div>`);
            }

            // 2. æ„å»º Prompt
            let messages = [
                {
                    role: "system", content: `
ä½ æ­£åœ¨è¿›è¡Œæ‹çˆ±æ¨¡æ‹Ÿ (Dating Sim)ã€‚
ã€å½“å‰å‰§æœ¬ã€‘: ${$('#simModal').data('scenario') || 'é€šç”¨'}
ã€å½“å‰çŠ¶æ€ã€‘: å¥½æ„Ÿåº¦ ${currentAffinity}/100ï¼Œç¬¬ ${currentDay} å¤©ï¼Œæ—¶é—´ ${formatTime(currentHour)}ã€‚
ã€å…³ç³»é˜¶æ®µã€‘: ${statusLabel}

ã€æ ¸å¿ƒæŒ‡ä»¤ã€‘:
1. **æ²‰æµ¸å¼å›å¤**: æ‰®æ¼”å¥³ç”Ÿï¼Œä¸è¦å‡ºæˆã€‚
2. **æ—¶é—´æ„ŸçŸ¥**: å½“å‰æ˜¯ ${formatTime(currentHour)}ã€‚å¦‚æœæ˜¯æ·±å¤œï¼Œè¡¨ç°å‡ºå›°æ„ã€‚
3. **ç»“æŸåˆ¤æ–­**: å¦‚æœè¯é¢˜ç»“æŸæˆ–æ—¶é—´å¤ªæ™š(>23:00)ï¼Œè®¾ç½® "conversation_end": trueã€‚

ã€å»ºè®®ç”Ÿæˆè§„åˆ™ã€‘:
è¯·åœ¨ suggestions æ•°ç»„ä¸­æä¾› 3 ä¸ªé€‰é¡¹ï¼Œprediction å­—æ®µå¿…é¡»ä½¿ç”¨ç²¾ç¡®æ•°æ®æ ¼å¼ï¼š
- **[ç¨³å¥]**: å®‰å…¨ç‰Œã€‚æˆåŠŸç‡ 90%-100%ï¼Œå¥½æ„Ÿæ”¶ç›Š +1 åˆ° +2ã€‚
- **[è¿›å–]**: æ‹‰å‡å…³ç³»ã€‚æˆåŠŸç‡ 60%-80%ï¼Œå¥½æ„Ÿæ”¶ç›Š +3 åˆ° +5ã€‚
- **[æŒ‘æˆ˜]**: é«˜é£é™©ã€‚æˆåŠŸç‡ 30%-50%ï¼Œ**æˆåŠŸåˆ™å¥½æ„Ÿ +10ï¼Œå¤±è´¥åˆ™å¥½æ„Ÿ -10**ã€‚
- **[éªšè¯]**: (Flirty Line) å¹½é»˜ã€åœŸå‘³æƒ…è¯æˆ–å¤§èƒ†è°ƒæƒ…ã€‚ç”¨äºæµ‹è¯•å¯¹æ–¹æ˜¯å¦æ¥å—æš§æ˜§ã€‚æˆåŠŸç‡è§†è¯­å¢ƒè€Œå®šï¼ˆé€šå¸¸ 40%-60%ï¼‰ï¼ŒæˆåŠŸåˆ™å¥½æ„Ÿ +8ï¼Œå¤±è´¥åˆ™å¥½æ„Ÿ -5ï¼ˆè¢«å½“æˆæ²¹è…»ï¼‰ã€‚

ã€è¾“å‡º JSON æ ¼å¼ã€‘:
{
    "reply": "å¥³ç”Ÿå›å¤å†…å®¹",
    "affinity_change": 0, 
    "analysis": "å¿ƒç†åˆ†æ",
    "conversation_end": false, 
    "suggestions": [
        { "type": "ç¨³å¥", "text": "...", "prediction": "æˆåŠŸç‡ 95% | å¥½æ„Ÿ +1" },
        { "type": "è¿›å–", "text": "...", "prediction": "æˆåŠŸç‡ 70% | å¥½æ„Ÿ +4" },
        { "type": "æŒ‘æˆ˜", "text": "...", "prediction": "æˆåŠŸç‡ 40% | èµŒæ³¨ Â±10" },
        { "type": "éªšè¯", "text": "...", "prediction": "æˆåŠŸç‡ 50% | æš§æ˜§ +8" }
    ]
}
`}
            ];

            simHistory.slice(-6).forEach(h => messages.push(h));
            messages.push({ role: "user", content: userContent });

            if (btn) startProgress(btn, "CALCULATING...");

            $.ajax({
                url: "https://api.deepseek.com/chat/completions",
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": "Bearer " + API_KEY },
                data: JSON.stringify({
                    model: "deepseek-chat",
                    messages: messages,
                    temperature: 1.1,
                    response_format: { type: 'json_object' }
                }),
                success: function (response) {
                    if (btn) stopProgress(btn, originalText);
                    let data;
                    try { data = JSON.parse(response.choices[0].message.content); } catch (e) { return; }

                    // --- æ¸²æŸ“å»ºè®® ---
                    const suggestions = data.suggestions || [];
                    if (suggestions.length > 0 && !data.conversation_end) {
                        const styleMap = {
                            "ç¨³å¥": { color: "#adb5bd", icon: "bi-shield-check", bg: "rgba(173, 181, 189, 0.1)" },
                            "è¿›å–": { color: "#0dcaf0", icon: "bi-graph-up-arrow", bg: "rgba(13, 202, 240, 0.1)" },
                            "æŒ‘æˆ˜": { color: "#ff2a6d", icon: "bi-dice-5-fill", bg: "rgba(255, 42, 109, 0.1)" }
                            // ğŸ”¥ æ–°å¢ï¼šéªšè¯çš„é…è‰² (ç²‰ç´«è‰²)
                            , "éªšè¯": { color: "#d63384", icon: "bi-suit-heart-fill", bg: "rgba(214, 51, 132, 0.1)" }
                        };

                        let suggestionHtml = `<div class="sim-suggestion-grid">`;
                        suggestions.forEach(s => {
                            const type = s.type || "æ™®é€š";
                            const text = s.text || s;
                            const pred = s.prediction || "N/A";
                            const style = styleMap[type] || styleMap["ç¨³å¥"];

                            suggestionHtml += `
                    <div class="sim-suggestion-chip sim-suggestion-card" 
                         data-content="${text.replace(/"/g, '&quot;')}" 
                         style="border-left-color: ${style.color};">
                        <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 pb-2 border-bottom border-secondary gap-2" style="border-color: rgba(255,255,255,0.1) !important;">
                            <span style="color:${style.color}; font-weight:bold; font-size:0.9rem; letter-spacing:1px; white-space: nowrap;">
                                <i class="bi ${style.icon}"></i> ${type.toUpperCase()}
                            </span>
                            <span class="sim-pred-badge">${pred}</span>
                        </div>
                        <div class="text-white small opacity-75" style="line-height:1.4; word-break: break-word;">${text}</div>
                    </div>`;
                        });
                        suggestionHtml += `</div>`;
                        setTimeout(() => {
                            $('#sim-chat-box').append(`<div class="chat-bubble system w-100 bg-transparent border-0 p-0">${suggestionHtml}</div>`);
                            $('#sim-chat-box').scrollTop($('#sim-chat-box')[0].scrollHeight);
                        }, 600);
                    }

                    // æ›´æ–°å¥½æ„Ÿåº¦
                    const change = data.affinity_change || 0;
                    // ğŸ”¥ ä¿®æ”¹ï¼šå»æ‰äº† Math.min(100, ...) çš„é™åˆ¶ï¼Œåªä¿ç•™ä¸‹é™ 0
                    const newAffinity = Math.max(0, currentAffinity + change);

                    if (change !== 0) {
                        const color = change > 0 ? '#198754' : '#dc3545';
                        $('#sim-status-bar').css('border-color', color);
                        setTimeout(() => $('#sim-status-bar').css('border-color', 'var(--primary-color)'), 1000);
                    }

                    // ğŸ”¥ ä¿®æ”¹ï¼šå¢åŠ  >100 çš„çŠ¶æ€æ˜¾ç¤º
                    let displayLabel = statusLabel;
                    if (newAffinity > 100) displayLabel = "æ­»å¿ƒå¡Œåœ° (DEVOTED)";
                    if (newAffinity > 150) displayLabel = "ç—…å¨‡ (YANDERE)"; // ç”šè‡³å¯ä»¥æ›´é«˜

                    $('#sim-status-text').text(`${displayLabel} [${newAffinity}%]`);
                    let aiHtml = data.reply;
                    if (change !== 0) {
                        const indicator = change > 0 ? `Affinity +${change}` : `Affinity ${change}`;
                        const colorClass = change > 0 ? 'text-success' : 'text-danger';
                        aiHtml += `<div class="mt-2 pt-1 border-top border-secondary small ${colorClass}" style="font-size:0.7rem; font-family:monospace;">>> ${indicator}</div>`;
                    }

                    setTimeout(() => {
                        $('#sim-chat-box').append(`<div class="chat-bubble ai">${aiHtml}</div>`);
                        if (data.analysis) {
                            $('#sim-chat-box').append(`<div class="chat-bubble system text-white-50"><i class="bi bi-eye-fill"></i> ${data.analysis}</div>`);
                        }
                        $('#sim-chat-box').scrollTop($('#sim-chat-box')[0].scrollHeight);
                        speakAI(data.reply);
                    }, 500);

                    // ğŸ› ï¸ ä¿®å¤ç‚¹3: æ—¶é—´é€’å¢é€»è¾‘ (å¤„ç†è·¨å¤©)
                    if (!data.conversation_end) {
                        // å¢åŠ  1 å°æ—¶
                        let nextHour = (characterData.hour || 9) + 1;

                        // å¦‚æœè¶…è¿‡ 24 ç‚¹
                        if (nextHour >= 24) {
                            nextHour = nextHour % 24; // 24.5 -> 0.5
                            characterData.day = (characterData.day || 1) + 1; // å¤©æ•° +1
                            $('#sim-day-display').text(`DAY ${characterData.day}`); // ç«‹å³æ›´æ–° UI å¤©æ•°

                            // å¯é€‰ï¼šæ˜¾ç¤ºè·¨å¤©æç¤º
                            $('#sim-chat-box').append(`<div class="chat-bubble system text-white-50 text-center"><i class="bi bi-moon-stars"></i> å·²è¿‡é›¶ç‚¹ï¼Œè¿›å…¥ DAY ${characterData.day}</div>`);
                        }

                        characterData.hour = nextHour;
                        $('#sim-time-display').text(formatTime(characterData.hour));
                    }

                    // å¤„ç†ç»“æŸçŠ¶æ€
                    if (data.conversation_end === true) {
                        $('#sim-input').prop('disabled', true).attr('placeholder', 'Wait for next stage...');
                        $('#btn-mic').prop('disabled', true);
                        $('#btn-sim-send').hide();
                        $('#btn-sim-next').fadeIn().addClass('blink-slow');
                        $('#sim-chat-box').append(`<div class="chat-bubble system text-warning text-center my-3"><i class="bi bi-pause-circle"></i> å¯¹è¯æš‚æ­‡ (Time: ${formatTime(characterData.hour)})</div>`);
                        $('.sim-suggestion-container').remove();
                    }

                    // ä¿å­˜
                    characterData.affinity = newAffinity;
                    gameState.simProgress.currentAffinity = newAffinity;
                    if (!isSystemEvent) simHistory.push({ role: "user", content: userContent });
                    simHistory.push({ role: "assistant", content: JSON.stringify(data) });
                    characterData.history = simHistory;
                    saveState(gameState);

                    // é€šå…³é€»è¾‘
                    if (newAffinity >= 100) {
                        const currentScenario = SIM_SCENARIOS.find(s => s.id === currentScenarioId);
                        if (currentScenario && currentScenario.level) {
                            const currentLevel = currentScenario.level;
                            const nextLevel = currentLevel + 1;
                            if (nextLevel > gameState.simProgress.unlockedLevel && nextLevel <= 20) {
                                gameState.simProgress.unlockedLevel = nextLevel;
                                saveState(gameState);
                                alert(`ğŸ‰ LEVEL CLEARED! \nLv.${currentLevel} -> Lv.${nextLevel} Unlocked!`);
                                $('#simModal').modal('hide');
                            }
                        }
                    }
                },
                error: function (xhr) { if (btn) stopProgress(btn, originalText); }
            });
        }

        $(document).ready(function () {
            // åˆå§‹åŒ–ï¼šåŠ è½½æ•°æ®å¹¶æ¸²æŸ“
            let gameState = loadState();
            renderUI(gameState);

            // å®æ—¶æ—¶é’Ÿ
            setInterval(() => { $('#clock').text(new Date().toLocaleTimeString()); }, 1000);

            // --- ä¿®æ”¹ 1ï¼šç‚¹å‡»è¿›å…¥ç¼–è¾‘æ¨¡å¼ ---
            $(document).on('click', '#status-player-label', function (e) {
                // é˜²æ­¢ç‚¹å‡»è¾“å…¥æ¡†æœ¬èº«è§¦å‘é‡ç½®
                if ($(e.target).is('input')) return;

                const currentName = $(this).text();

                // ã€å…³é”®ä¿®æ”¹ã€‘ä¸è¦ç”¨ replaceWithï¼Œè€Œæ˜¯ç”¨ html()
                // è¿™æ · status-player-label è¿™ä¸ª ID è¿˜åœ¨ï¼Œåªæ˜¯å†…å®¹å˜æˆäº† input
                const inputStyle = "background: rgba(0,0,0,0.8); border: 1px solid var(--primary-color); color: #fff; width: 100%; text-align: center; font-family: inherit;";
                const inputHtml = `<input type="text" id="player-name-input" value="${currentName}" style="${inputStyle}" />`;

                $(this).html(inputHtml);

                // èšç„¦å¹¶å…¨é€‰æ–‡æœ¬ï¼Œæ–¹ä¾¿ç›´æ¥ä¿®æ”¹
                const $input = $('#player-name-input');
                $input.focus().select();
            });

            // --- ğŸ”¥ æ–°å¢ï¼šLOG æ–‡ä»¶åŠ è½½åŠŸèƒ½ ---

            // 1. ç‚¹å‡»æŒ‰é’®è§¦å‘æ–‡ä»¶é€‰æ‹©
            $('#btn-load-log').click(function () {
                $('#file-log-input').click();
            });

            // 2. æ–‡ä»¶é€‰æ‹©åçš„å¤„ç†
            $('#file-log-input').change(function (e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    let content = e.target.result;

                    // --- 3. è§£æä¸æ¸…æ´— (Parser) ---
                    // ç›®æ ‡ï¼šå»æ‰æ–‡ä»¶å¤´éƒ¨çš„å…ƒæ•°æ®ï¼Œåªä¿ç•™å¯¹è¯å†…å®¹ï¼ŒèŠ‚çœ Token

                    // å¦‚æœåŒ…å«åˆ†å‰²çº¿ï¼Œè¯´æ˜æ˜¯æ ‡å‡†å¯¼å‡ºæ ¼å¼ï¼Œå°è¯•æˆªå–
                    if (content.includes("========================================")) {
                        // æ‰¾åˆ°æœ€åä¸€ä¸ªåˆ†å‰²çº¿çš„ä½ç½®
                        const parts = content.split("========================================");
                        if (parts.length >= 3) {
                            // é€šå¸¸æœ€åä¸€éƒ¨åˆ†æ˜¯å®é™…å¯¹è¯å†…å®¹
                            // parts[0] æ˜¯ç©ºæˆ–å¤´éƒ¨ï¼Œparts[1] æ˜¯ä¿¡æ¯å¤´ï¼Œparts[2] æ˜¯æ­£æ–‡
                            content = parts[parts.length - 1].trim();
                        }
                    }

                    // --- 4. è½½å…¥ç³»ç»Ÿ ---
                    // A. å¡«å…¥è¾“å…¥æ¡† (å‡†å¤‡è®©ç”¨æˆ·ç‚¹å‡» Upload)
                    $('#report-input').val(content);

                    // è‡ªåŠ¨èšç„¦ï¼Œæ–¹ä¾¿ç”¨æˆ·ç›´æ¥ç‚¹å‘é€
                    $('#btn-report').focus();

                    // B. ç»ˆç«¯åé¦ˆ (æ˜¾ç¤ºåŠ è½½æˆåŠŸ)
                    const fileName = file.name;
                    const size = (file.size / 1024).toFixed(1) + "KB";
                    const successLog = `
                        <div class="mb-2">
                            <span class="text-success fw-bold">[ SYSTEM ]</span> 
                            <span class="text-white">FILE LOADED: ${fileName} (${size})</span><br>
                            <span class="text-white-50 small">> Data parsed. Ready for analysis.</span>
                        </div>`;

                    typeWriter(successLog, "#ai-response");

                    // å¯é€‰ï¼šæ’­æ”¾ä¸ªéŸ³æ•ˆ
                    // speakAI("Log file loaded."); 
                };

                reader.readAsText(file);
                // æ¸…ç©º value ä»¥ä¾¿å…è®¸é‡å¤ä¸Šä¼ åŒä¸€ä¸ªæ–‡ä»¶
                $(this).val('');
            });
            // --- ä¿®æ”¹ 2ï¼šä¿å­˜åå­—é€»è¾‘ ---
            // å…ˆè§£ç»‘æ—§äº‹ä»¶ï¼Œé˜²æ­¢é‡å¤
            $(document).off('blur keydown', '#player-name-input');

            $(document).on('blur keydown', '#player-name-input', function (e) {
                // 1. å¦‚æœæ˜¯é”®ç›˜æŒ‰é”®ï¼Œä½†ä¸æ˜¯å›è½¦ï¼Œåˆ™ä¸åšä»»ä½•äº‹
                if (e.type === 'keydown' && e.which !== 13) return;

                // 2. å¦‚æœæ˜¯å›è½¦ï¼Œé˜»æ­¢é»˜è®¤æ¢è¡Œè¡Œä¸º
                if (e.type === 'keydown') e.preventDefault();

                // --- æ ¸å¿ƒä¿å­˜é€»è¾‘ ---
                const newName = $(this).val().trim() || "Unknown";
                const currentState = loadState();

                // æ›´æ–°çŠ¶æ€
                currentState.playerName = newName;
                saveState(currentState);

                // ã€å…³é”®ä¿®æ”¹ã€‘æ‰¾åˆ°çˆ¶å®¹å™¨ï¼ˆä¹Ÿå°±æ˜¯ #status-player-labelï¼‰ï¼Œç›´æ¥ä¿®æ”¹å®ƒçš„æ–‡å­—
                // å› ä¸ºæˆ‘ä»¬åœ¨ç¬¬ä¸€æ­¥é‡Œä¿ç•™äº†çˆ¶å®¹å™¨ï¼Œæ‰€ä»¥è¿™é‡Œèƒ½æ‰¾åˆ°å®ƒ
                $('#status-player-label').text(newName);

                // è§¦å‘å…¨å±€æ¸²æŸ“
                renderUI(currentState);
            });

            // --- ğŸ”¥ æ ¸å¿ƒé€»è¾‘ï¼šæ—¶é—´è·³è·ƒ (Time Skip) ---
            $(document).on('click', '#btn-sim-next', function () {
                const currentScenarioId = $('#simModal').data('scenario-id');
                let gameState = loadState();
                let characterData = gameState.scenarioData[currentScenarioId];

                // è·å–å½“å‰æ—¶é—´ (é»˜è®¤ä¸º9ç‚¹)
                let curH = characterData.hour || 9;
                let curDay = characterData.day || 1;
                let nextH, nextDay = curDay;
                let timeLabel = "";

                // === â³ æ™ºèƒ½æ—¶é—´æ¨æ¼”ç®—æ³• ===
                if (curH < 11) {
                    // åœºæ™¯ A: æ—©ä¸ŠèŠå®Œäº† -> è·³åˆ° ä¸‹åˆ/å‚æ™š (15:00 - 17:00 éšæœº)
                    nextH = 15 + Math.random() * 2;
                    timeLabel = "LATER THAT DAY";
                } else if (curH < 17) {
                    // åœºæ™¯ B: ä¸‹åˆèŠå®Œäº† -> è·³åˆ° æ™šä¸Š (19:00 - 20:30 éšæœº)
                    nextH = 19 + Math.random() * 1.5;
                    timeLabel = "EVENING";
                } else if (curH < 22) {
                    // åœºæ™¯ C: æ™šä¸ŠèŠå®Œäº† -> è·³åˆ° æ·±å¤œ (22:30 - 23:30 éšæœº)
                    nextH = 22.5 + Math.random();
                    timeLabel = "LATE NIGHT";
                } else {
                    // åœºæ™¯ D: æ·±å¤œèŠå®Œäº† -> è·³åˆ° ç¬¬äºŒå¤©æ—©ä¸Š (08:00 - 09:30 éšæœº)
                    nextH = 8 + Math.random() * 1.5;
                    nextDay += 1; // å¤©æ•° +1
                    timeLabel = "NEXT MORNING";
                }

                // æ›´æ–°æ•°æ®
                characterData.hour = nextH;
                characterData.day = nextDay;
                saveState(gameState);

                // === ğŸ–¥ï¸ ç•Œé¢æ¸²æŸ“æ›´æ–° ===

                // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¶é—´
                const formatTime = (h) => {
                    let hour = Math.floor(h);
                    let minute = Math.floor((h % 1) * 60);
                    return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                };

                // æ›´æ–°é¡¶éƒ¨çŠ¶æ€æ 
                $('#sim-day-display').text(`DAY ${nextDay}`);
                $('#sim-time-display').text(formatTime(nextH));

                // æ’å…¥æ—¶é—´æµé€åˆ†å‰²çº¿
                const dividerIcon = nextDay > curDay ? 'bi-sun-fill text-warning' : 'bi-clock-history text-info';
                const dividerHtml = `
        <div class="d-flex align-items-center justify-content-center my-4 text-white-50 small fade-in-up">
            <span style="height:1px; background:rgba(255,255,255,0.2); width:40px;"></span>
            <span class="mx-3 font-monospace" style="letter-spacing:1px;">
                <i class="bi ${dividerIcon}"></i> ${timeLabel} [${formatTime(nextH)}]
            </span>
            <span style="height:1px; background:rgba(255,255,255,0.2); width:40px;"></span>
        </div>
    `;
                $('#sim-chat-box').append(dividerHtml);

                // æ¢å¤è¾“å…¥æ§ä»¶
                $('#sim-input').prop('disabled', false).attr('placeholder', 'è¾“å…¥æˆ–è¯­éŸ³å›å¤...').val('');
                $('#btn-mic').prop('disabled', false);
                $('#btn-sim-next').hide().removeClass('blink-slow');
                $('#btn-sim-send').show();

                // === ğŸ¤– å‘é€ç³»ç»ŸæŒ‡ä»¤ç»™ AI (è®©å®ƒæ ¹æ®æ–°æ—¶é—´å¼€åœº) ===
                // æ„é€ ç»†è…»çš„ Prompt
                let timeContext = "";
                if (nextDay > curDay) {
                    timeContext = `å·²ç»æ˜¯ç¬¬äºŒå¤©æ—©ä¸Šäº†(${formatTime(nextH)})ã€‚è¯·ä¸»åŠ¨å‘èµ·æ—©å®‰é—®å€™ã€‚`;
                } else {
                    timeContext = `æ—¶é—´æµé€åˆ°äº†åŒä¸€å¤©çš„ ${timeLabel} (${formatTime(nextH)})ã€‚è¯·æ ¹æ®è¿™ä¸ªæ–°æ—¶é—´ç‚¹ï¼Œä¸»åŠ¨å‘èµ·ä¸‹ä¸€é˜¶æ®µçš„å¯¹è¯ï¼ˆæ¯”å¦‚ä¸‹åˆèŒ¶ã€ä¸‹ç­åã€ç¡å‰ï¼‰ã€‚`;
                }

                const nextStagePrompt = `(ç³»ç»ŸæŒ‡ä»¤ï¼š${timeContext} å½“å‰å¥½æ„Ÿåº¦ï¼š${characterData.affinity}ã€‚è¯·ä¸è¦é‡å¤ä¹‹å‰çš„å‘Šåˆ«ï¼Œè€Œæ˜¯ç›´æ¥å¼€å§‹æ–°è¯é¢˜ã€‚)`;

                // è°ƒç”¨ AI (isSystemEvent=trueï¼Œä¸æ˜¾ç¤ºæŒ‡ä»¤æ°”æ³¡)
                handleSimulation(nextStagePrompt, null, null, true);
            });
            // å¯¼å‡ºèŠå¤©è®°å½•åŠŸèƒ½
            $(document).on('click', '#btn-export-sim-log', function () {
                const scenarioTitle = $('#simModal').data('scenario-title') || 'Dating_Sim'; // è·å–å‰§æœ¬å
                let logText = `========================================\nSIMULATION LOG - ${scenarioTitle}\nTime: ${new Date().toLocaleString()}\n========================================\n\n`;

                // éå† chat-box é‡Œçš„æ‰€æœ‰ bubble
                $('#sim-chat-box').children().each(function () {
                    const $bubble = $(this);
                    // è¿‡æ»¤æ‰ç³»ç»Ÿæç¤ºå’Œå»ºè®®æŒ‰é’®ï¼Œåªç•™å¯¹è¯
                    if ($bubble.hasClass('system') && $bubble.find('.sim-suggestion-container').length > 0) return;

                    let text = $bubble.text().trim();
                    // å»æ‰å†…å¿ƒç‹¬ç™½ (ğŸ’­ å¼€å¤´çš„éƒ¨åˆ†)
                    text = text.replace(/ğŸ’­[\s\S]*$/, '').trim();

                    const sender = $bubble.hasClass('user') ? 'USER' : ($bubble.hasClass('ai') ? 'HER' : 'SYSTEM');

                    if (text) logText += `[${sender}]: ${text}\n\n`;
                });

                const blob = new Blob(["\uFEFF" + logText], { type: "text/plain;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `SIM_LOG_${new Date().getTime()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            // ----------------------------------------
            // æ ¸å¿ƒä¿®å¤ï¼šSwitch System (åˆ‡æ¢æ¨¡å¼)
            // ----------------------------------------
            $('#btn-switch-mode').click(function () {
                // 1. åˆ‡æ¢æ¨¡å¼å˜é‡
                currentMode = currentMode === 'dating' ? 'learning' : 'dating';

                // 2. è®°ä½é€‰æ‹©
                localStorage.setItem('solo_current_mode', currentMode);

                // 3. é‡æ–°ä» LocalStorage åŠ è½½å¯¹åº”æ¨¡å¼çš„æ•°æ® (å¦‚æœæ²¡æ•°æ®ä¼šåŠ è½½æ–°çš„ Default)
                gameState = loadState();

                // 4. é‡æ–°æ¸²æŸ“ç•Œé¢ (ä¼šè§¦å‘æ¢è‰²ã€æ¢æ ‡é¢˜ã€æ¢æŠ€èƒ½åˆ—è¡¨)
                renderUI(gameState);

                // 5. è§†è§‰ç‰¹æ•ˆï¼šç®€å•çš„é—ªçƒåé¦ˆ
                $('#ui-layer').fadeOut(100).fadeIn(300);
            });

            const renderShop = () => {
                const $container = $('#shop-items-container').empty();
                const s = loadState();

                SHOP_ITEMS.forEach(item => {
                    const canAfford = s.gold >= item.cost;
                    const btnColor = canAfford ? 'btn-outline-warning' : 'btn-outline-secondary';
                    const icon = item.icon || 'bi-star';

                    // æ›´ç²¾è‡´çš„å¡ç‰‡è®¾è®¡
                    $container.append(`
                        <div class="col-md-6">
                            <div class="shop-item p-3 rounded position-relative" onclick="buyItem('${item.id}')" style="border: 1px solid ${canAfford ? '#ffd700' : '#444'}; opacity: ${canAfford ? 1 : 0.7}">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi ${icon} me-3" style="font-size: 1.5rem; color: ${canAfford ? '#ffd700' : '#888'}"></i>
                                    <div class="flex-grow-1">
                                        <div class="fw-bold text-white">${item.name}</div>
                                        <div class="small text-white-50" style="font-size: 0.75rem;">${item.desc}</div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-end border-top border-secondary pt-2 mt-2">
                                    <span class="${canAfford ? 'text-warning' : 'text-secondary'} fw-bold font-monospace">
                                        ${item.cost} G
                                    </span>
                                </div>
                            </div>
                        </div>
                    `);
                });
            };

            // ----------------------------------------
            // ä¿®å¤ & å‡çº§ï¼šè´­ä¹°é€»è¾‘ (å«ç›²ç›’æœºåˆ¶)
            // ----------------------------------------
            window.buyItem = function (itemId) {
                const item = SHOP_ITEMS.find(i => i.id === itemId);
                const s = loadState();

                if (s.gold >= item.cost) {
                    // å†æ¬¡ç¡®è®¤é˜²æ­¢æ‰‹æ»‘
                    if (!confirm(`ç¡®è®¤æ¶ˆè´¹ ${item.cost}G è´­ä¹°?\nã€${item.name}ã€‘`)) return;

                    s.gold -= item.cost;

                    // 1. è™šæ‹Ÿè¯å‰‚æ•ˆæœ
                    if (item.type === 'VIRTUAL') {
                        if (item.effect.full_restore) {
                            s.hp = 100;
                            s.mp = 100;
                            alert("ğŸ’‰ æ³¨å…¥å®Œæ¯•ï¼çŠ¶æ€å·²å›æ»¡ï¼");
                        } else {
                            if (item.effect.hp) s.hp = Math.min(100, s.hp + item.effect.hp);
                            if (item.effect.mp) s.mp = Math.min(100, s.mp + item.effect.mp);
                            alert(`ğŸ¥¤ æ¢å¤ç”Ÿæ•ˆ: HP+${item.effect.hp}, MP+${item.effect.mp}`);
                        }
                    }
                    // 2. ç›²ç›’æœºåˆ¶ (Gacha)
                    else if (item.type === 'GACHA') {
                        // éšæœºç®—æ³•: 50%äº, 30%å›æœ¬, 20%èµš
                        const rand = Math.random();
                        let prize = 0;
                        if (rand < 0.5) prize = Math.floor(Math.random() * 30); // 0-30 (è¡€äº)
                        else if (rand < 0.8) prize = 50 + Math.floor(Math.random() * 20); // 50-70 (å›æœ¬)
                        else prize = 100 + Math.floor(Math.random() * 100); // 100-200 (è¡€èµš)

                        s.gold += prize;
                        const resultText = prize > 50 ? "ğŸ‰ è¿æ°”çˆ†æ£šï¼" : "ğŸ’€ è¿æ°”ä¸ä½³...";
                        alert(`${resultText}\nä½ æ‰“å¼€ç›²ç›’ï¼Œè·å¾—äº† ${prize} Gï¼`);
                    }
                    // 3. ç°å®å¥–åŠ±
                    else if (item.type === 'REAL') {
                        alert(`ğŸ‰ è´­ä¹°å‡­è¯å·²ç”Ÿæˆï¼\n\nè¯·æ”¾ä¸‹æ‰‹æœºï¼Œç«‹åˆ»å»æ‰§è¡Œï¼š\n>>> ${item.name} <<<\n\n(ç³»ç»Ÿå‡†è®¸ä½ äº«å—è¿™ä¸€åˆ»ï¼Œä¸è¦æœ‰è´Ÿç½ªæ„Ÿ)`);
                    }

                    saveState(s);
                    renderUI(s);
                    renderShop(); // è´­ä¹°åç«‹å³åˆ·æ–°ï¼Œæ›´æ–°ä½™é¢çŠ¶æ€
                } else {
                    alert(`âŒ ä½™é¢ä¸è¶³ï¼\nè¿˜éœ€è¦ ${item.cost - s.gold} G`);
                }
            };

            // è¿™ä¸€æ®µå¿…é¡»åœ¨ $(document).ready é‡Œé¢ï¼Œä¿è¯ç‚¹å‡»ç”Ÿæ•ˆ
            $(document).on('click', '.sim-suggestion-chip', function () {
                // è·å–æ¸…æ´—å¹²å‡€çš„ data-content
                const text = $(this).data('content');
                $('#sim-input').val(text).focus();
            });

            // ğŸ”¥ğŸ”¥ğŸ”¥ å…³é”®ä¿®å¤ï¼šç»‘å®šæ˜¾ç¤ºäº‹ä»¶ ğŸ”¥ğŸ”¥ğŸ”¥
            // è¿™è¡Œä»£ç æ˜¯ä½ ä¹‹å‰æ¼æ‰çš„ï¼Œå®ƒè®© ShopModal æ‰“å¼€æ—¶è§¦å‘ renderShop
            $('#shopModal').on('show.bs.modal', renderShop);

            // ----------------------------------------------------------------
            // ğŸ® æ¸²æŸ“æ¨¡æ‹Ÿæˆ˜åœ°å›¾ (Map Renderer)
            // ----------------------------------------------------------------
            $('#simModal').on('show.bs.modal', function () {
                const $container = $('#sim-scenario-container').empty();
                const mode = currentMode;
                const s = loadState();
                // ğŸ”¥ æ–°å¢ï¼šæ‰“å¼€å¼¹çª—æ—¶ï¼Œç«‹å³æ›´æ–°é¡¶éƒ¨çš„å¥½æ„Ÿåº¦æ•°å­—
                const currentAffinity = (s.simProgress && s.simProgress.currentAffinity) ? s.simProgress.currentAffinity : 0;
                // å¦‚æœæ˜¯å­¦ä¹ æ¨¡å¼ï¼Œè¿˜ç”¨åŸæ¥çš„ç®€å•æŒ‰é’®åˆ—è¡¨
                // ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šæ ¹æ®æ¨¡å¼æ§åˆ¶å¥½æ„Ÿåº¦æ˜¾ç¤º ğŸ”¥ğŸ”¥
                const $modalTitle = $('#simModal .modal-title');

                if (mode === 'dating') {
                    // æ‹çˆ±æ¨¡å¼çš®è‚¤
                    $modalTitle.removeClass('text-info').addClass('text-danger');
                    $modalTitle.html('<i class="bi bi-heart-pulse-fill"></i> DATING SIMULATOR');
                } else {
                    // å­¦ä¹ æ¨¡å¼çš®è‚¤ (è“è‰²ï¼Œå›¾æ ‡æ”¹ä¸ºç»ˆç«¯)
                    $modalTitle.removeClass('text-danger').addClass('text-info');
                    $modalTitle.html('<i class="bi bi-terminal-fill"></i> TRAINING SIMULATOR');
                }
                if (mode === 'learning') {
                    $container.removeClass('sim-map-container').addClass('d-flex justify-content-center gap-3 flex-wrap');
                    const activeScenarios = SIM_SCENARIOS.filter(sc => sc.type === 'learning');
                    activeScenarios.forEach(sc => {
                        $container.append(`
                <button class="btn btn-outline-info btn-sim-start" 
                        data-id="${sc.id}" style="min-width: 150px; padding: 15px;">
                    ${sc.label}
                </button>
            `);
                    });
                    return;
                }

                // --- æ‹çˆ±æ¨¡å¼ï¼šæ¸²æŸ“åœ°å›¾ (Dating Map) ---
                $container.removeClass('d-flex justify-content-center gap-3 flex-wrap').addClass('sim-map-container');

                // è·å–å½“å‰è§£é”è¿›åº¦ (é»˜è®¤ä¸º1)
                const unlockedLevel = s.simProgress ? s.simProgress.unlockedLevel : 1;

                // è¿‡æ»¤å‡º Lv1 - Lv20
                const levels = SIM_SCENARIOS.filter(sc => sc.type === 'dating').sort((a, b) => a.level - b.level);

                levels.forEach(sc => {
                    let statusClass = '';
                    let icon = '<i class="bi bi-lock-fill"></i>';
                    let clickAttr = '';

                    if (sc.level < unlockedLevel) {
                        // å·²é€šå…³
                        statusClass = 'unlocked cleared';
                        icon = '<i class="bi bi-check-lg"></i>'; // æˆ–è€…ç­‰çº§æ•°å­—
                        clickAttr = `data-id="${sc.id}"`;
                    } else if (sc.level === unlockedLevel) {
                        // å½“å‰å…³å¡
                        statusClass = 'unlocked current';
                        icon = sc.level;
                        clickAttr = `data-id="${sc.id}"`;
                    } else {
                        // é”å®š
                        statusClass = 'locked';
                        icon = '<i class="bi bi-lock-fill"></i>';
                    }

                    const html = `
            <div class="map-node ${statusClass} btn-sim-start" ${clickAttr} title="${sc.label}">
                <div class="map-node-level">${sc.level === unlockedLevel || sc.level < unlockedLevel ? sc.level : icon}</div>
                <div class="map-node-label">${sc.label}</div>
            </div>
        `;
                    $container.append(html);
                });
            });
            // 2. ç‚¹å‡»å‰§æœ¬æŒ‰é’®ï¼šå¼€å§‹æ¨¡æ‹Ÿ
            // ä½¿ç”¨ document ä»£ç†ç‚¹å‡»äº‹ä»¶ï¼Œå› ä¸ºæŒ‰é’®æ˜¯åŠ¨æ€ç”Ÿæˆçš„
            // 2. ç‚¹å‡»å‰§æœ¬æŒ‰é’®ï¼šå¼€å§‹æ¨¡æ‹Ÿ
            // 2. ç‚¹å‡»å‰§æœ¬æŒ‰é’®ï¼šå¼€å§‹æ¨¡æ‹Ÿ (æ ¸å¿ƒå…¥å£)
            $(document).on('click', '.btn-sim-start', function () {
                const scenarioId = $(this).data('id');
                const scenario = SIM_SCENARIOS.find(s => s.id === scenarioId);
                if (!scenario) return;

                // 1. è®¾ç½®åŸºç¡€ä¿¡æ¯ (UIæ˜¾ç¤ºç”¨)
                $('#simModal').data('scenario', scenario.prompt);
                $('#simModal').data('scenario-title', scenario.label);
                $('#simModal').data('scenario-id', scenarioId); // æ ‡è®°å½“å‰æ˜¯è°
                $('#simModal').data('level', scenario.level);

                // åˆ‡æ¢ç•Œé¢
                $('#sim-setup').hide();
                $('#sim-interface').fadeIn();
                $('#sim-chat-box').empty(); // æ¸…ç©ºæ—§æ°”æ³¡

                // 2. è¯»å–å­˜æ¡£æ•°æ®
                const s = loadState();
                // ç¡®ä¿æ•°æ®ç»“æ„å­˜åœ¨
                if (!s.scenarioData) s.scenarioData = {};

                // è·å–å½“å‰è§’è‰²çš„å­˜æ¡£
                let characterData = s.scenarioData[scenarioId];
                let isNewGame = false;

                // ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒï¼šéšæœºåˆå§‹å¥½æ„Ÿåº¦é€»è¾‘ ğŸ”¥ğŸ”¥ğŸ”¥
                if (!characterData) {
                    console.log(`âœ¨ é¦–æ¬¡è¿›å…¥å‰§æœ¬ [${scenarioId}]ï¼Œæ­£åœ¨ç”Ÿæˆéšæœºåˆå§‹å¥½æ„Ÿåº¦...`);
                    isNewGame = true;

                    // 1. è·å–é…ç½®çš„èŒƒå›´ï¼Œé»˜è®¤ä¸º [0, 0]
                    const range = scenario.start_range || [0, 0];
                    const min = range[0];
                    const max = range[1];

                    // 2. ç”Ÿæˆéšæœºæ•´æ•° (åŒ…å« min å’Œ max)
                    const randomAffinity = Math.floor(Math.random() * (max - min + 1)) + min;

                    // 3. åˆå§‹åŒ–å­˜æ¡£
                    characterData = {
                        affinity: randomAffinity,
                        history: []
                    };

                    // 4. ç«‹å³ä¿å­˜ï¼Œä¿è¯ä¸‹æ¬¡è¿›æ¥è¿˜æ˜¯è¿™ä¸ªåˆ†
                    s.scenarioData[scenarioId] = characterData;
                    saveState(s);
                }

                // æ›´æ–°é¡¶éƒ¨å¥½æ„Ÿåº¦æ˜¾ç¤º
                $('#sim-affinity-display').text(characterData.affinity);

                // 3. åˆ¤æ–­æ˜¯â€œæ–°æ¸¸æˆâ€è¿˜æ˜¯â€œç»§ç»­æ¸¸æˆâ€
                if (!isNewGame && characterData.history && characterData.history.length > 0) {
                    // === [ç†Ÿäººæ¨¡å¼] ===
                    console.log("åŠ è½½å†å²å­˜æ¡£...");

                    // A. æ¢å¤å…¨å±€å†å²è®°å½•å˜é‡
                    simHistory = characterData.history;

                    // B. æ¢å¤ç•Œé¢ä¸Šçš„èŠå¤©æ°”æ³¡
                    simHistory.forEach(msg => {
                        if (msg.role === 'user') {
                            $('#sim-chat-box').append(`<div class="chat-bubble user">${msg.content}</div>`);
                        } else if (msg.role === 'assistant') {
                            try {
                                // å†å²è®°å½•é‡Œå­˜çš„æ˜¯ JSON å­—ç¬¦ä¸²ï¼Œéœ€è¦è§£æå‡º reply
                                const data = JSON.parse(msg.content);
                                $('#sim-chat-box').append(`<div class="chat-bubble ai">${data.reply}</div>`);
                            } catch (e) {
                                $('#sim-chat-box').append(`<div class="chat-bubble ai">${msg.content}</div>`);
                            }
                        }
                    });

                    // C. æ»šåŠ¨åˆ°åº•éƒ¨
                    $('#sim-chat-box').scrollTop($('#sim-chat-box')[0].scrollHeight);

                    // D. å‘é€â€œé‡è¿æŒ‡ä»¤â€ç»™ AI
                    // å…³é”®ï¼šå‘Šè¯‰ AI ä¸è¦è£…å‚»ï¼Œè¦æ ¹æ®å¥½æ„Ÿåº¦æ‰“æ‹›å‘¼
                    const systemInstruction = `(ç³»ç»ŸæŒ‡ä»¤ï¼šç©å®¶é‡æ–°è¿æ¥äº†ã€‚å½“å‰å¥½æ„Ÿåº¦ï¼š${characterData.affinity}ã€‚è¯·ä¸è¦åƒåˆšè®¤è¯†ä¸€æ ·æ‰“æ‹›å‘¼ï¼Œè€Œæ˜¯æ ¹æ®å¥½æ„Ÿåº¦é˜¶æ®µï¼Œç»™å‡ºä¸€å¥ç¬¦åˆäººè®¾çš„â€œæ¬¢è¿å›æ¥â€æˆ–â€œç»§ç»­åˆšæ‰è¯é¢˜â€çš„ç®€çŸ­å›å¤ã€‚)`;

                    callDeepSeek('SIMULATION', systemInstruction, null);

                } else {
                    // === [é™Œç”Ÿäºº/æ–°å¼€å±€æ¨¡å¼] ===
                    console.log(`æ–°å¼€å±€... åˆå§‹å¥½æ„Ÿåº¦: ${characterData.affinity}`);
                    simHistory = []; // æ¸…ç©ºå†å²

                    $('#sim-chat-box').html(`<div class="chat-bubble system">ç³»ç»Ÿæ­£åœ¨æ„å»ºè™šæ‹Ÿåœºæ™¯...<br>è½½å…¥å‰§æœ¬ï¼š${scenario.label}<br>åˆå§‹å¥½æ„Ÿåº¦ï¼š${characterData.affinity}</div>`);

                    // ğŸ”¥ å…³é”®ï¼šå°†åˆå§‹å¥½æ„Ÿåº¦å‘Šè¯‰ AIï¼Œè®©å®ƒå†³å®šç¬¬ä¸€å¥è¯æ€ä¹ˆè¯´
                    // æ¯”å¦‚å¥½æ„Ÿåº¦ 40 (è€åŒå­¦)ï¼Œç¬¬ä¸€å¥å°±ä¸åº”è¯¥æ˜¯â€œä½ å¥½â€
                    const startPrompt = `(ç³»ç»ŸæŒ‡ä»¤ï¼šè¿™æ˜¯æ–°çš„å¯¹è¯ã€‚å½“å‰åˆå§‹å¥½æ„Ÿåº¦ä¸º ${characterData.affinity}ã€‚è¯·ç«‹å³è¿›å…¥è§’è‰²ï¼Œæ ¹æ®è¿™ä¸ªå¥½æ„Ÿåº¦ç”Ÿæˆç¬¬ä¸€å¥å¼€åœºç™½ã€‚å¦‚æœå¥½æ„Ÿåº¦è¾ƒé«˜ï¼Œè¯·è¡¨ç°å¾—ç†Ÿç»œï¼›å¦‚æœå¥½æ„Ÿåº¦ä¸ºè´Ÿï¼Œè¯·è¡¨ç°å¾—å†·æ·¡ã€‚)`;

                    callDeepSeek('SIMULATION', startPrompt, null);
                }
            });
            // ... å‘é€æŒ‰é’®é€»è¾‘ä¿æŒä¸å˜ ...
            $('#btn-sim-send').click(function () {
                const val = $('#sim-input').val().trim();
                if (!val) return;
                $('#sim-input').val('');
                callDeepSeek('SIMULATION', val, '#btn-sim-send');
            });

            $('#sim-input').keypress(function (e) { if (e.which == 13) $('#btn-sim-send').click(); });

            $('#simModal').on('hidden.bs.modal', function () {
                $('#sim-setup').show();
                $('#sim-interface').hide();
            });

            // ----------------------------------------
            // æ ¸å¿ƒä¿®å¤ï¼šReset System (é‡ç½®å½“å‰æ¨¡å¼)
            // ----------------------------------------
            $('#btn-reset-data').click(function () {
                const modeName = currentMode === 'dating' ? 'æ‹çˆ±æ¨¡å¼' : 'å­¦ä¹ æ¨¡å¼';
                if (confirm(`ã€âš ï¸ SYSTEM WARNINGã€‘\n\nç¡®å®šè¦é‡ç½® [${modeName}] çš„æ•°æ®å—ï¼Ÿ\n\næ³¨æ„ï¼š\n1. ä»…é‡ç½®å½“å‰æ¨¡å¼ï¼Œå¦ä¸€æ¨¡å¼ä¸å—å½±å“\n2. æ‰€æœ‰ç­‰çº§ã€å±æ€§ã€ä»»åŠ¡å°†è¢«æ¸…ç©º\n3. æ“ä½œä¸å¯é€†ï¼`)) {
                    // ä¿®å¤ï¼šä½¿ç”¨ getStorageKey() åˆ é™¤å½“å‰æ¨¡å¼çš„å­˜æ¡£ï¼Œè€Œä¸æ˜¯åˆ é”™ key
                    localStorage.removeItem(getStorageKey());
                    // åŠ¨ç”»æ•ˆæœååˆ·æ–°
                    $('body').fadeOut(1000, function () { location.reload(); });
                }
            });

            // --- ä»¥ä¸‹æ˜¯å¸¸è§„äº¤äº’é€»è¾‘ (ä¿æŒä¸å˜) ---

            // å…¨å±€å˜é‡ï¼šå½“å‰é€‰ä¸­çš„ä»»åŠ¡ç´¢å¼•
            let selectedQuestIndex = -1;

            $('#report-input').on('input', function () {
                const val = $(this).val();
                const match = val.match(/ã€å›å¤ä»»åŠ¡(ID\d+)ã€‘/);
                if (match) {
                    const extractedId = match[1];
                    const targetCard = $(`.quest-card[data-quest-id="${extractedId}"]`);
                    if (targetCard.length > 0) {
                        $('.quest-card').removeClass('active');
                        targetCard.addClass('active');
                        selectedQuestIndex = targetCard.data('index');
                    } else {
                        $('.quest-card').removeClass('active');
                        selectedQuestIndex = -1;
                    }
                } else {
                    $('.quest-card').removeClass('active');
                    selectedQuestIndex = -1;
                }
            });


            // ==========================================
            // ğŸ’¾ è·¨è®¾å¤‡å­˜æ¡£åŒæ­¥ç³»ç»Ÿ (JSONæ–‡ä»¶ç‰ˆ)
            // ==========================================

            // --- 1. å¯¼å‡ºå­˜æ¡£ (BACKUP) ---
            $('#btn-export-data').click(function () {
                // æ‰“åŒ…æ‰€æœ‰é‡è¦æ•°æ®
                const backupData = {
                    version: "3.7",
                    timestamp: new Date().toLocaleString(),
                    // æ ¸å¿ƒæ•°æ®
                    dating: localStorage.getItem('solo_save_dating'),
                    learning: localStorage.getItem('solo_save_learning'),
                    // åå¥½è®¾ç½®
                    currentMode: localStorage.getItem('solo_current_mode'),
                    voice: localStorage.getItem('solo_selected_voice')
                };

                // è½¬æ¢ä¸ºæ–‡æœ¬
                const jsonStr = JSON.stringify(backupData, null, 2);

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([jsonStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');

                // æ–‡ä»¶åå¸¦ä¸Šæ—¥æœŸï¼Œæ–¹ä¾¿åŒºåˆ†
                const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, "");
                a.href = url;
                a.download = `SOLO_SAVE_${dateStr}.json`;

                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // è§†è§‰åé¦ˆ
                alert("âœ… å­˜æ¡£å·²ç”Ÿæˆï¼\nè¯·å°†æ­¤ .json æ–‡ä»¶å‘é€åˆ°ä½ çš„æ‰‹æœº/å¹³æ¿/ç”µè„‘ï¼Œ\nç„¶ååœ¨å¦ä¸€ç«¯ç‚¹å‡» [LOAD] å³å¯åŒæ­¥è¿›åº¦ã€‚");
            });

            // --- 2. å¯¼å…¥å­˜æ¡£ (LOAD) ---
            // ç‚¹å‡»æŒ‰é’®è§¦å‘æ–‡ä»¶é€‰æ‹©
            $('#btn-import-data').click(function () {
                $('#file-import-input').click();
            });

            // æ–‡ä»¶é€‰æ‹©åçš„å¤„ç†é€»è¾‘
            $('#file-import-input').change(function (e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (event) {
                    try {
                        const data = JSON.parse(event.target.result);

                        // ç®€å•çš„æ ¼å¼æ ¡éªŒ
                        if (!data.dating && !data.learning) {
                            throw new Error("å­˜æ¡£æ ¼å¼é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ ¸å¿ƒæ•°æ®");
                        }

                        if (confirm(`æ£€æµ‹åˆ°å­˜æ¡£æ–‡ä»¶ï¼š\nğŸ“… æ—¶é—´: ${data.timestamp}\n\næ˜¯å¦è¦†ç›–å½“å‰è®¾å¤‡çš„æ‰€æœ‰è¿›åº¦ï¼Ÿ\n(æ­¤æ“ä½œä¸å¯æ’¤é”€)`)) {
                            // æ¢å¤æ•°æ®
                            if (data.dating) localStorage.setItem('solo_save_dating', data.dating);
                            if (data.learning) localStorage.setItem('solo_save_learning', data.learning);
                            if (data.currentMode) localStorage.setItem('solo_current_mode', data.currentMode);
                            if (data.voice) localStorage.setItem('solo_selected_voice', data.voice);

                            alert("ğŸ‰ åŒæ­¥æˆåŠŸï¼ç³»ç»Ÿå°†é‡æ–°åŠ è½½...");
                            location.reload();
                        }
                    } catch (err) {
                        alert("âŒ è¯»å–å¤±è´¥ï¼šæ–‡ä»¶æŸåæˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚\n" + err.message);
                    }
                };
                reader.readAsText(file);

                // æ¸…ç©º inputï¼Œé˜²æ­¢æ— æ³•é‡å¤å¯¼å…¥åŒä¸€ä¸ªæ–‡ä»¶
                $(this).val('');
            });
            $(document).on('click', '.quest-card', function (e) {
                if ($(e.target).closest('button').length) return; // å¿½ç•¥æŒ‰é’®ç‚¹å‡»

                const index = $(this).data('index');
                const questId = $(this).data('quest-id');
                const questStatus = $(this).find('span.small.fw-bold').text().trim();
                if (!questStatus.includes("IN PROGRESS")) return;

                // æ£€æŸ¥æ˜¯å¦å·²ç»é€‰ä¸­ (åé€‰é€»è¾‘)
                if ($(this).hasClass('active')) {
                    // [å–æ¶ˆé€‰ä¸­]
                    $(this).removeClass('active');
                    selectedQuestIndex = -1;

                    // ä»è¾“å…¥æ¡†ç§»é™¤æ ‡ç­¾
                    const currentVal = $('#report-input').val();
                    // æ­£åˆ™ï¼šåŒ¹é… ã€å›å¤ä»»åŠ¡IDxxã€‘ä»¥åŠå®ƒåé¢å¯èƒ½ç´§è·Ÿçš„ä¸€ä¸ªæ¢è¡Œç¬¦
                    // è¿™é‡Œçš„ questId æ˜¯ "ID01" æ ¼å¼
                    const tag = `ã€å›å¤ä»»åŠ¡${questId}ã€‘`;
                    const regex = new RegExp(tag + "\\n?", "g");

                    $('#report-input').val(currentVal.replace(regex, ""));

                } else {
                    // [é€‰ä¸­æ–°ä»»åŠ¡]
                    $('.quest-card').removeClass('active');
                    $(this).addClass('active');
                    selectedQuestIndex = index;

                    const currentVal = $('#report-input').val();
                    const newTag = `ã€å›å¤ä»»åŠ¡${questId}ã€‘\n`;

                    // å¦‚æœè¾“å…¥æ¡†é‡Œå·²ç»æœ‰åˆ«çš„ä»»åŠ¡æ ‡ç­¾ï¼Œæ›¿æ¢æ‰ï¼›å¦‚æœæ²¡æœ‰ï¼ŒåŠ åœ¨å‰é¢
                    if (/ã€å›å¤ä»»åŠ¡ID\d+ã€‘/.test(currentVal)) {
                        const newVal = currentVal.replace(/ã€å›å¤ä»»åŠ¡ID\d+ã€‘\s*/, newTag);
                        $('#report-input').val(newVal);
                    } else {
                        $('#report-input').val(newTag + currentVal);
                    }
                    $('#report-input').focus();
                }
            });
            $('#btn-report').click(function () {
                const input = $('#report-input').val().trim();
                if (!input) { alert("æŒ‡ä»¤ä¸ºç©ºï¼è¯·è¾“å…¥å†…å®¹ã€‚"); return; }
                // --- ä¿®æ”¹ï¼šæ”¾å®½é™åˆ¶ï¼Œå…è®¸æ‹çˆ±æ¨¡å¼è‡ªç”±å¤ç›˜ ---
                if (selectedQuestIndex === -1) {
                    // åªæœ‰åœ¨ã€å­¦ä¹ æ¨¡å¼ã€‘ä¸‹ï¼Œæ‰å¼ºåˆ¶è¦æ±‚å¿…é¡»é€‰ä»»åŠ¡ (å› ä¸ºå­¦ä¹ æ¨¡å¼éœ€è¦ç»“ç®—å…·ä½“ä»»åŠ¡çš„å¥–åŠ±)
                    if (currentMode !== 'dating') {
                        alert("âš ï¸ [å­¦ä¹ æ¨¡å¼] æœªæ£€æµ‹åˆ°ä»»åŠ¡å…³è”ï¼\nè¯·å…ˆç‚¹å‡»å³ä¾§ä»»åŠ¡å¡ç‰‡ï¼Œå†æäº¤éªŒæ”¶ã€‚");
                        $('#quest-list').fadeOut(100).fadeIn(100).fadeOut(100).fadeIn(100);
                        return;
                    }
                    // å¦‚æœæ˜¯ã€æ‹çˆ±æ¨¡å¼ã€‘ä¸”æ²¡é€‰ä»»åŠ¡ï¼Œä»£ç å°†ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œè¿›å…¥â€œè‡ªç”±å¤ç›˜â€æµç¨‹
                }
                $(this).data('selected-quest-index', selectedQuestIndex);
                callDeepSeek("REPORT", "ç©å®¶æäº¤æ—¥å¿—: " + input, "#btn-report");
                $('#report-input').val('');
                $('.quest-card').removeClass('active');
                selectedQuestIndex = -1;
            });

            $('#btn-request').click(function () {
                const preference = $('#request-input').val().trim();
                let difficulty = $('#difficulty-select').val();

                let contentToSend = "ç©å®¶è¯·æ±‚åˆ†é…æ–°ä»»åŠ¡ã€‚";

                // --- æ ¸å¿ƒä¿®æ”¹ï¼šå‰ç«¯æ¥ç®¡éšæœºé€»è¾‘ ---
                if (difficulty === "RANDOM") {
                    // 1. å®šä¹‰ä¸åŒç­‰çº§çš„å‡ºç°æ¦‚ç‡ (æƒé‡)
                    // æ¯”å¦‚ï¼šEçº§ 30%, Dçº§ 40%, Cçº§ 20%, Bçº§ 10%
                    const weightedRanks = [
                        "E-RANK", "E-RANK", "E-RANK",           // 3ä¸ª E
                        "D-RANK", "D-RANK", "D-RANK", "D-RANK", // 4ä¸ª D
                        "C-RANK", "C-RANK",                     // 2ä¸ª C
                        "B-RANK"                                // 1ä¸ª B
                    ];

                    // å¦‚æœç©å®¶ç­‰çº§å¾ˆé«˜ (æ¯”å¦‚ > LV.5)ï¼Œå¯ä»¥åŠ å…¥ A å’Œ S
                    const currentLv = Math.floor((loadState().exp || 0) / 100) + 1;
                    if (currentLv >= 5) {
                        weightedRanks.push("A-RANK", "S-RANK");
                    }

                    // 2. éšæœºæŠ½å–ä¸€ä¸ª
                    difficulty = weightedRanks[Math.floor(Math.random() * weightedRanks.length)];

                    // 3. å‘Šè¯‰ AI è¿™æ˜¯ç³»ç»ŸæŒ‡å®šçš„éšæœºç»“æœ
                    contentToSend += `\nã€ç³»ç»Ÿéšæœºåˆ¤å®šéš¾åº¦ã€‘: ${difficulty} (è¯·åŠ¡å¿…ç”ŸæˆåŒ¹é…æ­¤ç­‰çº§éš¾åº¦çš„ä»»åŠ¡)ã€‚`;
                } else {
                    // å¦‚æœç©å®¶æ‰‹åŠ¨é€‰äº†éš¾åº¦ï¼Œå°±ç”¨å¼ºåˆ¶éš¾åº¦
                    contentToSend += `\nã€å¼ºåˆ¶éš¾åº¦ã€‘: ${difficulty}ã€‚`;
                }

                if (preference) contentToSend += `\nã€å€¾å‘ã€‘: "${preference}"ã€‚`;
                // ğŸ”¥ğŸ”¥ğŸ”¥ æ–°å¢ï¼šéšæœºæ‰°åŠ¨å› å­ (é™ä½é‡å¤ç‡çš„æ ¸å¿ƒ) ğŸ”¥ğŸ”¥ğŸ”¥
                const chaosSeeds = [
                    "è¯·ä¾§é‡äºå®æˆ˜æ¼”ç»ƒã€‚", "è¯·ä¾§é‡äºç†è®ºå¤ä¹ ã€‚", "è¯·å°è¯•ä¸€ä¸ªéå¸¸è§„çš„åˆ‡å…¥ç‚¹ã€‚",
                    "ä»»åŠ¡å½¢å¼è¦æ–°é¢–ã€‚", "è¯·ç»“åˆä¸¤ä¸ªä¸åŒçš„æŠ€èƒ½ç‚¹ã€‚", "æ¨¡æ‹Ÿä¸€æ¬¡çªå‘çŠ¶å†µã€‚",
                    "è¯·è®¾å®šä¸€ä¸ªè‹›åˆ»çš„é™åˆ¶æ¡ä»¶ã€‚", "é‡ç‚¹è€ƒå¯ŸåŸºç¡€æ˜¯å¦ç‰¢å›ºã€‚"
                ];
                const randomSeed = chaosSeeds[Math.floor(Math.random() * chaosSeeds.length)];

                // æŠŠéšæœºç§å­åŠ åˆ°å‘ç»™ AI çš„å†…å®¹é‡Œï¼Œå¼ºåˆ¶å®ƒæ”¹å˜æ€è·¯
                contentToSend += `\nã€éšæœºå˜æ•°ã€‘: ${randomSeed}`;
                // ä¸ºäº†è®©ç”¨æˆ·çŸ¥é“éšåˆ°äº†ä»€ä¹ˆï¼Œå¯ä»¥çŸ­æš‚æ”¹ä¸€ä¸‹æŒ‰é’®æ–‡å­—(å¯é€‰)
                const originalText = $(this).html();
                // callDeepSeek ä¼šå¤„ç† loading åŠ¨ç”»ï¼Œæ‰€ä»¥è¿™é‡Œä¸ç”¨å¤ªæ‹…å¿ƒ

                callDeepSeek("REQUEST", contentToSend, "#btn-request");
            });

            $('#btn-add-skill').click(function () {
                const input = $('#new-skill-input').val().trim();
                if (!input) return;
                $('#new-skill-input').val('');
                callDeepSeek("ADD_SKILL", `ç©å®¶å¸Œæœ›æ–°å¢èŒä¸šæ–¹å‘ï¼šã€${input}ã€‘ã€‚è¯·æç‚¼ä¸»é¢˜å¹¶ç”Ÿæˆå­æŠ€èƒ½æ ‘ã€‚`, "#btn-add-skill");
            });

            $(document).on('click', '.btn-delete-group', function () {
                const groupIndex = $(this).data('group-index');
                const currentState = loadState();
                if (confirm(`åˆ é™¤ä¸»é¢˜?`)) {
                    currentState.skills.splice(groupIndex, 1);
                    saveState(currentState); renderUI(currentState);
                }
            });

            $(document).on('click', '.btn-delete-skill', function () {
                const groupIndex = $(this).data('group-index');
                const childIndex = $(this).data('child-index');
                const currentState = loadState();
                if (childIndex === -1) {
                    if (confirm("åˆ é™¤æ­¤æŠ€èƒ½?")) { currentState.skills.splice(groupIndex, 1); saveState(currentState); renderUI(currentState); }
                } else {
                    if (confirm("ç§»é™¤å­æŠ€èƒ½?")) { currentState.skills[groupIndex].children.splice(childIndex, 1); saveState(currentState); renderUI(currentState); }
                }
            });

            $(document).on('change', '.btn-toggle-skill', function () {
                const groupIndex = $(this).data('group-index');
                const childIndex = $(this).data('child-index');
                const isChecked = $(this).is(':checked');
                const currentState = loadState();
                if (childIndex === -1) currentState.skills[groupIndex].enabled = isChecked;
                else currentState.skills[groupIndex].children[childIndex].enabled = isChecked;
                saveState(currentState); renderUI(currentState);
            });
            $(document).on('change', '.btn-toggle-group', function () {
                const groupIndex = $(this).data('group-index');
                const isChecked = $(this).is(':checked');
                const currentState = loadState();
                const group = currentState.skills[groupIndex];
                if (group && group.children) {
                    group.children.forEach(child => child.enabled = isChecked);
                    saveState(currentState); renderUI(currentState);
                }
            });

            $(document).on('click', '.btn-abandon-quest', function () {
                const index = $(this).data('index');
                const currentState = loadState();
                const quest = currentState.quests[index];
                if (confirm(`æ”¾å¼ƒä»»åŠ¡?`)) callDeepSeek("ABANDON", `æ”¾å¼ƒä»»åŠ¡ï¼š${quest.content}ã€‚`, this);
            });

            $(document).on('click', '.btn-help-quest', function () {
                const index = $(this).data('index');
                const currentState = loadState();
                const quest = currentState.quests[index];
                $('#mentor-panel').show().data('viewing-index', index);
                $('html, body').animate({ scrollTop: $("#mentor-panel").offset().top - 100 }, 500);
                $('#mentor-content').html('<span class="blink-fast">Connect...</span>');
                callDeepSeek("HELP", `ä»»åŠ¡ã€${quest.content}ã€‘è¾…å¯¼è¯·æ±‚ã€‚`, this);
            });

            $(document).on('click', '.btn-view-guidance', function () {
                const index = $(this).data('index');
                const currentState = loadState();
                const quest = currentState.quests[index];
                const mentorPanel = $('#mentor-panel');
                if (mentorPanel.is(':visible') && mentorPanel.data('viewing-index') === index) mentorPanel.slideUp();
                else if (quest.guidance) {
                    mentorPanel.data('viewing-index', index).slideDown();
                    $('html, body').animate({ scrollTop: $("#mentor-panel").offset().top - 100 }, 500);
                    $('#mentor-content').html(quest.guidance).hide().fadeIn(300);
                }
            });

            // ä¸‹è½½è¾…å¯¼
            $('#btn-download-guidance').click(function () {
                let rawHtml = $('#mentor-content').html();
                if (!rawHtml || rawHtml.includes("Connect...") || rawHtml.trim() === "") return;
                let formattedText = rawHtml
                    .replace(/<br\s*\/?>/gi, '\n').replace(/<\/div>/gi, '\n').replace(/<\/p>/gi, '\n\n')
                    .replace(/<li>/gi, '\n  â€¢ ').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&nbsp;/g, ' ').replace(/<\/?[^>]+(>|$)/g, "");

                const blob = new Blob(["\uFEFF" + formattedText.trim()], { type: "text/plain;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `Mentor_Log_${new Date().getTime()}.txt`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            });

            $(document).on('click', '.btn-add-stat', function () {
                const statType = $(this).data('stat');
                const currentState = loadState();
                if (currentState.ap > 0) { currentState.stats[statType]++; currentState.ap--; saveState(currentState); renderUI(currentState); }
            });


            // éº¦å…‹é£ç‚¹å‡»
            $('#btn-mic').click(function () {
                if (!recognition) {
                    alert("âŒ é”™è¯¯ï¼šä½ çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ã€‚\nè¯·ä½¿ç”¨ Chrome æˆ– Edge æ¡Œé¢ç‰ˆï¼Œå¹¶ç¡®ä¿ä¸æ˜¯ä»¥ file:// æ–¹å¼æ‰“å¼€ã€‚");
                    return;
                }
                // æ£€æŸ¥æƒé™çŠ¶æ€
                if (navigator.permissions) {
                    navigator.permissions.query({ name: 'microphone' }).then(function (result) {
                        if (result.state == 'denied') {
                            alert("âŒ éº¦å…‹é£æƒé™å·²å…³é—­ï¼Œè¯·åœ¨æµè§ˆå™¨åœ°å€æ å·¦ä¾§ç‚¹å‡»â€œé”â€å›¾æ ‡å¼€å¯æƒé™ã€‚");
                        } else {
                            try { recognition.start(); } catch (e) { recognition.stop(); }
                        }
                    });
                } else {
                    try { recognition.start(); } catch (e) { recognition.stop(); }
                }
            });

            // è¯­éŸ³å¼€å…³ç‚¹å‡»
            $(document).on('click', '#btn-toggle-tts', function () {
                isTTSActive = !isTTSActive;
                const icon = isTTSActive ? 'bi-volume-up-fill' : 'bi-volume-mute-fill';
                const text = isTTSActive ? 'ON' : 'OFF';
                const btnClass = isTTSActive ? 'btn-outline-info' : 'btn-outline-secondary';

                $(this).html(`<i class="bi ${icon}"></i> <span>${text}</span>`)
                    .removeClass('btn-outline-info btn-outline-secondary')
                    .addClass(btnClass);

                if (!isTTSActive) window.speechSynthesis.cancel();

                // ç»™ä¸ªåé¦ˆ
                alert(`è¯­éŸ³æœ—è¯»å·²${isTTSActive ? 'å¼€å¯' : 'å…³é—­'}`);
            });
            // ä¸‹è½½ä»»åŠ¡å½’æ¡£
            $(document).on('click', '.btn-download-archive', function (e) {
                e.stopPropagation();
                const index = $(this).data('index');
                const currentState = loadState();
                const quest = currentState.quests[index];
                if (!quest.archive) { alert("è¯¥ä»»åŠ¡æ²¡æœ‰å½’æ¡£æ•°æ®ã€‚"); return; }

                const content = `
========================================
   SOLO LEVELING - MISSION ARCHIVE
   Mission ID: ID${String(index).padStart(2, '0')}
   Date: ${new Date().toLocaleDateString()}
========================================

[MISSION]
${quest.content}

[USER ANSWER]
${quest.user_answer || "N/A"}

----------------------------------------

[SYSTEM EVALUATION]
Score: ${quest.archive.score}

[ADVICE]
${quest.archive.advice}

[RECOMMENDED ANSWER]
${quest.archive.best_answer}

========================================`.trim();

                const blob = new Blob(["\uFEFF" + content], { type: "text/plain;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `Mission_Archive_ID${String(index).padStart(2, '0')}.txt`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            });
            // --- æ–°å¢ï¼šè‡ªå®šä¹‰ä»»åŠ¡æŒ‰é’®ç‚¹å‡»äº‹ä»¶ ---
            $('#btn-custom-quest').click(function () {
                const input = $('#custom-quest-input').val().trim();
                if (!input) { alert("è¯·è¾“å…¥è‡³å°‘ä¸€é¡¹ä»»åŠ¡ï¼"); return; }

                // æ¸…ç©ºè¾“å…¥æ¡†
                $('#custom-quest-input').val('');

                // è°ƒç”¨ AI
                callDeepSeek("CUSTOM_QUEST", `ç©å®¶æ‰‹åŠ¨æ·»åŠ äº†å¾…åŠæ¸…å•ï¼Œè¯·å°†å…¶å®ä½“åŒ–ä¸ºä»»åŠ¡å¡ç‰‡ï¼š\n${input}`, "#btn-custom-quest");
            });
        });
        // ==========================================
        // ğŸ•’ 3.0ç‰ˆï¼šç©ºé—²å±ä¿ç³»ç»Ÿ (Three.js 3D Clock)
        // ==========================================

        // é…ç½®ï¼šç©ºé—²æ—¶é—´ (æ¯«ç§’)
        // const IDLE_TIMEOUT = 5000; // Debugç”¨ï¼š5ç§’
        const IDLE_TIMEOUT = 3 * 60 * 1000; // æ­£å¼ç”¨ï¼š3åˆ†é’Ÿ

        let idleTimer;
        let isIdle = false;
        let clockScene, clockCamera, clockRenderer, clockMesh, fontLoader, loadedFont;
        let clockGroup; // ç”¨äºæ—‹è½¬æ•´ä¸ªæ—¶é’Ÿ

        // --- A. åˆå§‹åŒ–å±ä¿ Three.js ç¯å¢ƒ ---
        function initScreensaver3D() {
            const container = document.getElementById('screensaver-layer');

            // 1. åœºæ™¯
            clockScene = new THREE.Scene();

            // 2. ç›¸æœº
            clockCamera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            clockCamera.position.z = 50;

            // 3. æ¸²æŸ“å™¨ (é€æ˜èƒŒæ™¯)
            clockRenderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            clockRenderer.setSize(window.innerWidth, window.innerHeight);
            clockRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(clockRenderer.domElement);

            // 4. ç¯å…‰ (è¥é€ ç§‘æŠ€æ„Ÿ)
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            clockScene.add(ambientLight);

            const pointLight = new THREE.PointLight(0x00f3ff, 2, 100);
            pointLight.position.set(10, 10, 20);
            clockScene.add(pointLight);

            clockGroup = new THREE.Group();
            clockScene.add(clockGroup);

            // 5. åŠ è½½å­—ä½“ (ä½¿ç”¨ Three.js å®˜æ–¹ç¤ºä¾‹çš„å­—ä½“)
            // æ³¨æ„ï¼šéœ€è¦å¼•å…¥ FontLoader å’Œ TextGeometryã€‚
            // ç”±äºä½ æ˜¯å•æ–‡ä»¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ ES Module çš„ CDN æ–¹å¼åŠ¨æ€å¼•å…¥æœ‰ç‚¹éº»çƒ¦ï¼Œ
            // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨æ—§ç‰ˆ Three.js çš„å…¨å±€å˜é‡æ–¹å¼ (å‡è®¾ä½ å¼•å…¥çš„æ˜¯ r128 ä¹Ÿå°±æ˜¯ä½ ä»£ç é‡Œçš„ç‰ˆæœ¬)
            // ä½† r128 çš„æ ¸å¿ƒåº“ä¸åŒ…å« FontLoaderï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ¨¡æ‹Ÿæˆ–è€…åŠ è½½ã€‚

            // ä¸ºäº†æœ€ç®€å•çš„å…¼å®¹æ€§ï¼Œæˆ‘ä»¬ä½¿ç”¨ Three.js æä¾›çš„ FontLoader è·¯å¾„
            // å¦‚æœä½ çš„ script å¼•å…¥çš„æ˜¯ three.min.jsï¼Œä½ éœ€è¦é¢å¤–å¼•å…¥ FontLoaderã€‚
            // é‰´äºå•æ–‡ä»¶é™åˆ¶ï¼Œæˆ‘ä»¬è¿™é‡Œç”¨ä¸€ä¸ªå·§å¦™çš„æ–¹æ³•ï¼šä½¿ç”¨ CanvasTexture è´´å›¾æ³•ï¼
            // è¿™ç§æ–¹æ³•ä¸éœ€è¦åŠ è½½å¤–éƒ¨å­—ä½“æ–‡ä»¶ï¼Œé€Ÿåº¦æå¿«ä¸”ä¸è·¨åŸŸã€‚

            animateClock();
        }

        // --- B. åˆ›å»º Canvas çº¹ç†æ—¶é’Ÿ (æ›¿ä»£ TextGeometry ä»¥é¿å…åŠ è½½å­—ä½“æ–‡ä»¶å¤±è´¥) ---
        // --- B. åˆ›å»ºé«˜é¢œå€¼æ’ç‰ˆçº¹ç† (æ—¶é—´ + æ—¥æœŸ) ---
        function createTextTexture(timeStr) {
            // è·å–å½“å‰æ—¥æœŸä¿¡æ¯
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'short',
                day: 'numeric'
            }).toUpperCase(); // ä¾‹å¦‚: SATURDAY, DEC 13

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // è®¾ç½®é«˜æ¸…ç”»å¸ƒ
            canvas.width = 4096;
            canvas.height = 2048; // åŠ é«˜ç”»å¸ƒä»¥å®¹çº³ä¸¤è¡Œæ–‡å­—

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // --- 1. ç»˜åˆ¶æ—¶é—´ (ä¸»è§†è§‰) ---
            // å­—ä½“åŠ ç²—ï¼Œå­—å·å·¨å¤§
            ctx.font = 'bold 700px "Orbitron", "Courier New", monospace';
            ctx.fillStyle = '#00f3ff';

            // å‘å…‰æ•ˆæœ
            ctx.shadowColor = 'rgba(0, 243, 255, 0.8)';
            ctx.shadowBlur = 60;

            // ç»˜åˆ¶åœ¨ç”»å¸ƒåä¸Šæ–¹
            ctx.fillText(timeStr, canvas.width / 2, canvas.height * 0.45);

            // --- 2. ç»˜åˆ¶æ—¥æœŸ (å‰¯æ ‡) ---
            // å­—ä½“ç¨ç»†ï¼Œå­—å·è¾ƒå°ï¼Œæ‹‰å¼€é—´è·
            ctx.font = '300px "Orbitron", monospace';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)'; // åŠé€æ˜ç™½è‰²ï¼Œæ‹‰å¼€å±‚æ¬¡
            ctx.shadowBlur = 30; // å‘å…‰å¼±ä¸€ç‚¹

            // ç»˜åˆ¶åœ¨æ—¶é—´ä¸‹æ–¹
            ctx.fillText(dateStr, canvas.width / 2, canvas.height * 0.75);

            // --- 3. ç»˜åˆ¶è£…é¥°çº¿ (ç§‘æŠ€æ„Ÿ) ---
            ctx.lineWidth = 10;
            ctx.strokeStyle = 'rgba(0, 243, 255, 0.3)';
            ctx.beginPath();
            // åœ¨æ—¥æœŸä¸‹æ–¹ç”»ä¸€æ¡ç»†çº¿
            ctx.moveTo(canvas.width * 0.3, canvas.height * 0.88);
            ctx.lineTo(canvas.width * 0.7, canvas.height * 0.88);
            ctx.stroke();

            const texture = new THREE.CanvasTexture(canvas);
            texture.minFilter = THREE.LinearFilter;
            texture.magFilter = THREE.LinearFilter;

            return texture;
        }
        // --- æ–°å¢ï¼šè®¡ç®—å¹¶é€‚é…å±å¹•å®½åº¦çš„å‡½æ•° ---
        // --- ä¼˜åŒ–ç‰ˆï¼šé€‚é…æ‰‹æœºç«–å±çš„ç¼©æ”¾é€»è¾‘ ---
        function fitClockToScreen() {
            if (!clockMesh || !clockCamera) return;

            const dist = clockCamera.position.z;
            const vFOV = THREE.MathUtils.degToRad(clockCamera.fov);
            const visibleHeight = 2 * Math.tan(vFOV / 2) * dist;
            const visibleWidth = visibleHeight * clockCamera.aspect;

            // å‡ ä½•ä½“åŸºç¡€å°ºå¯¸ (30å®½, 15é«˜)
            const baseWidth = 30;
            const baseHeight = 15;

            // è®¡ç®—å®½å’Œé«˜çš„ç¼©æ”¾æ¯”ä¾‹
            // ç”µè„‘ä¸Šé€šå¸¸å®½åº¦æ˜¯ç“¶é¢ˆï¼Œæ‰‹æœºç«–å±ä¸Šé«˜åº¦å¯èƒ½æ˜¯ç“¶é¢ˆ
            // æˆ‘ä»¬å¸Œæœ›æ—¶é’Ÿå æ®å±å¹•å®½åº¦çš„ 90%ï¼Œæˆ–è€…å±å¹•é«˜åº¦çš„ 50% (é¿å…ç«–å±æ—¶å­—å¤ªæ»¡)

            const scaleX = (visibleWidth * 0.9) / baseWidth;

            // æ‰‹æœºç«–å±ç‰¹æ®Šé€»è¾‘ï¼šå¦‚æœå±å¹•å¾ˆç˜¦ (aspect < 1)ï¼Œåˆ™è®©å®ƒç¨å¾®å°ä¸€ç‚¹ï¼Œç•™å‡ºå‘¼å¸æ„Ÿ
            let scaleFactor = scaleX;
            if (clockCamera.aspect < 1) {
                // ç«–å±æ¨¡å¼ï¼šç¨å¾®ç¼©å°ä¸€ç‚¹ï¼Œé˜²æ­¢è¾¹ç¼˜è´´å¤ªæ­»
                scaleFactor = scaleX * 0.8;
            }

            clockMesh.scale.set(scaleFactor, scaleFactor, 1);
        }

        function updateClock3D() {
            if (!isIdle) return; // åªæœ‰ç©ºé—²æ—¶æ‰æ›´æ–°

            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-GB', { hour12: false }); // 24å°æ—¶åˆ¶ HH:mm:ss

            // å¦‚æœå·²ç»æœ‰ Meshï¼Œå…ˆæ¸…ç†
            if (clockMesh) {
                clockGroup.remove(clockMesh);
                clockMesh.geometry.dispose();
                clockMesh.material.dispose();
            }

            // åˆ›å»ºå¹³é¢å‡ ä½•ä½“
            // ç”»å¸ƒæ˜¯ 4096 x 2048 (2:1)ï¼Œæ‰€ä»¥å‡ ä½•ä½“ä¹Ÿè¦æ˜¯ 2:1ï¼Œå¦åˆ™å­—ä¼šæ‰
            const geometry = new THREE.PlaneGeometry(30, 15);
            const texture = createTextTexture(timeStr);
            const material = new THREE.MeshBasicMaterial({
                map: texture,
                transparent: true,
                side: THREE.DoubleSide,
                blending: THREE.AdditiveBlending // å‘å…‰å åŠ æ¨¡å¼
            });

            clockMesh = new THREE.Mesh(geometry, material);
            clockGroup.add(clockMesh);
            // ğŸ”¥ğŸ”¥ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šæ¯æ¬¡æ›´æ–°å®Œæ¨¡å‹åï¼Œç«‹å³æ‰§è¡Œè‡ªé€‚åº”ç¼©æ”¾ ğŸ”¥ğŸ”¥ğŸ”¥
            fitClockToScreen();
        }

        function animateClock() {
            requestAnimationFrame(animateClock);

            if (isIdle && clockGroup) {
                const time = Date.now() * 0.001;

                // 1. å‘¼å¸æµ®åŠ¨ (ä¸Šä¸‹ç¼“æ…¢ç§»åŠ¨)
                clockGroup.position.y = Math.sin(time * 0.5) * 0.5;

                // 2. æå¾®å°çš„å¤šè½´æ—‹è½¬ (å¢åŠ ç«‹ä½“æ„Ÿï¼Œä½†ä¸è¦æ™•)
                clockGroup.rotation.x = Math.sin(time * 0.3) * 0.05;
                clockGroup.rotation.y = Math.cos(time * 0.2) * 0.05;

                // æ¸²æŸ“
                if (clockRenderer && clockScene && clockCamera) {
                    clockRenderer.render(clockScene, clockCamera);
                }
            }
        }
        let idleTargetTime = Date.now() + IDLE_TIMEOUT; // è®°å½•ç›®æ ‡æ—¶é—´

        function resetIdleTimer() {
            // 1. å¦‚æœå½“å‰æ˜¯ç©ºé—²çŠ¶æ€ï¼Œå”¤é†’å®ƒ
            if (isIdle) {
                isIdle = false;
                document.body.classList.remove('is-idle');

                // ã€ä¿®å¤ã€‘æ¸…é™¤å†…è”æ ·å¼ï¼Œè®© CSS ç±»é‡æ–°æ¥ç®¡é€æ˜åº¦æ§åˆ¶
                $('#screensaver-layer').css('opacity', '');

                console.log("âš¡ SYSTEM AWAKE");
            }

            // 2. é‡ç½®ç›®æ ‡æ—¶é—´
            idleTargetTime = Date.now() + IDLE_TIMEOUT;

            // 3. è§†è§‰åé¦ˆ
            $('#idle-countdown').removeClass('text-danger').addClass('text-secondary');
        }

        // 2. é‡ç½®ç›®æ ‡æ—¶é—´ (æ ¸å¿ƒä¿®æ”¹ï¼šä¸å†ä¾èµ– setTimeoutï¼Œè€Œæ˜¯æ¨è¿Ÿç›®æ ‡æ—¶é—´ç‚¹)
        idleTargetTime = Date.now() + IDLE_TIMEOUT;

        // 3. è§†è§‰åé¦ˆï¼šé‡ç½®æ—¶é¢œè‰²å˜äº®ä¸€ä¸‹ï¼Œæç¤ºç”¨æˆ·â€œæ—¶é—´é‡ç½®äº†â€
        $('#idle-countdown').removeClass('text-danger').addClass('text-secondary');

        function goIdle() {
            if (isIdle) return; // é˜²æ­¢é‡å¤è§¦å‘
            isIdle = true;
            document.body.classList.add('is-idle');
            console.log("ğŸ’¤ SYSTEM IDLE - SCREENSAVER ACTIVE");

            // ç«‹å³åˆ·æ–°ä¸€æ¬¡ 3D æ—¶é’Ÿ
            updateClock3D();
        }

        // --- æ ¸å¿ƒè®¡æ—¶å™¨ (åˆå¹¶äº†æ—¶é’Ÿæ›´æ–° + å€’è®¡æ—¶æ£€æµ‹) ---
        setInterval(() => {
            // 1. æ›´æ–°å³ä¸Šè§’å¤§æ—¶é’Ÿ
            $('#clock').text(new Date().toLocaleTimeString());

            // 2. è®¡ç®—å€’è®¡æ—¶
            if (!isIdle) {
                const remaining = idleTargetTime - Date.now();

                if (remaining <= 0) {
                    // æ—¶é—´åˆ°ï¼Œè¿›å±ä¿
                    $('#idle-countdown').text("[SLEEPING]");
                    goIdle();
                    // åœ¨å±ä¿çŠ¶æ€ä¸‹ç»§ç»­æ›´æ–° 3D æ—¶é’Ÿ
                    updateClock3D();
                } else {
                    // æ ¼å¼åŒ–å‰©ä½™æ—¶é—´ mm:ss
                    const minutes = Math.floor(remaining / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    const timeStr =
                        String(minutes).padStart(2, '0') + ":" +
                        String(seconds).padStart(2, '0');

                    $('#idle-countdown').text(`[SLEEP: ${timeStr}]`);

                    // å‰©ä¸‹ 10 ç§’æ—¶å˜çº¢é¢„è­¦
                    if (remaining < 10000) {
                        $('#idle-countdown').removeClass('text-secondary').addClass('text-danger blink-fast');
                    }
                }
            } else {
                // å·²ç»æ˜¯å±ä¿çŠ¶æ€äº†ï¼ŒæŒç»­æ›´æ–° 3D æ—¶é’Ÿ
                updateClock3D();
            }
        }, 1000);

        // --- D. å¯åŠ¨ç›‘å¬ ---
        $(document).ready(function () {
            // åˆå§‹åŒ– 3D ç¯å¢ƒ
            initScreensaver3D();

            // ç›‘å¬æ‰€æœ‰ç”¨æˆ·æ“ä½œ
            const events = ['mousemove', 'mousedown', 'keypress', 'touchstart', 'scroll'];
            events.forEach(event => {
                document.addEventListener(event, resetIdleTimer, true);
            });

            // åˆå§‹åŒ–å®šæ—¶å™¨
            resetIdleTimer();

            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', () => {
                if (clockCamera && clockRenderer) {
                    clockCamera.aspect = window.innerWidth / window.innerHeight;
                    clockCamera.updateProjectionMatrix();
                    clockRenderer.setSize(window.innerWidth, window.innerHeight);

                    // ğŸ”¥ğŸ”¥ğŸ”¥ æ–°å¢ï¼šçª—å£å˜åŒ–æ—¶ï¼Œé‡æ–°è®¡ç®—æ—¶é’Ÿå¤§å°
                    if (isIdle) {
                        fitClockToScreen();
                    }
                }
            });
        }
        );
        // ==========================================
        // â° å…¨å±€ä»»åŠ¡å€’è®¡æ—¶ç³»ç»Ÿ
        // ==========================================
        setInterval(() => {
            const now = Date.now();
            let needSave = false;

            // 1. éå†ç•Œé¢ä¸Šæ‰€æœ‰çš„å€’è®¡æ—¶æ ‡ç­¾
            $('.live-timer').each(function () {
                const $el = $(this);
                const deadline = parseInt($el.data('deadline'));

                if (!deadline) return; // å¦‚æœæ²¡æœ‰æˆªæ­¢æ—¶é—´åˆ™è·³è¿‡

                const remaining = deadline - now;
                const $text = $el.find('.timer-text');

                // 2. æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
                if (remaining > 0) {
                    $text.text(formatCountDown(remaining));

                    // å‰©ä¸‹ä¸åˆ° 5 åˆ†é’Ÿæ—¶å˜çº¢ + é—ªçƒ
                    if (remaining < 5 * 60 * 1000) {
                        $el.removeClass('text-info').addClass('text-danger blink-slow');
                    }
                }
                // 3. â³ è¶…æ—¶å¤„ç† (è‡ªåŠ¨å¤±è´¥)
                else {
                    $text.text("00:00:00");

                    // æ‰¾åˆ°è¿™ä¸ªä»»åŠ¡åœ¨ gameState é‡Œçš„ç´¢å¼•
                    // æ³¨æ„ï¼šä½ éœ€è¦ç¡®ä¿ .quest-card ä¸Šæœ‰ data-index å±æ€§ (ä½ ç°æœ‰çš„ä»£ç é‡Œæœ‰)
                    const $card = $el.closest('.quest-card');
                    const index = $card.data('index');

                    // è¯»å–æœ€æ–°çŠ¶æ€
                    const currentState = loadState();
                    const quest = currentState.quests[index];

                    // åŒé‡æ£€æŸ¥ï¼šå¿…é¡»æ˜¯ IN PROGRESS çŠ¶æ€æ‰åˆ¤è´Ÿ
                    if (quest && quest.status === 'IN PROGRESS') {
                        quest.status = 'FAILED';
                        quest.outcome = "TIMEOUT (ä»»åŠ¡è¶…æ—¶)";

                        // æ‰£é™¤ä¸€ç‚¹ç‚¹æƒ©ç½š (å¯é€‰)
                        quest.content += "<br><span class='text-danger'>[ç³»ç»Ÿ]: è¶…è¿‡æ—¶é™ï¼Œä»»åŠ¡å¼ºåˆ¶å¤±è´¥ã€‚</span>";

                        // æ ‡è®°éœ€è¦ä¿å­˜
                        saveState(currentState);
                        needSave = true;

                        // è§†è§‰åé¦ˆï¼šæŠŠå¡ç‰‡å˜çº¢ (ä¸ç”¨é‡æ–°æ¸²æŸ“æ•´ä¸ªUIï¼Œä½“éªŒæ›´å¥½)
                        $card.css('border-left-color', '#ff2a6d');
                        $card.find('.text-warning').removeClass('text-warning').addClass('text-danger').html('<i class="bi bi-x-octagon"></i> FAILED');
                        $el.remove(); // ç§»é™¤å€’è®¡æ—¶
                    }
                }
            });

            // å¦‚æœæœ‰ä»»åŠ¡çŠ¶æ€æ”¹å˜äº†ï¼Œé‡æ–°æ¸²æŸ“æ•´ä¸ª UI ä»¥ç¡®ä¿ä¸€è‡´æ€§
            if (needSave) {
                const newState = loadState();
                renderUI(newState);
                // æ’­æ”¾ä¸€ä¸ªå¤±è´¥çš„éŸ³æ•ˆæˆ–è€…æç¤º (å¯é€‰)
                speakAI("ä»»åŠ¡è¶…æ—¶å¤±è´¥ã€‚Mission Failed.");
            }

        }, 1000); // æ¯ç§’è¿è¡Œä¸€æ¬¡
    </script>
</body>

</html>